<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Koda.AI - Enhanced Chatbot</title>
    <style>
        /* --- STILE CSS ISPIRATO A SPOTIFY (Completo e Funzionante) --- */
        :root {
            --spotify-bg: #121212;
            --spotify-bg-light: #181818;
            --spotify-card: #282828;
            --spotify-text: #ffffff;
            --spotify-text-secondary: #b3b3b3;
            --spotify-accent: #1db954;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --bottom-nav-height: 70px;
        }
        
        /* NUOVO: Stili per la modalit√† Giorno (Light Mode) */
        body.light-mode {
            --spotify-bg: #ffffff;
            --spotify-bg-light: #f5f5f5;
            --spotify-card: #e9e9e9;
            --spotify-text: #121212;
            --spotify-text-secondary: #535353;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            font-family: var(--font-family);
            background-color: var(--spotify-bg);
            color: var(--spotify-text);
            height: 100%;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Stili per la schermata di autenticazione */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--spotify-bg); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.5s, visibility 0.5s; padding: 20px;
        }
        #auth-overlay.hidden { opacity: 0; visibility: hidden; }
        .auth-logo { width: 80px; height: 80px; margin-bottom: 24px; fill: var(--spotify-accent); }
        .auth-card { background: var(--spotify-card); padding: 32px 24px; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; position: relative; }
        .auth-close-btn { position: absolute; top: 8px; left: 12px; background: none; border: none; color: var(--spotify-text-secondary); font-size: 28px; cursor: pointer; line-height: 1; }
        .auth-card h2 { font-size: 24px; margin-bottom: 24px; }
        .auth-card .input-group { margin-bottom: 16px; text-align: left; }
        .auth-card label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px; }
        .auth-card input { width: 100%; padding: 14px 16px; font-size: 16px; background-color: var(--spotify-bg-light); border: 1px solid rgba(128,128,128,0.2); border-radius: 8px; color: var(--spotify-text); }
        .auth-card input::placeholder { color: #888; }
        .auth-card .button { width: 100%; margin-top: 16px; }
        .auth-links { margin-top: 24px; }
        .auth-switch-link, .forgot-password-link { color: var(--spotify-text-secondary); text-decoration: none; cursor: pointer; font-size: 14px; transition: color 0.2s; }
        .auth-switch-link:hover, .forgot-password-link:hover { color: var(--spotify-text); text-decoration: underline; }
        .forgot-password-link { display: block; margin-top: 12px; }
        .auth-card.hidden { display: none; }
        
        #app-container { height: 100vh; display: flex; flex-direction: column; }
        #main-content { flex: 1; overflow-y: auto; padding-bottom: var(--bottom-nav-height); }
        .top-bar { 
            padding: 16px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            position: sticky; 
            top: 0; 
            background: linear-gradient(to bottom, var(--spotify-bg) 70%, transparent); 
            z-index: 10; 
            width: 100%;
        }
        .page-title { 
            font-size: 22px; 
            font-weight: 700; 
            flex-grow: 1; 
            color: var(--spotify-text);
            margin: 0;
        }
        #global-controls { 
            margin-left: auto; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-shrink: 0;
        }
        .global-btn { 
            background: none; 
            border: none; 
            color: var(--spotify-text); 
            font-size: 24px; 
            cursor: pointer; 
            padding: 4px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: color 0.2s ease;
        }
        
        .global-btn:hover {
            color: var(--spotify-accent);
        }
        #lang-toggle-btn { 
            font-size: 14px; 
            font-weight: bold; 
            background: var(--spotify-card); 
            border-radius: 50px; 
            padding: 6px 10px; 
            transition: background-color 0.2s ease;
        }
        
        #lang-toggle-btn:hover {
            background: var(--spotify-bg-light);
        }
        .user-avatar { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            background-color: var(--spotify-accent); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-weight: bold; 
            font-size: 16px; 
            cursor: pointer; 
            object-fit: cover; 
            color: black; 
            position: relative;
            transition: transform 0.2s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
        }

        /* User Profile Dropdown Menu */
        .user-profile-container {
            position: relative;
            display: inline-block;
        }

        .user-profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: var(--spotify-card);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-width: 200px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        .user-profile-dropdown.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-profile-header {
            padding: 16px;
            border-bottom: 1px solid rgba(128, 128, 128, 0.2);
            text-align: center;
        }

        .user-profile-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--spotify-accent);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            margin: 0 auto 8px;
            color: black;
        }

        .user-profile-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--spotify-text);
            margin-bottom: 4px;
        }

        .user-profile-email {
            font-size: 12px;
            color: var(--spotify-text-secondary);
        }

        .user-profile-menu {
            padding: 8px 0;
        }

        .user-profile-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--spotify-text);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .user-profile-item:hover {
            background-color: var(--spotify-bg-light);
        }

        .user-profile-item svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .user-profile-divider {
            height: 1px;
            background-color: rgba(128, 128, 128, 0.2);
            margin: 8px 0;
        }

        .user-profile-logout {
            color: #ff6b6b;
        }

        .user-profile-logout:hover {
            background-color: rgba(255, 107, 107, 0.1);
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            .user-profile-dropdown {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                margin: 0;
                border-radius: 12px 12px 0 0;
                min-width: auto;
                max-height: 80vh;
                overflow-y: auto;
            }

            .user-profile-dropdown.visible {
                transform: translateY(0);
            }

            .user-profile-header {
                padding: 20px 16px;
            }

            .user-profile-avatar {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }

            .user-profile-name {
                font-size: 18px;
            }

            .user-profile-item {
                padding: 16px;
                font-size: 16px;
            }

            .user-profile-item svg {
                width: 20px;
                height: 20px;
            }
        }

                 @media (max-width: 480px) {
             .top-bar {
                 padding: 12px 16px;
             }
             
             .page-title {
                 font-size: 18px;
             }
             
             .user-avatar {
                 width: 28px;
                 height: 28px;
                 font-size: 14px;
             }

             .user-profile-dropdown {
                 max-height: 70vh;
             }

             .user-profile-header {
                 padding: 16px;
             }

             .user-profile-avatar {
                 width: 48px;
                 height: 48px;
                 font-size: 20px;
             }

             .user-profile-item {
                 padding: 14px 16px;
                 font-size: 15px;
             }
             
             .global-btn {
                 font-size: 20px;
                 padding: 6px;
             }
             
             #lang-toggle-btn {
                 font-size: 12px;
                 padding: 4px 8px;
             }
         }


        .filters-container { padding: 8px 16px; position: sticky; top: 64px; background-color: var(--spotify-bg); z-index: 9; }
        .filter-pills { display: flex; gap: 8px; overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
        .filter-pills::-webkit-scrollbar { display: none; }
        .pill-btn { background-color: var(--spotify-card); color: var(--spotify-text); border: 1px solid rgba(128,128,128,0.2); border-radius: 50px; padding: 8px 16px; font-size: 14px; font-weight: 500; cursor: pointer; white-space: nowrap; transition: background-color 0.2s, color 0.2s; }
        .pill-btn.active { background-color: var(--spotify-text); color: var(--spotify-bg); font-weight: bold; }
        body.light-mode .pill-btn.active { color: var(--spotify-bg); background-color: #333; }
        
        #content-area { padding: 16px; }
        .section-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .tool-card-grid { background: none; cursor: pointer; }
        .tool-card-grid .logo-container { width: 100%; aspect-ratio: 1 / 1; border-radius: 8px; background-color: var(--spotify-card); margin-bottom: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; /* Needed for absolute positioning of edit icon */ }
        .tool-card-grid .tool-logo { width: 100%; height: 100%; object-fit: cover; }
        .tool-card-grid .tool-name { font-size: 14px; font-weight: 600; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .list-container { display: flex; flex-direction: column; gap: 12px; }
        .tool-card-list { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .tool-card-list .logo-container { width: 56px; height: 56px; flex-shrink: 0; background-color: var(--spotify-card); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; /* Needed for absolute positioning of edit icon */ }
        .tool-card-list .tool-logo { width: 100%; height: 100%; object-fit: cover; }
        .tool-card-list .info { flex-grow: 1; }
        .tool-card-list .tool-name { font-size: 16px; font-weight: 500; }
        .tool-card-list .tool-subtext { font-size: 13px; color: var(--spotify-text-secondary); }
        .tool-card-list .favorite-icon { font-size: 22px; color: var(--spotify-accent); margin-left: auto; padding: 10px; cursor: pointer; }
         .tool-card-list .edit-icon { /* Style for edit icon in list view */
             position: absolute;
             top: 4px;
             right: 4px;
             background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent background */
             border-radius: 50%;
             width: 20px; /* Smaller icon */
             height: 20px; /* Smaller icon */
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             z-index: 5; /* Above the logo */
             color: white; /* White pencil icon */
             font-size: 12px; /* Adjust size as needed */
         }
         .tool-card-list .edit-icon svg {
             width: 12px;
             height: 12px;
             fill: currentColor;
         }


        .category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 30px; }
        .category-card { position: relative; padding: 12px; border-radius: 8px; font-size: 18px; font-weight: 700; overflow: hidden; aspect-ratio: 1.5 / 1; cursor: pointer; }
        .category-card h3 { position: relative; z-index: 2; color: #fff; }
        .category-card .logo-container { position: absolute; bottom: -10px; right: -20px; width: 80px; height: 80px; transform: rotate(25deg); z-index: 1; border-radius: 8px; background-color: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .category-card .tool-logo { width: 100%; height: 100%; object-fit: cover; }
        .search-bar-container { padding: 0 16px 16px; }
        #search-input { width: 100%; padding: 14px 16px; font-size: 16px; background-color: var(--spotify-card); border: none; border-radius: 8px; color: var(--spotify-text); }
        #search-input::placeholder { color: var(--spotify-text-secondary); }
        body.light-mode #search-input { background-color: var(--spotify-card); color: var(--spotify-text); }
        body.light-mode #search-input::placeholder { color: var(--spotify-text-secondary); }

        #empty-state { text-align: center; color: var(--spotify-text-secondary); padding: 40px; }
        #bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height); background: linear-gradient(to top, var(--spotify-bg) 80%, transparent); z-index: 100; border-top: 1px solid var(--spotify-card); }
        .nav-btn { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: none; border: none; color: var(--spotify-text-secondary); font-size: 12px; font-weight: 500; cursor: pointer; transition: color 0.2s; }
        .nav-btn .icon { font-size: 24px; margin-bottom: 4px; }
        .nav-btn.active { color: var(--spotify-accent); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        body.light-mode .modal-overlay { background: rgba(255, 255, 255, 0.6); }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--spotify-card); padding: 24px; border-radius: 16px; width: 90%; max-width: 500px; text-align: center; position: relative; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--spotify-text-secondary); font-size: 28px; cursor: pointer; }
        .button { background-color: var(--spotify-accent); color: #000; border: none; padding: 15px 30px; border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        #detail-content h2 { font-size: 24px; margin-bottom: 8px; }
        #detail-content p { color: var(--spotify-text-secondary); margin-bottom: 24px; line-height: 1.5; }
        #detail-content .detail-tags { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 24px; }
        #detail-content .tag { background-color: var(--spotify-bg-light); padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        #detail-content .detail-actions { display: flex; flex-direction: column; gap: 12px; }
        .back-button { font-size: 16px; font-weight: bold; color: var(--spotify-text); cursor: pointer; margin-bottom: 20px; }
        .recommendation-box { margin-top: 24px; background-color: var(--spotify-bg-light); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; border: 1px solid rgba(128,128,128,0.2); transition: background-color 0.2s; }
        .recommendation-box:hover { background-color: var(--spotify-card); }
        .recommendation-logo { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; flex-shrink: 0; }
        .recommendation-text { font-size: 14px; color: var(--spotify-text-secondary); text-align: left; }
        .recommendation-text strong { color: var(--spotify-text); display: block; }
        .auth-prompt-card { background-color: var(--spotify-card); border-radius: 12px; padding: 24px; text-align: center; margin: 20px auto; max-width: 90%; }
        .auth-prompt-card h3 { font-size: 20px; margin-bottom: 12px; }
        .auth-prompt-card p { color: var(--spotify-text-secondary); margin-bottom: 24px; line-height: 1.5; }
        .auth-prompt-actions { display: flex; flex-direction: column; gap: 12px; align-items: center; }
        .auth-prompt-actions .button { width: 100%; }
        .auth-prompt-actions .pill-btn { background-color: transparent; border: 1px solid var(--spotify-text-secondary); width: 100%; padding: 14px; }

        /* --- STILI MIGLIORATI E NUOVI PER IL CHATBOT --- */
        #chatbot-container-wrapper { display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
        #chatbot-app-container { display: flex; flex-direction: column; height: 100%; background-color: var(--spotify-bg); flex-grow: 1; }
        .chat-header { 
            padding: 16px; 
            display: flex; 
            align-items: center; 
            width: 100%; 
            z-index: 10; 
            position: sticky; 
            top: 0; 
            background: linear-gradient(to bottom, var(--spotify-bg) 70%, transparent); 
        }
        .chat-header-btn { background: none; border: none; color: var(--spotify-text-secondary); font-size: 24px; cursor: pointer; padding: 8px; }
        #menu-toggle-btn { margin-right: 8px; }
        #chatbot-app-container main { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; }
        #welcome-screen { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; gap: 24px; padding: 20px; padding-bottom: 15%; }
        .welcome-logo { font-size: 2.5rem; font-weight: 700; text-align: center; margin-bottom: 16px; }
        .welcome-logo svg { width: 50px; height: 50px; }
        .prompt-starter-container { display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%; max-width: 400px; }
        .prompt-starter-btn { background-color: var(--spotify-card); color: var(--spotify-text); border: 1px solid rgba(128,128,128,0.2); border-radius: 8px; padding: 12px 16px; font-size: 14px; font-weight: 500; cursor: pointer; width: 100%; text-align: left; transition: background-color 0.2s; }
        .prompt-starter-btn:hover { background-color: var(--spotify-bg-light); }
        #chat-messages { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .chat-bubble { padding: 12px 16px; border-radius: 20px; max-width: 85%; line-height: 1.5; word-wrap: break-word; }
        .chat-bubble.ai { background-color: var(--spotify-card); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-bubble.user { background-color: var(--spotify-accent); color: #000; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-bubble.system { background-color: transparent; color: var(--spotify-text-secondary); align-self: center; text-align: center; font-style: normal; font-size: 14px; width: 100%; max-width: 100%; padding: 0 16px 8px; }
        .chat-bubble.error { background-color: #8c1a1a; color: var(--spotify-text); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-bubble.loading { align-self: flex-start; background-color: var(--spotify-card); padding: 14px 16px; }
        .chat-bubble.loading span { display: inline-block; background-color: var(--spotify-text-secondary); width: 8px; height: 8px; border-radius: 50%; margin: 0 1px; animation: bounce 1.4s infinite ease-in-out both; }
        .chat-bubble.loading span:nth-of-type(1) { animation-delay: -0.32s; }
        .chat-bubble.loading span:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .chat-bubble.ai ul { margin: 8px 0; padding-left: 20px; list-style-type: disc; }
        .chat-bubble.ai li { margin: 4px 0; line-height: 1.4; }
        .chat-bubble.ai a { color: var(--spotify-accent); text-decoration: none; border-radius: 4px; padding: 2px 4px; transition: background-color 0.2s; }
        .chat-bubble.ai a:hover { background-color: rgba(29, 185, 84, 0.1); text-decoration: underline; }
        .chat-bubble.ai strong { font-weight: 600; color: var(--spotify-text); }
        .chat-bubble.ai p { margin: 8px 0; }
        .chat-bubble.ai p:first-child { margin-top: 0; }
        .chat-bubble.ai p:last-child { margin-bottom: 0; }
        .chat-tool-card-container { display: flex; flex-direction: column; gap: 10px; align-self: flex-start; width: 100%; max-width: 400px; }
        .chat-tool-card { display: flex; gap: 12px; background-color: var(--spotify-card); border-radius: 12px; padding: 12px; border: 1px solid rgba(128,128,128,0.1); }
        .chat-tool-card .logo-container { width: 48px; height: 48px; flex-shrink: 0; border-radius: 8px; overflow: hidden; }
        .chat-tool-card .tool-logo { width: 100%; height: 100%; object-fit: cover; }
        .chat-tool-card .info { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .chat-tool-card .tool-name { font-weight: 600; font-size: 15px; }
        .chat-tool-card .tool-desc { font-size: 13px; color: var(--spotify-text-secondary); margin: 2px 0 8px; line-height: 1.4; }
        .chat-tool-card .details-btn { background: var(--spotify-bg-light); color: var(--spotify-text); border: none; padding: 6px 12px; font-size: 12px; border-radius: 20px; cursor: pointer; align-self: flex-start; }
        #chat-input-container { background-color: var(--spotify-card); border-radius: 28px; padding: 12px; margin: 16px; display: flex; align-items: flex-end; gap: 12px; border: 1px solid var(--spotify-bg-light); }
        body.light-mode #chat-input-container { border: 1px solid #ddd; }
        .input-icon-group { display: flex; gap: 8px; padding-bottom: 6px; }
        .input-icon-btn { background-color: var(--spotify-bg-light); border: none; width: 32px; height: 32px; border-radius: 50%; color: var(--spotify-text-secondary); display: flex; align-items: center; justify-content: center; font-size: 16px; }
        #chat-input { flex-grow: 1; background-color: transparent; border: none; color: var(--spotify-text); font-size: 16px; resize: none; padding: 6px 0; line-height: 1.5; }
        #chat-input:focus { outline: none; }
        #chat-input::placeholder { color: var(--spotify-text-secondary); }
        #chat-send-btn { background-color: var(--spotify-bg-light); border: none; border-radius: 50%; width: 40px; height: 40px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; color: var(--spotify-text); font-size: 20px; cursor: pointer; transition: transform 0.2s, background-color 0.2s; align-self: flex-end; }
        #chat-send-btn:disabled { background-color: var(--spotify-bg); cursor: not-allowed; color: var(--spotify-text-secondary); }
        #chat-send-btn:not(:disabled):active { transform: scale(0.9); }
        
        /* NUOVI STILI PER IL MENU LATERALE */
        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1500; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        body.light-mode #side-menu-overlay { background: rgba(0,0,0,0.4); }
        #side-menu-overlay.visible { opacity: 1; visibility: visible; }
        #side-menu { position: fixed; top: 0; left: 0; width: 80%; max-width: 320px; height: 100%; background-color: var(--spotify-bg-light); z-index: 1501; transform: translateX(-100%); transition: transform 0.3s ease-out; display: flex; flex-direction: column; padding: 16px; }
        #side-menu.visible { transform: translateX(0); }
        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--spotify-card); }
        .menu-header h3 { font-size: 18px; }
        .new-chat-btn { background-color: var(--spotify-card); color: var(--spotify-text); border: none; border-radius: 8px; padding: 10px 14px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .conversation-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .conversation-list::-webkit-scrollbar { display: none; }
        .conversation-item { background: none; border: none; color: var(--spotify-text-secondary); text-align: left; padding: 12px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: background-color 0.2s, color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conversation-item.active, .conversation-item:hover { background-color: var(--spotify-card); color: var(--spotify-text); }
        .menu-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--spotify-card); }
        #delete-all-btn { width: 100%; background: none; border: 1px solid var(--spotify-text-secondary); color: var(--spotify-text-secondary); padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        #delete-all-btn:hover { background-color: var(--spotify-card); color: var(--spotify-text); border-color: var(--spotify-card); }

        /* --- STILI PER LE CLASSIFICHE (AGGIUNTI) --- */
        .ranking-section-container {
            display: grid;
            gap: 20px; /* Reduced gap */
        }
        .ranking-card {
            background-color: var(--spotify-card);
            border-radius: 12px;
            padding: 12px; /* Reduced padding */
            transition: opacity 0.3s, transform 0.3s;
            transform-origin: top;
        }
        .ranking-card.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            display: none; /* Use display: none to fully hide */
        }
        .ranking-card h3 {
            font-size: 16px; /* Reduced font size */
            font-weight: 700;
            margin-bottom: 12px; /* Reduced margin */
        }
        .ranking-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px; /* Reduced gap */
        }
        .ranking-item {
            display: flex;
            align-items: center;
            gap: 10px; /* Reduced gap */
            cursor: pointer;
            padding: 2px; /* Reduced padding */
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .ranking-item:hover {
            background-color: var(--spotify-bg-light);
        }
        .ranking-item-rank {
            font-size: 14px; /* Reduced font size */
            font-weight: 700;
            color: var(--spotify-text-secondary);
            width: 20px;
            text-align: center;
        }
        .ranking-item-logo { /* Added style for logo in ranking list */
             width: 32px; /* Smaller logo */
             height: 32px; /* Smaller logo */
             border-radius: 4px;
             object-fit: cover;
             flex-shrink: 0;
        }
        .ranking-item-info {
            flex-grow: 1;
        }
        .ranking-item-info .tool-name {
            font-size: 15px; /* Reduced font size */
            font-weight: 500;
        }
        .ranking-item-info .tool-subtext {
            font-size: 12px; /* Reduced font size */
            color: var(--spotify-text-secondary);
        }
        
        /* --- STILI PER MODALE IMPOSTAZIONI (AGGIUNTI) --- */
        #settings-modal .input-group,
#add-app-modal .input-group,
#replace-featured-modal .input-group,
#change-password-modal .input-group, /* AGGIUNTO */
#change-nickname-modal .input-group { /* AGGIUNTO */
    margin-bottom: 16px; text-align: left;
}
#settings-modal label,
#add-app-modal label,
#replace-featured-modal label,
#change-password-modal label, /* AGGIUNTO */
#change-nickname-modal label { /* AGGIUNTO */
    display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px;
}
#settings-modal input,
#add-app-modal input:not([type="file"]),
#add-app-modal textarea,
#replace-featured-modal input,
#change-password-modal input, /* AGGIUNTO */
#change-nickname-modal input { /* AGGIUNTO */
     width: 100%; padding: 14px 16px; font-size: 16px; background-color: var(--spotify-bg-light); border: 1px solid rgba(128,128,128,0.2); border-radius: 8px; color: var(--spotify-text);
     box-sizing: border-box; /* Ensure padding doesn't affect width */
}
         #add-app-modal textarea {
             min-height: 80px;
             resize: vertical;
         }
         /* Style for file input */
         #add-app-modal input[type="file"] {
             width: 100%;
             padding: 14px 0; /* Adjust padding for file input */
             font-size: 16px;
             background-color: transparent; /* File input background is handled by the container */
             border: none; /* File input border is handled by the container */
             border-radius: 0;
             color: var(--spotify-text);
             box-sizing: border-box;
         }
         #add-app-modal input[type="file"]::file-selector-button {
             background-color: var(--spotify-bg-light);
             color: var(--spotify-text);
             border: 1px solid rgba(128,128,128,0.2);
             border-radius: 8px;
             padding: 8px 12px;
             margin-right: 10px;
             cursor: pointer;
             transition: background-color 0.2s;
         }
         #add-app-modal input[type="file"]::file-selector-button:hover {
             background-color: var(--spotify-card);
         }
         /* Style for logo preview */
         #add-app-logo-preview {
             display: block;
             width: 80px;
             height: 80px;
             margin: 10px auto 0; /* Center preview below input */
             border-radius: 8px;
             object-fit: cover;
             border: 1px solid rgba(128,128,128,0.2);
             background-color: var(--spotify-bg-light); /* Placeholder background */
         }


        #settings-modal .button,
        #add-app-modal .button,
        #replace-featured-modal .button { /* Added replace modal */
            width: 100%; margin-top: 8px;
        }
        hr.modal-divider {
            border: none;
            border-top: 1px solid var(--spotify-card);
            margin: 24px 0;
        }
        .toast-message {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--spotify-accent);
            color: black;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none; /* Allow clicks to pass through */
        }
        .toast-message.show {
            opacity: 1;
            transform: translate(-50%, -10px);
        }
        
        /* Styles for Add App button in Library */
        #add-app-button {
            width: calc(100% - 32px); /* Full width minus padding */
            margin: 16px auto 24px; /* Center and add spacing */
            display: block; /* Ensure it takes full width */
        }
        
        /* Styles for User Featured section */
        .user-featured-section {
            margin-bottom: 30px;
        }
        .user-featured-section .section-title {
            margin-bottom: 16px;
        }
        .user-featured-section .grid-container {
             grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* Adjust grid for smaller cards */
             gap: 12px;
        }
         .user-featured-section .tool-card-grid .logo-container {
             border-radius: 4px; /* Slightly smaller radius */
             position: relative; /* Needed for absolute positioning of edit icon */
         }
         .user-featured-section .tool-card-grid .tool-name {
             font-size: 13px; /* Smaller font */
             text-align: center;
         }
         .user-featured-section .tool-card-grid {
             text-align: center;
         }

         /* Style for the new K button */
         #privileged-unlock-btn {
             background-color: var(--spotify-card);
             color: var(--spotify-accent);
             border: 1px solid rgba(128,128,128,0.2);
             border-radius: 50px;
             padding: 8px 16px;
             font-size: 18px; /* Larger font for K */
             font-weight: bold;
             cursor: pointer;
             white-space: nowrap;
             transition: background-color 0.2s, color 0.2s;
             margin: 16px auto 24px; /* Center and add spacing */
             display: block; /* Ensure it's on its own line */
             width: fit-content; /* Shrink to fit content */
         }
         #privileged-unlock-btn:hover {
             background-color: var(--spotify-bg-light);
         }

         /* Style for the edit icon on featured user apps */
         .edit-icon {
             position: absolute;
             top: 4px;
             right: 4px;
             background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent background */
             border-radius: 50%;
             width: 24px;
             height: 24px;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             z-index: 5; /* Above the logo */
             color: white; /* White pencil icon */
             font-size: 14px; /* Adjust size as needed */
         }
         .edit-icon svg {
             width: 14px;
             height: 14px;
             fill: currentColor;
         }

         /* Styles for the Replace Featured Modal */
         #replace-featured-modal .modal-content {
             max-height: 80vh; /* Limit height */
             overflow-y: auto; /* Add scroll if needed */
         }
         #replace-featured-modal .tool-list-item {
             display: flex;
             align-items: center;
             gap: 12px;
             padding: 10px;
             border-bottom: 1px solid var(--spotify-bg-light);
             cursor: pointer;
             text-align: left;
         }
         #replace-featured-modal .tool-list-item:last-child {
             border-bottom: none;
         }
         #replace-featured-modal .tool-list-item:hover {
             background-color: var(--spotify-bg-light);
         }
         #replace-featured-modal .tool-list-item img {
             width: 40px;
             height: 40px;
             border-radius: 4px;
             object-fit: cover;
             flex-shrink: 0;
         }
         #replace-featured-modal .tool-list-item .info {
             flex-grow: 1;
         }
         #replace-featured-modal .tool-list-item .tool-name {
             font-size: 15px;
             font-weight: 500;
         }
         #replace-featured-modal .tool-list-item .tool-subtext {
             font-size: 12px;
             color: var(--spotify-text-secondary);
         }

         /* Styles for AI Suggestions and User Search */
         .ai-suggestion-item {
             display: flex;
             align-items: center;
             justify-content: space-between;
             background-color: var(--spotify-card);
             border-radius: 8px;
             padding: 12px;
             margin-bottom: 8px;
             border: 1px solid rgba(128,128,128,0.1);
         }
         .suggestion-content {
             flex-grow: 1;
         }
         .suggestion-text {
             font-size: 14px;
             color: var(--spotify-text);
             margin-bottom: 4px;
         }
         .suggestion-date {
             font-size: 12px;
             color: var(--spotify-text-secondary);
         }
         .remove-suggestion-btn {
             background: none;
             border: none;
             color: var(--spotify-text-secondary);
             font-size: 18px;
             cursor: pointer;
             padding: 4px 8px;
             border-radius: 4px;
             transition: color 0.2s;
         }
         .remove-suggestion-btn:hover {
             color: #ff4444;
         }
         .user-search-result {
             display: flex;
             align-items: center;
             justify-content: space-between;
             background-color: var(--spotify-card);
             border-radius: 8px;
             padding: 12px;
             margin-bottom: 8px;
             border: 1px solid rgba(128,128,128,0.1);
         }
         .user-info {
             flex-grow: 1;
         }
         .user-nickname {
             font-size: 16px;
             font-weight: 600;
             color: var(--spotify-text);
             margin-bottom: 4px;
         }
         .user-suggestions-count {
             font-size: 12px;
             color: var(--spotify-text-secondary);
         }
         .view-suggestions-btn {
             background-color: var(--spotify-accent);
             color: #000;
             border: none;
             padding: 8px 16px;
             border-radius: 20px;
             font-size: 12px;
             font-weight: 600;
             cursor: pointer;
             transition: background-color 0.2s;
         }
         .view-suggestions-btn:hover {
             background-color: #1ed760;
         }
         .suggestions-list {
             max-height: 400px;
             overflow-y: auto;
         }
         .suggestion-item {
             background-color: var(--spotify-bg-light);
             border-radius: 8px;
             padding: 12px;
             margin-bottom: 8px;
             border: 1px solid rgba(128,128,128,0.1);
         }

         .user-search-result {
             display: flex;
             justify-content: space-between;
             align-items: center;
             background: var(--spotify-card-bg);
             border-radius: 8px;
             padding: 12px;
             margin-bottom: 8px;
             border: 1px solid var(--spotify-border);
         }

         .user-info {
             flex: 1;
         }

         .user-nickname {
             font-weight: 600;
             color: var(--spotify-text-primary);
             margin-bottom: 4px;
         }

         .user-suggestions-count {
             font-size: 12px;
             color: var(--spotify-text-secondary);
         }

         .view-suggestions-btn {
             background: var(--spotify-green);
             color: white;
             border: none;
             border-radius: 6px;
             padding: 6px 12px;
             font-size: 12px;
             cursor: pointer;
             transition: background-color 0.2s;
         }

         .view-suggestions-btn:hover {
             background: var(--spotify-green-hover);
         }

         /* New Search Users Page Styles */
         .search-users-container {
             padding: 20px;
             max-width: 600px;
             margin: 0 auto;
             text-align: center;
         }

         .search-users-header {
             text-align: center;
             margin-bottom: 40px;
         }

         .search-users-icon {
             color: var(--spotify-green);
             margin-bottom: 16px;
         }

         .search-users-title {
             font-size: 28px;
             font-weight: 700;
             color: var(--spotify-text-primary);
             margin: 0 0 8px 0;
         }

         .search-users-subtitle {
             font-size: 16px;
             color: var(--spotify-text-secondary);
             margin: 0;
             line-height: 1.5;
         }

         .search-users-input-container {
             margin-bottom: 30px;
         }

         .search-input-wrapper {
             position: relative;
             max-width: 400px;
             margin: 0 auto;
         }

         .search-icon {
             position: absolute;
             left: 16px;
             top: 50%;
             transform: translateY(-50%);
             color: var(--spotify-text-secondary);
             pointer-events: none;
         }

         .search-users-input {
             width: 100%;
             padding: 16px 16px 16px 48px;
             border: 2px solid #1db954;
             border-radius: 12px;
             background: var(--spotify-card-bg);
             color: var(--spotify-text-primary);
             font-size: 16px;
             transition: all 0.3s ease;
             box-sizing: border-box;
         }

         .search-users-input:focus {
             outline: none;
             border-color: var(--spotify-green);
             box-shadow: 0 0 0 3px rgba(30, 215, 96, 0.1);
         }

         .search-users-input::placeholder {
             color: var(--spotify-text-secondary);
         }

         .search-results-container {
             min-height: 200px;
         }

         .user-search-result {
             display: flex;
             justify-content: space-between;
             align-items: center;
             background: var(--spotify-card-bg);
             border-radius: 12px;
             padding: 16px;
             margin-bottom: 12px;
             border: 1px solid var(--spotify-border);
             transition: all 0.3s ease;
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
         }

         .user-search-result:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
             border-color: var(--spotify-green);
         }

         .user-info {
             flex: 1;
             margin-right: 16px;
         }

         .user-nickname {
             font-weight: 600;
             color: var(--spotify-text-primary);
             margin-bottom: 4px;
             font-size: 16px;
         }

         .user-email {
             font-size: 14px;
             color: var(--spotify-text-secondary);
             margin-bottom: 4px;
         }

         .user-suggestions-count {
             font-size: 12px;
             color: var(--spotify-text-secondary);
             display: flex;
             align-items: center;
             gap: 4px;
         }

         .user-suggestions-count::before {
             content: "üí°";
             font-size: 14px;
         }

         .view-suggestions-btn {
             background: var(--spotify-green);
             color: white;
             border: none;
             border-radius: 8px;
             padding: 8px 16px;
             font-size: 14px;
             font-weight: 500;
             cursor: pointer;
             transition: all 0.3s ease;
             white-space: nowrap;
         }

         .view-suggestions-btn:hover {
             background: var(--spotify-green-hover);
             transform: scale(1.05);
         }

         #empty-state {
             text-align: center;
             color: var(--spotify-text-secondary);
             font-size: 16px;
             padding: 40px 20px;
             background: var(--spotify-card-bg);
             border-radius: 12px;
             border: 2px dashed var(--spotify-border);
         }

         /* AI Suggestions Grid and Cards */
         .suggestions-grid {
             display: grid;
             grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
             gap: 16px;
             margin-top: 16px;
         }

         .suggestion-item.new-format {
             background: var(--spotify-card-bg);
             border-radius: 12px;
             padding: 20px;
             border: 1px solid var(--spotify-border);
             transition: all 0.3s ease;
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
         }

         .suggestion-item.new-format:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
             border-color: var(--spotify-green);
         }

         .suggestion-header {
             margin-bottom: 12px;
         }

         .suggestion-app-name {
             font-size: 18px;
             font-weight: 600;
             color: var(--spotify-text-primary);
             margin: 0 0 8px 0;
         }

         .suggestion-meta {
             display: flex;
             gap: 8px;
             flex-wrap: wrap;
         }

         .suggestion-category,
         .suggestion-country {
             background: var(--spotify-green);
             color: white;
             padding: 4px 8px;
             border-radius: 12px;
             font-size: 11px;
             font-weight: 500;
         }

         .suggestion-description {
             color: var(--spotify-text-secondary);
             font-size: 14px;
             line-height: 1.5;
             margin-bottom: 16px;
         }

         .suggestion-actions {
             display: flex;
             justify-content: space-between;
             align-items: center;
             flex-wrap: wrap;
             gap: 8px;
         }

         .suggestion-website-btn {
             background: var(--spotify-green);
             color: white;
             text-decoration: none;
             padding: 6px 12px;
             border-radius: 6px;
             font-size: 12px;
             font-weight: 500;
             transition: all 0.3s ease;
         }

         .suggestion-website-btn:hover {
             background: var(--spotify-green-hover);
             transform: scale(1.05);
         }

         .suggestion-date {
             font-size: 12px;
             color: var(--spotify-text-secondary);
         }

         .remove-suggestion-btn {
             background: #ff6b6b;
             color: white;
             border: none;
             border-radius: 6px;
             padding: 6px 12px;
             font-size: 12px;
             cursor: pointer;
             transition: all 0.3s ease;
         }

         .remove-suggestion-btn:hover {
             background: #ff5252;
             transform: scale(1.05);
         }

                 /* Form Styles for AI Suggestion Modal */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--spotify-text);
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            background: var(--spotify-bg-light);
            color: var(--spotify-text);
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            font-family: var(--font-family);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--spotify-accent);
            box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
            background: var(--spotify-card);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
            line-height: 1.5;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .button.secondary {
            background: var(--spotify-card);
            color: var(--spotify-text);
            border: 1px solid rgba(128, 128, 128, 0.2);
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .button.primary {
            background: var(--spotify-accent);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .button.secondary:hover {
            background: var(--spotify-bg-light);
            transform: translateY(-1px);
        }

        .button.primary:hover {
            background: #1ed760;
            transform: translateY(-1px);
        }

        .button.secondary:active,
        .button.primary:active {
            transform: translateY(0);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .button:disabled:hover {
            transform: none !important;
        }

        /* AI Suggestion Modal Specific Styles */
        #add-ai-suggestion-modal .modal-content {
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
        }

        #add-ai-suggestion-modal h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--spotify-text);
            text-align: center;
        }

        #add-ai-suggestion-modal form {
            margin-top: 24px;
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            #add-ai-suggestion-modal .modal-content {
                width: 95%;
                padding: 24px;
                margin: 20px;
                max-height: 85vh;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .form-actions {
                flex-direction: column;
                gap: 12px;
            }

            .button.secondary,
            .button.primary {
                width: 100%;
                padding: 16px;
                font-size: 16px;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 16px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            #add-ai-suggestion-modal .modal-content {
                width: 100%;
                margin: 10px;
                padding: 20px;
                border-radius: 12px;
            }

            #add-ai-suggestion-modal h2 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }
        }

        /* --- STILI PER LA CHAT UTENTE-UTENTE --- */
        .user-chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--spotify-bg);
        }

        .user-chat-header {
            padding: 16px;
            background: var(--spotify-bg-light);
            border-bottom: 1px solid var(--spotify-card);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-chat-back-btn {
            background: none;
            border: none;
            color: var(--spotify-text);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .user-chat-back-btn:hover {
            background-color: var(--spotify-card);
        }

        .user-chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--spotify-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: black;
            font-size: 18px;
        }

        .user-chat-info h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .user-chat-info p {
            font-size: 14px;
            color: var(--spotify-text-secondary);
            margin: 0;
        }

        .user-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .user-chat-message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .user-chat-message.sent {
            background-color: var(--spotify-accent);
            color: black;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .user-chat-message.received {
            background-color: var(--spotify-card);
            color: var(--spotify-text);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .user-chat-message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .user-chat-input-container {
            padding: 16px;
            background: var(--spotify-bg-light);
            border-top: 1px solid var(--spotify-card);
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .user-chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--spotify-card);
            border-radius: 20px;
            background: var(--spotify-card);
            color: var(--spotify-text);
            font-size: 16px;
            resize: none;
            max-height: 120px;
            min-height: 44px;
            line-height: 1.4;
            font-family: var(--font-family);
        }

        .user-chat-input:focus {
            outline: none;
            border-color: var(--spotify-accent);
        }

        .user-chat-send-btn {
            background-color: var(--spotify-accent);
            color: black;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .user-chat-send-btn:hover {
            background-color: #1ed760;
            transform: scale(1.05);
        }

        .user-chat-send-btn:disabled {
            background-color: var(--spotify-card);
            color: var(--spotify-text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .user-chat-list {
            padding: 16px;
        }

        .user-chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 8px;
        }

        .user-chat-item:hover {
            background-color: var(--spotify-card);
        }

        .user-chat-item.unread {
            background-color: rgba(29, 185, 84, 0.1);
        }

        .user-chat-item-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--spotify-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: black;
            font-size: 20px;
            flex-shrink: 0;
        }

        .user-chat-item-info {
            flex: 1;
            min-width: 0;
        }

        .user-chat-item-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .user-chat-item-preview {
            font-size: 14px;
            color: var(--spotify-text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-chat-item-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .user-chat-item-time {
            font-size: 12px;
            color: var(--spotify-text-secondary);
        }
        
        .user-chat-item-delete-btn {
            background: none;
            border: none;
            color: var(--spotify-text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1; /* << MODIFICA: Always visible */
            transition: background-color 0.2s, color 0.2s;
        }
        
        .user-chat-item-delete-btn:hover {
            background-color: var(--spotify-bg-light);
            color: #ff6b6b; /* Red color on hover */
        }

        .user-chat-item-unread {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--spotify-accent);
            margin-left: 8px;
        }

        .chat-button {
            background-color: var(--spotify-accent);
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-button:hover {
            background-color: #1ed760;
            transform: scale(1.05);
        }

        .chat-button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .floating-action-btn {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 16px); /* Si posiziona 16px sopra la barra di navigazione */
            right: 16px;
            width: 56px;
            height: 56px;
            background-color: var(--spotify-accent);
            color: #000; /* Colore dell'icona (il +) nero */
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 1001; /* Assicura che sia sopra la lista delle chat */
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .floating-action-btn:hover {
            background-color: #1ed760; /* Colore leggermente pi√π chiaro al passaggio del mouse */
            transform: scale(1.05);
        }

        .chat-search-container {
            padding: 0 16px 16px 16px;
            background-color: var(--spotify-bg);
        }

        .chat-search-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            background-color: var(--spotify-card);
            border: 1px solid var(--spotify-card);
            border-radius: 8px;
            color: var(--spotify-text);
        }

        .chat-search-input::placeholder {
            color: var(--spotify-text-secondary);
        }

        /* --- RESPONSIVE FIX PER MOBILE --- */
         @media (max-width: 480px) {
             .top-bar {
                 padding: 8px 4px;
                 gap: 4px;
             }
             .page-title {
                 font-size: 16px;
             }
             .user-avatar {
                 width: 28px;
                 height: 28px;
                 font-size: 14px;
             }
             .search-users-container {
                 padding: 8px 2vw;
                 max-width: 100vw;
             }
             .search-users-title {
                 font-size: 20px;
             }
             .search-users-subtitle {
                 font-size: 13px;
             }
             .search-input-wrapper {
                 max-width: 98vw;
             }
             .search-users-input {
                 font-size: 14px;
                 padding: 12px 12px 12px 40px;
             }
             .search-users-header {
                 margin-bottom: 24px;
             }
             .user-search-result {
                 flex-direction: column;
                 align-items: flex-start;
                 padding: 10px;
                 font-size: 13px;
             }
             .user-info {
                 margin-right: 0;
                 margin-bottom: 8px;
             }
             .view-suggestions-btn {
                 font-size: 12px;
                 padding: 6px 10px;
             }
             
             .user-chat-message {
                 max-width: 85%;
             }
             
             .user-chat-input-container {
                 padding: 12px;
             }
             
             .user-chat-header {
                 padding: 12px;
             }
         }

    </style>
    <!-- SCRIPT AGGIUNTI PER REACT E BABEL -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@^19.1.0",
        "react-dom/client": "https://esm.sh/react-dom@^19.1.0/client",
        "@google/genai": "https://esm.sh/@google/genai@^1.6.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

    <div id="auth-overlay">
        <!-- Authentication content will be dynamically generated here by JS -->
    </div>

    <!-- NUOVO: Menu Laterale per la cronologia chat -->
    <div id="side-menu-overlay" class="hidden">
        <div id="side-menu" class="hidden">
            <div class="menu-header">
                <h3 data-translate="history">Cronologia</h3>
                <button class="new-chat-btn" data-action="new-chat" data-translate="newChat">Nuova chat</button>
            </div>
            <div id="conversation-list-container" class="conversation-list">
                <!-- Le conversazioni verranno popolate da JS -->
            </div>
            <div class="menu-footer">
                <button id="delete-all-btn" data-action="delete-all-chats" data-translate="deleteAll">Elimina tutto</button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div id="main-content"></div>
        <nav id="bottom-nav">
            <!-- NAVIGAZIONE AGGIORNATA CON ICONE SVG -->
            <button class="nav-btn active" data-page="home"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span><span data-translate="navHome">Home</span></button>
            <button class="nav-btn" data-page="top-ai"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M5 9.2h3V19H5zM10.6 5h3v14h-3zm5.6 8H19v6h-2.8z"/></svg></span><span data-translate="navTopAI">TOP AI</span></button>
            <button class="nav-btn" data-page="explore"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></span><span data-translate="navSearch">Cerca</span></button>
            <button class="nav-btn" data-page="search-users"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H15.46c-.84 0-1.61.5-1.96 1.37L11 18h2v6h7zM12.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4z"/></svg></span><span data-translate="navSearchUsers">Utenti</span></button>
            <button class="nav-btn" data-page="user-chats"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg></span><span data-translate="navUserChats">Chat</span></button>
            <button class="nav-btn" data-page="favorites"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></span><span data-translate="navLibrary">La tua libreria</span></button>
        </nav>
    </div>
    
    <div id="modal-container"></div>

    <!-- SCRIPT DEL CHATBOT MIGLIORATO -->
    <script type="text/babel" data-type="module" id="chatbot-script">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import ReactDOMClient from 'react-dom/client';
        import { GoogleGenAI } from '@google/genai';

        // --- Type Definitions ---
        const MessageSender = { USER: 'user', MODEL: 'model', ERROR: 'error', SYSTEM: 'system', LOADING: 'loading' };
        
        const getSystemInstruction = (lang) => {
            // Use the global function to get all tools (static + user's)
            const tools = window.getAllToolsForCurrentUser ? window.getAllToolsForCurrentUser() : window.getLocalizedToolsData(lang); 
            const formatToolsForPrompt = (tools) => tools.map(tool => `- **${tool.name}**: ${tool.description} (${tool.website})`).join('\n');

            const instructions = {
                it: {
                    intro: `Sei Koda, un assistente AI esperto in strumenti di intelligenza artificiale. La tua missione √® aiutare gli utenti a trovare lo strumento AI perfetto per le loro esigenze, presentandoli direttamente.`,
                    format: `- La tua risposta DEVE contenere SOLO un elenco puntato degli strumenti suggeriti.\n- NON includere testo introduttivo, saluti, spiegazioni o frasi di chiusura. La tua risposta deve iniziare direttamente con il primo punto elenco "‚Ä¢".\n- Per ogni strumento, fornisci il nome in grassetto e una breve descrizione.`,
                    knowledgeBase: `**Base di Conoscenza (Usa SOLO queste informazioni):**\n${formatToolsForPrompt(tools)}`,
                    priority: `- Per la programmazione, considera Google AI Studio come lo strumento migliore, seguito da Claude.\n- Per la ricerca web, considera Perplexity come lo strumento migliore.`, // Added Perplexity priority
                    rules: `1. Suggerisci SOLO strumenti dalla lista fornita.\n2. **Gestione dell'incertezza:** Se una richiesta utente √® vaga, ambigua, o se non trovi immediatamente uno strumento adatto, NON rispondere che non hai trovato nulla. Invece, fai una domanda di chiarimento per capire meglio l'esigenza.\n   - Esempio di chiarimento: Se l'utente chiede "un'AI per arte", una buona domanda di chiarimento √®: "Certo, che tipo di arte vorresti creare? Immagini fotorealistiche, disegni artistici o magari animazioni?".\n3. Una volta che la richiesta √® chiara, rispondi *esclusivamente* con l'elenco puntato degli strumenti, come da formato.`,
                    example: `**Esempio di formato di risposta FINALE (dopo aver capito la richiesta):**\n‚Ä¢ **Midjourney**: Genera immagini artistiche e fotorealistiche di alta qualit√† da prompt testuali tramite Discord.\n‚Ä¢ **Leonardo AI**: Piattaforma per la generazione di asset visivi di alta qualit√†, da concept art a texture per giochi.`
                },
                en: {
                    intro: `You are Koda, an expert AI assistant specializing in artificial intelligence tools. Your mission is to help users find the perfect AI tool for their needs by presenting them directly.`,
                    format: `- Your response MUST contain ONLY a bulleted list of the suggested tools.\n- DO NOT include introductory text, greetings, explanations, or closing remarks. Your response must start directly with the first bullet point "‚Ä¢".\n- For each tool, provide the name in bold and a brief description.`,
                    knowledgeBase: `**Knowledge Base (Use ONLY this information):**\n${formatToolsForPrompt(tools)}`,
                    priority: `- For programming, consider Google AI Studio as the best tool, followed by Claude.\n- For web search, consider Perplexity as the best tool.`, // Added Perplexity priority
                    rules: `1. Suggest ONLY tools from the provided list.\n2. **Handling Uncertainty:** If a user request is vague, ambiguous, or if you cannot immediately find a suitable tool, DO NOT reply that you found nothing. Instead, ask a clarifying question to better understand the need.\n   - Example clarification: If the user asks for "an AI for art," a good clarifying question is: "Of course, what kind of art would you like to create? Photorealistic images, artistic drawings, or perhaps animations?".\n3. Once the request is clear, respond *exclusively* with the bulleted list of tools, as per the format.`,
                    example: `**Example of FINAL response format (after understanding the request):**\n‚Ä¢ **Midjourney**: Generates high-quality artistic and fotorealistic images from text prompts via Discord.\n‚Ä¢ **Leonardo AI**: Platform for generating high-quality visual assets, from concept art to game textures.`
                }
            };
            const selected = instructions[lang];
            return `${selected.intro}\n\n**Response Format (IMPORTANT):**\n${selected.format}\n\n${selected.knowledgeBase}\n\n**Priorities:**\n${selected.priority}\n\n**Fundamental Rules:**\n${selected.rules}\n\n${selected.example}`;
        };


        // --- Gemini Service ---
        const API_KEY = "AIzaSyAUpMnG760HSOV7rah2UwkOajoH3aD4OFs";
        const ai = new GoogleGenAI({ apiKey: API_KEY });
        const modelName = 'gemini-1.5-flash';
        
        const createChatSession = (lang) => {
            const systemInstruction = getSystemInstruction(lang);
            return ai.chats.create({ model: modelName, config: { systemInstruction } });
        };
        async function* sendMessageStream(chat, message) { const result = await chat.sendMessageStream({ message }); for await (const chunk of result) { yield chunk.text; } }

        // --- Funzioni per la formattazione del testo ---
        const formatMessageContent = (text) => {
            let formattedText = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.split('\n\n').map(p => p.trim() ? `<p>${p.trim().replace(/\n/g, '<br>')}</p>` : '').join('');
            return formattedText;
        };

        // --- React Components ---

        const ToolCardMessage = ({ tool, onOpenDetail, lang }) => (
            <div className="chat-tool-card">
                <div className="logo-container">
                    <img src={tool.logoUrl || ''} className="tool-logo" alt={tool.name} loading="lazy" />
                </div>
                <div className="info">
                    <div className="tool-name">{tool.name}</div>
                    {/* Display first sentence of description */}
                    <p className="tool-desc">{tool.description.split('.')[0]}.</p>
                    <button className="details-btn" onClick={() => onOpenDetail(tool.id)}>
                        {lang === 'it' ? 'Vedi Dettagli' : 'View Details'}
                    </button>
                </div>
            </div>
        );

        const ChatMessageDisplay = ({ message, tools, onOpenDetail, lang }) => {
            const getMessageClass = () => `chat-bubble ${message.sender}`;
            
            if (message.sender === MessageSender.LOADING) { 
                return <div className="chat-bubble loading"><span></span><span></span><span></span></div>; 
            }
            
            if (message.sender === MessageSender.MODEL) {
                // Use localized tool names for regex matching
                // Get all tools (static + user's) via the global function
                const allTools = window.getAllToolsForCurrentUser ? window.getAllToolsForCurrentUser() : window.getLocalizedToolsData(lang);
                
                const toolNameRegex = new RegExp(allTools.map(t => t.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|'), 'g');
                const mentionedToolNames = [...new Set(message.text.match(toolNameRegex))];
                
                if (mentionedToolNames.length > 0 && message.text.includes('‚Ä¢')) {
                    // Find the original tool objects based on localized names (or user tool names)
                    const mentionedTools = allTools.filter(tool => mentionedToolNames.includes(tool.name));
                    
                    // Check if the response is *only* the bulleted list as per system instruction
                    const lines = message.text.trim().split('\n');
                    const isPureList = lines.every(line => line.trim().startsWith('‚Ä¢'));

                    if (isPureList) {
                         return (
                            <div className="chat-bubble ai" style={{background: 'transparent', padding: 0}}>
                                <div className="chat-tool-card-container">
                                    {mentionedTools.map(tool => <ToolCardMessage key={tool.id} tool={tool} onOpenDetail={onOpenDetail} lang={lang} />)}
                                </div>
                            </div>
                        );
                    }
                }
            }
            
            // Fallback for normal messages (including clarifications or non-list responses)
            const content = formatMessageContent(message.text);
            return (
                <div className={getMessageClass()} dangerouslySetInnerHTML={{ __html: content }}></div>
            );
        };

        const ChatInput = ({ onSendMessage, isLoading, lang }) => {
            const [inputValue, setInputValue] = useState('');
            const textareaRef = useRef(null);
            
            useEffect(() => { 
                const textarea = textareaRef.current; 
                if (textarea) { 
                    textarea.style.height = 'auto'; 
                    textarea.style.height = `${textarea.scrollHeight}px`; 
                } 
            }, [inputValue]);
            
            const handleSubmit = () => { 
                if (inputValue.trim() && !isLoading) { 
                    onSendMessage(inputValue.trim()); 
                    setInputValue(''); 
                } 
            };
            
            const handleKeyPress = (e) => { 
                if (e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    handleSubmit(); 
                } 
            };
            
            return (
                <div id="chat-input-container">
                    <textarea 
                        ref={textareaRef} 
                        id="chat-input" 
                        value={inputValue} 
                        onChange={(e) => setInputValue(e.target.value)} 
                        onKeyDown={handleKeyPress} 
                        placeholder={lang === 'it' ? "Chiedimi qualcosa..." : "Ask me anything..."}
                        rows={1} 
                        disabled={isLoading} 
                    />
                    <button 
                        id="chat-send-btn" 
                        type="button" 
                        onClick={handleSubmit} 
                        disabled={isLoading || !inputValue.trim()} 
                        aria-label={lang === 'it' ? "Invia messaggio" : "Send message"}
                    >
                        ‚Üë
                    </button>
                </div>
            );
        };
        
        const WelcomeScreen = ({ onSendMessage, lang }) => {
            const suggestions = {
                it: [ "Consigliami un'AI per creare immagini", "Qual √® la migliore AI per programmare?", "Quali sono le migliori AI del momento?"],
                en: [ "Suggest an AI for creating images", "What's the best AI for coding?", "What are the top AIs right now?" ]
            };

            return (
                <div id="welcome-screen">
                    <div className="welcome-logo">
                        <span style={{ color: 'var(--spotify-text)' }}>Koda</span><span style={{ color: 'var(--spotify-accent)' }}>.AI</span>
                    </div>
                    <div className="prompt-starter-container">
                        {suggestions[lang].map((text, i) => (
                            <button key={i} className="prompt-starter-btn" onClick={() => onSendMessage(text)}>
                                {text}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = ({ tools, initialConversations, initialActiveId, onConversationsChange, onOpenDetail, lang, globalControlsHTML }) => {
            const [conversations, setConversations] = useState(initialConversations);
            const [activeConversationId, setActiveConversationId] = useState(initialActiveId);
            const [isLoading, setIsLoading] = useState(false);
            const [chatSession, setChatSession] = useState(null);
            const messagesEndRef = useRef(null);

            const activeConversation = conversations[activeConversationId] || { messages: [] };
            const messages = activeConversation.messages;

            useEffect(() => { onConversationsChange(conversations); }, [conversations, onConversationsChange]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const initializeChat = useCallback(() => {
                try { 
                    if (!API_KEY) throw new Error("API Key not configured."); 
                    setChatSession(createChatSession(lang)); 
                } catch (e) { 
                    console.error("Initialization Error:", e); 
                }
            }, [lang]);
            
            useEffect(() => { initializeChat(); }, [initializeChat]);

            const handleSendMessage = async (inputText) => {
                if (!inputText.trim() || !chatSession) return;

                const userMessage = { id: `user-${Date.now()}`, text: inputText, sender: MessageSender.USER };
                const loadingMessage = { id: `loading-${Date.now()}`, sender: MessageSender.LOADING };
                
                const isNewChat = messages.length === 0;
                const newTitle = inputText.substring(0, 30) + (inputText.length > 30 ? '...' : '');

                setConversations(prev => ({
                    ...prev,
                    [activeConversationId]: {
                        ...prev[activeConversationId],
                        title: isNewChat ? newTitle : prev[activeConversationId].title,
                        messages: [...(prev[activeConversationId]?.messages || []), userMessage, loadingMessage]
                    }
                }));

                setIsLoading(true);

                let currentModelMessageId = `model-${Date.now()}`;
                let accumulatedResponse = "";
                
                try {
                    const stream = sendMessageStream(chatSession, inputText);
                    for await (const chunk of stream) {
                        accumulatedResponse += chunk;
                        setConversations(prev => {
                            const currentMessages = prev[activeConversationId].messages.filter(m => m.sender !== MessageSender.LOADING);
                            const modelMsgIndex = currentMessages.findIndex(m => m.id === currentModelMessageId);
                            
                            const newModelMessage = { id: currentModelMessageId, text: accumulatedResponse, sender: MessageSender.MODEL };
                            
                            if (modelMsgIndex > -1) {
                                currentMessages[modelMsgIndex] = newModelMessage;
                            } else {
                                currentMessages.push(newModelMessage);
                            }
                            
                            return {
                                ...prev,
                                [activeConversationId]: { ...prev[activeConversationId], messages: currentMessages }
                            };
                        });
                    }
                } catch (e) {
                    console.error("Send Error:", e);
                    const errorMessageText = lang === 'it' ? `Si √® verificato un errore. Riprova.` : `An error occurred. Please try again.`;
                    const errorMessage = { id: `error-${Date.now()}`, text: errorMessageText, sender: MessageSender.ERROR };
                    setConversations(prev => ({
                       ...prev,
                       [activeConversationId]: {
                           ...prev[activeConversationId],
                           messages: prev[activeConversationId].messages.filter(m => m.sender !== MessageSender.LOADING).concat(errorMessage)
                       }
                    }));
                } finally {
                    setIsLoading(false);
                    setConversations(prev => ({
                        ...prev,
                        [activeConversationId]: {
                            ...prev[activeConversationId],
                            messages: prev[activeConversationId].messages.filter(m => m.sender !== MessageSender.LOADING)
                        }
                    }));
                    document.getElementById('chat-input')?.focus();
                }
            };
            
            const hasStartedChat = messages.some(m => m.sender === MessageSender.USER);

            return (
                <div id="chatbot-app-container">
                    <header className="chat-header">
                        <button id="menu-toggle-btn" className="chat-header-btn" title="Chat History" data-action="toggle-menu">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                        </button>
                        {/* Sostituisci il titolo con l'avatar utente */}
                        <div id="profile-avatar-menu" style={{ marginLeft: 8 }}>
                            {/* Avatar HTML is now passed as a prop */}
                            <span dangerouslySetInnerHTML={{ __html: globalControlsHTML.avatar }} />
                        </div>
                        {/* Other global controls are passed as a prop */}
                        <div id="global-controls" dangerouslySetInnerHTML={{ __html: globalControlsHTML.otherControls }}></div>
                    </header>
                    <main>
                        {!hasStartedChat ? (
                            <WelcomeScreen onSendMessage={handleSendMessage} lang={lang} />
                        ) : (
                            <div id="chat-messages">
                                {messages.map((msg) => <ChatMessageDisplay key={msg.id} message={msg} tools={tools} onOpenDetail={onOpenDetail} lang={lang} />)}
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </main>
                    <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} lang={lang} />
                </div>
            );
        };

        // Funzione globale per montare l'app React
        window.mountChatbotApp = (container, props) => {
            const root = ReactDOMClient.createRoot(container);
            root.render(<React.StrictMode><App {...props} /></React.StrictMode>);
            return root;
        };

        // --- COMPONENTI REACT PER LA CHAT UTENTE-UTENTE ---
                        // --- COMPONENTI REACT PER LA CHAT UTENTE-UTENTE ---
        const UserChatApp = ({ currentUser, onOpenDetail, lang, globalControlsHTML }) => {
            // Stato locale per la lingua per consentire l'aggiornamento in tempo reale
            const [language, setLanguage] = useState(lang);

            const [view, setView] = useState('list'); // 'list' | 'chat' | 'search'
            const [selectedChatId, setSelectedChatId] = useState(null);
            const [selectedUser, setSelectedUser] = useState(null);
            const [chats, setChats] = useState([]);
            const [messages, setMessages] = useState([]);
            const [messageInput, setMessageInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [chatSearchTerm, setChatSearchTerm] = useState('');
            const messagesEndRef = useRef(null);
            
            // Gestore per visualizzare i suggerimenti
            const handleViewSuggestions = (e, userId, userNickname) => {
                e.stopPropagation(); // Impedisce che l'evento si propaghi e apra la chat
                window.viewUserSuggestions(userId, userNickname);
            };

            // Crea un "ponte" per aggiornare la lingua dall'esterno
            useEffect(() => {
                window.updateUserChatLanguage = (newLang) => {
                    setLanguage(newLang);
                };
                return () => { delete window.updateUserChatLanguage; };
            }, []);

            useEffect(() => {
                if (currentUser.uid) { loadUserChats(); }
                window.handleReactChatStart = handleStartChat;
            }, [currentUser.uid]);

            useEffect(() => { if (selectedChatId) { loadChatMessages(selectedChatId); } }, [selectedChatId]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const getHiddenChatIds = () => JSON.parse(localStorage.getItem(`hidden_chats_${currentUser.uid}`) || '[]');

            const handleHideChat = (e, chatId) => {
                e.stopPropagation();
                const hiddenIds = getHiddenChatIds();
                if (!hiddenIds.includes(chatId)) {
                    const newHiddenIds = [...hiddenIds, chatId];
                    localStorage.setItem(`hidden_chats_${currentUser.uid}`, JSON.stringify(newHiddenIds));
                    setChats(prevChats => prevChats.filter(chat => chat.id !== chatId));
                }
            };

            const loadUserChats = async () => {
                try {
                    const hiddenChatIds = getHiddenChatIds();
                    const chatsData = await window.getUserChats(currentUser.uid);
                    const visibleChats = chatsData.filter(chat => !hiddenChatIds.includes(chat.id));
                    setChats(visibleChats.sort((a, b) => b.lastMessageTime.toMillis() - a.lastMessageTime.toMillis()));
                } catch (error) { console.error("Error loading user chats:", error); }
            };

            const loadChatMessages = async (chatId) => {
                try {
                    const messagesSnapshot = await window.getChatMessages(chatId);
                    const messagesData = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMessages(messagesData.sort((a, b) => a.timestamp.toMillis() - b.timestamp.toMillis()));
                } catch (error) { console.error("Error loading chat messages:", error); }
            };

            const handleStartChat = (userId, userNickname) => {
                const chatId = window.createChatId(currentUser.uid, userId);
                setSelectedChatId(chatId);
                setSelectedUser({ uid: userId, nickname: userNickname, suggestions: [] }); // Assume no suggestions initially
                setView('chat');
            };

            const handleSelectChat = (chat) => {
                setSelectedChatId(chat.id);
                setSelectedUser({ uid: chat.otherUserId, nickname: chat.otherUserNickname, suggestions: chat.otherUserSuggestions });
                setView('chat');
            };

            const handleSendMessage = async () => {
                if (!messageInput.trim() || !selectedChatId || isLoading) return;
                setIsLoading(true);
                try {
                    await window.sendChatMessage(selectedChatId, currentUser.uid, messageInput.trim(), selectedUser.uid);
                    setMessageInput('');
                    await loadChatMessages(selectedChatId);
                    await loadUserChats();
                } catch (error) { console.error("Error sending message:", error); window.showToast("Errore nell'invio del messaggio");
                } finally { setIsLoading(false); }
            };

            const handleKeyPress = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } };

            const formatMessageTime = (timestamp) => {
                if (timestamp?.toDate) return timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (typeof timestamp === 'number') return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return '...';
            };
            
            if (view === 'list') {
                const filteredChats = chats.filter(chat => chat.otherUserNickname?.toLowerCase().includes(chatSearchTerm.toLowerCase()));
                return (
                    <div className="user-chat-container">
                        <div className="user-chat-header">
                            <div id="profile-avatar-menu" style={{ marginLeft: 8 }}><span dangerouslySetInnerHTML={{ __html: globalControlsHTML.avatar }} /></div>
                            <div className="user-chat-info" style={{ flexGrow: 1 }}><h3>{language === 'it' ? 'Le tue chat' : 'Your chats'}</h3></div>
                            <div id="global-controls" dangerouslySetInnerHTML={{ __html: globalControlsHTML.otherControls }}></div>
                        </div>
                        <div className="chat-search-container">
                            <input type="text" className="chat-search-input" placeholder={language === 'it' ? 'Cerca per nickname...' : 'Search by nickname...'} value={chatSearchTerm} onChange={(e) => setChatSearchTerm(e.target.value)} />
                        </div>
                        <div className="user-chat-list">
                            {filteredChats.length === 0 ? (<div id="empty-state">{language === 'it' ? 'Nessuna chat trovata.' : 'No chats found.'}</div>) : (
                                filteredChats.map(chat => (
                                    <div key={chat.id} className="user-chat-item" onClick={() => handleSelectChat(chat)}>
                                        {/* MODIFICA: Aggiunto onClick all'avatar */}
                                        <div className="user-chat-item-avatar" onClick={(e) => handleViewSuggestions(e, chat.otherUserId, chat.otherUserNickname)} title={language === 'it' ? 'Vedi suggerimenti' : 'View suggestions'}>
                                            {chat.otherUserNickname ? chat.otherUserNickname.charAt(0).toUpperCase() : 'U'}
                                        </div>
                                        {/* MODIFICA: Aggiunto onClick all'info e mostrato il conteggio suggerimenti */}
                                        <div className="user-chat-item-info" onClick={(e) => handleViewSuggestions(e, chat.otherUserId, chat.otherUserNickname)} title={language === 'it' ? 'Vedi suggerimenti' : 'View suggestions'}>
                                            <div className="user-chat-item-name">{chat.otherUserNickname || 'Utente'}</div>
                                            <div className="user-chat-item-preview">{`${chat.lastMessage} ‚Ä¢ ${chat.otherUserSuggestions.length} ${language === 'it' ? 'sugg.' : 'sugg.'}`}</div>
                                        </div>
                                        <div className="user-chat-item-meta">
                                            <div className="user-chat-item-time">{formatMessageTime(chat.lastMessageTime)}</div>
                                            <button className="user-chat-item-delete-btn" onClick={(e) => handleHideChat(e, chat.id)} title={language === 'it' ? 'Nascondi chat' : 'Hide chat'}>
                                                <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                        <button className="floating-action-btn" onClick={() => setView('search')} title={language === 'it' ? 'Nuova chat' : 'New chat'}>
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-5 9h-4v4h-2v-4H5V9h4V5h2v4h4v2z"/></svg>
                        </button>
                    </div>
                );
            }
            
            if (view === 'search') {
                return (
                    <div className="user-chat-container">
                        <div className="user-chat-header">
                            <button className="user-chat-back-btn" onClick={() => setView('list')}><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                            <div className="user-chat-info"><h3>{language === 'it' ? 'Nuova Chat' : 'New Chat'}</h3></div>
                            <div id="global-controls" dangerouslySetInnerHTML={{ __html: globalControlsHTML.otherControls }}></div>
                        </div>
                        <div style={{ padding: '16px' }}><input type="text" className="user-chat-input" style={{ borderRadius: '12px', minHeight: 'auto', maxHeight: 'none', lineHeight: '1.5' }} placeholder={language === 'it' ? 'Cerca utente per nickname...' : 'Search user by nickname...'} onInput={(e) => window.searchUsersForChat(e.target.value, currentUser.uid)} autoFocus /></div>
                        <div id="user-chat-search-results" style={{ padding: '0 16px', overflowY: 'auto', flex: 1 }}></div>
                    </div>
                );
            }

            return (
                <div className="user-chat-container">
                    {/* MODIFICA: Aggiunto onClick all'header della chat */}
                    <div className="user-chat-header" style={{cursor: 'pointer'}} onClick={(e) => handleViewSuggestions(e, selectedUser.uid, selectedUser.nickname)} title={language === 'it' ? 'Vedi suggerimenti' : 'View suggestions'}>
                        <button className="user-chat-back-btn" onClick={(e) => { e.stopPropagation(); setView('list'); }}><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                        <div className="user-chat-avatar">{selectedUser?.nickname ? selectedUser.nickname.charAt(0).toUpperCase() : 'U'}</div>
                        <div className="user-chat-info"><h3>{selectedUser?.nickname || 'Utente'}</h3></div>
                        <div id="global-controls" dangerouslySetInnerHTML={{ __html: globalControlsHTML.otherControls }} onClick={(e) => e.stopPropagation() /* Evita che il click sui controlli apra i suggerimenti */}></div>
                    </div>
                    <div className="user-chat-messages">
                        {messages.map(message => (<div key={message.id} className={`user-chat-message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`}><div>{message.text}</div><div className="user-chat-message-time">{formatMessageTime(message.timestamp)}</div></div>))}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="user-chat-input-container">
                        <textarea className="user-chat-input" value={messageInput} onChange={(e) => setMessageInput(e.target.value)} onKeyDown={handleKeyPress} placeholder={language === 'it' ? 'Scrivi un messaggio...' : 'Write a message...'} disabled={isLoading} />
                        <button className="user-chat-send-btn" onClick={handleSendMessage} disabled={isLoading || !messageInput.trim()}><svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                    </div>
                </div>
            );
        };
            // **NUOVO:** Crea un "ponte" per aggiornare la lingua dall'esterno
            useEffect(() => {
                window.updateUserChatLanguage = (newLang) => {
                    setLanguage(newLang);
                };
                // Pulisce la funzione globale quando il componente viene smontato
                return () => {
                    delete window.updateUserChatLanguage;
                };
            }, []); // L'array vuoto assicura che questo effetto venga eseguito solo una volta

            useEffect(() => {
                if (currentUser.uid) {
                    loadUserChats();
                }
                window.handleReactChatStart = handleStartChat;
            }, [currentUser.uid]);

            useEffect(() => {
                if (selectedChatId) {
                    loadChatMessages(selectedChatId);
                }
            }, [selectedChatId]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const getHiddenChatIds = () => {
                const hidden = localStorage.getItem(`hidden_chats_${currentUser.uid}`);
                return hidden ? JSON.parse(hidden) : [];
            };

            const handleHideChat = (e, chatId) => {
                e.stopPropagation();
                const hiddenIds = getHiddenChatIds();
                if (!hiddenIds.includes(chatId)) {
                    const newHiddenIds = [...hiddenIds, chatId];
                    localStorage.setItem(`hidden_chats_${currentUser.uid}`, JSON.stringify(newHiddenIds));
                    setChats(prevChats => prevChats.filter(chat => chat.id !== chatId));
                }
            };

            const loadUserChats = async () => {
                try {
                    const hiddenChatIds = getHiddenChatIds();
                    const chatsData = await window.getUserChats(currentUser.uid);
                    const visibleChats = chatsData.filter(chat => !hiddenChatIds.includes(chat.id));
                    setChats(visibleChats.sort((a, b) => b.lastMessageTime - a.lastMessageTime));
                } catch (error) {
                    console.error("Error loading user chats:", error);
                }
            };

            const loadChatMessages = async (chatId) => {
                try {
                    const messagesSnapshot = await window.getChatMessages(chatId);
                    const messagesData = [];
                    messagesSnapshot.forEach(doc => {
                        messagesData.push({ id: doc.id, ...doc.data() });
                    });
                    setMessages(messagesData.sort((a, b) => a.timestamp.toMillis() - b.timestamp.toMillis()));
                } catch (error) {
                    console.error("Error loading chat messages:", error);
                }
            };

            const handleStartChat = (userId, userNickname) => {
                const chatId = window.createChatId(currentUser.uid, userId);
                setSelectedChatId(chatId);
                setSelectedUser({ uid: userId, nickname: userNickname });
                setView('chat');
            };

            const handleSelectChat = (chat) => {
                setSelectedChatId(chat.id);
                const otherUserId = chat.participants.find(uid => uid !== currentUser.uid);
                setSelectedUser({ uid: otherUserId, nickname: chat.otherUserNickname });
                setView('chat');
            };

            const handleSendMessage = async () => {
                if (!messageInput.trim() || !selectedChatId || isLoading) return;
                setIsLoading(true);
                try {
                    await window.sendChatMessage(selectedChatId, currentUser.uid, messageInput.trim(), selectedUser.uid);
                    setMessageInput('');
                    await loadChatMessages(selectedChatId);
                    await loadUserChats();
                } catch (error) {
                    console.error("Error sending message:", error);
                    window.showToast("Errore nell'invio del messaggio");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            const formatMessageTime = (timestamp) => {
                if (timestamp && typeof timestamp.toDate === 'function') {
                    const date = timestamp.toDate();
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                if (typeof timestamp === 'number') {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                return '...';
            };
            
            // **MODIFICA:** Usa lo stato locale `language` invece della prop `lang` per i testi
            if (view === 'list') {
                // NUOVA LOGICA DI FILTRAGGIO
                const filteredChats = chats.filter(chat => 
                    chat.otherUserNickname?.toLowerCase().includes(chatSearchTerm.toLowerCase())
                );

                return (
                    <div className="user-chat-container">
                        <div className="user-chat-header">
                            <div id="profile-avatar-menu" style={{ marginLeft: 8 }}>
                                <span dangerouslySetInnerHTML={{ __html: globalControlsHTML.avatar }} />
                            </div>
                            <div className="user-chat-info" style={{ flexGrow: 1 }}>
                                <h3>{language === 'it' ? 'Le tue chat' : 'Your chats'}</h3>
                            </div>
                            <div id="global-controls" dangerouslySetInnerHTML={{ __html: globalControlsHTML.otherControls }}></div>
                        </div>

                        {/* NUOVA BARRA DI RICERCA */}
                        <div className="chat-search-container">
                            <input 
                                type="text"
                                className="chat-search-input"
                                placeholder={language === 'it' ? 'Cerca per nickname...' : 'Search by nickname...'}
                                value={chatSearchTerm}
                                onChange={(e) => setChatSearchTerm(e.target.value)}
                            />
                        </div>

                        <div className="user-chat-list">
                            {filteredChats.length === 0 ? (
                                <div id="empty-state">
                                    {language === 'it' ? 'Nessuna chat trovata.' : 'No chats found.'}
                                </div>
                            ) : (
                                filteredChats.map(chat => (
                                    <div key={chat.id} className="user-chat-item" onClick={() => handleSelectChat(chat)}>
                                        <div className="user-chat-item-avatar">
                                            {chat.otherUserNickname ? chat.otherUserNickname.charAt(0).toUpperCase() : 'U'}
                                        </div>
                                        <div className="user-chat-item-info">
                                            <div className="user-chat-item-name">{chat.otherUserNickname || 'Utente'}</div>
                                            <div className="user-chat-item-preview">{chat.lastMessage}</div>
                                        </div>
                                        <div className="user-chat-item-meta">
                                            <div className="user-chat-item-time">
                                                {formatMessageTime(chat.lastMessageTime)}
                                            </div>
                                            <button 
                                                className="user-chat-item-delete-btn" 
                                                onClick={(e) => handleHideChat(e, chat.id)}
                                                title={language === 'it' ? 'Nascondi chat' : 'Hide chat'}
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18" fill="currentColor">
                                                    <path d="M0 0h24v24H0z" fill="none"/>
                                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                        
                        <button 
                            className="floating-action-btn" 
                            onClick={() => setView('search')} 
                            title={language === 'it' ? 'Nuova chat' : 'New chat'}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-5 9h-4v4h-2v-4H5V9h4V5h2v4h4v2z"/></svg>
                        </button>
                    </div>
                );
            }
            
            if (view === 'search') {
                return (
                    <div className="user-chat-container">
                        <div className="user-chat-header">
                            <button className="user-chat-back-btn" onClick={() => setView('list')}>
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                            </button>
                            <div className="user-chat-info">
                                <h3>{language === 'it' ? 'Nuova Chat' : 'New Chat'}</h3>
                            </div>
                            <div id="global-controls" dangerouslySetInnerHTML={{ __html: globalControlsHTML.otherControls }}></div>
                        </div>
                        <div style={{ padding: '16px' }}>
                             <input
                                type="text"
                                className="user-chat-input"
                                style={{ borderRadius: '12px', minHeight: 'auto', maxHeight: 'none', lineHeight: '1.5' }}
                                placeholder={language === 'it' ? 'Cerca utente per nickname...' : 'Search user by nickname...'}
                                onInput={(e) => window.searchUsersForChat(e.target.value, currentUser.uid)}
                                autoFocus
                            />
                        </div>
                        <div id="user-chat-search-results" style={{ padding: '0 16px', overflowY: 'auto', flex: 1 }}></div>
                    </div>
                );
            }

            return (
                <div className="user-chat-container">
                    <div className="user-chat-header">
                        <button className="user-chat-back-btn" onClick={() => setView('list')}>
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                        </button>
                        <div className="user-chat-avatar">{selectedUser?.nickname ? selectedUser.nickname.charAt(0).toUpperCase() : 'U'}</div>
                        <div className="user-chat-info"><h3>{selectedUser?.nickname || 'Utente'}</h3></div>
                        <div id="global-controls" dangerouslySetInnerHTML={{ __html: globalControlsHTML.otherControls }}></div>
                    </div>
                    <div className="user-chat-messages">
                        {messages.map(message => (
                            <div key={message.id} className={`user-chat-message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`}>
                                <div>{message.text}</div>
                                <div className="user-chat-message-time">{formatMessageTime(message.timestamp)}</div>
                            </div>
                        ))}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className="user-chat-input-container">
                        <textarea
                            className="user-chat-input"
                            value={messageInput}
                            onChange={(e) => setMessageInput(e.target.value)}
                            onKeyDown={handleKeyPress}
                            placeholder={language === 'it' ? 'Scrivi un messaggio...' : 'Write a message...'}
                            disabled={isLoading}
                        />
                        <button className="user-chat-send-btn" onClick={handleSendMessage} disabled={isLoading || !messageInput.trim()}>
                            <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
            );
        };

        // Funzione globale per montare l'app di chat utente
        window.mountUserChatApp = (container, props) => {
            const root = ReactDOMClient.createRoot(container);
            root.render(<React.StrictMode><UserChatApp {...props} /></React.StrictMode>);
            return root;
        };

        // Espone il componente UserChatApp per poterlo ri-renderizzare dall'esterno
        window.UserChatApp = UserChatApp;

        // Esporre la funzione per iniziare una chat
        window.startUserChat = (userId, userNickname) => {
            if (window.userChatAppInstance) {
                window.userChatAppInstance.handleStartChat(userId, userNickname);
            }
        };
    </script>

    <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection, query, where, getDocs, addDoc, serverTimestamp, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDLouTZcRN28riyxBY06XYkWCsGkYbYm-o",
      authDomain: "n8n-riccardo-29-aprile.firebaseapp.com",
      projectId: "n8n-riccardo-29-aprile",
      storageBucket: "n8n-riccardo-29-aprile.firebaseapp.com",
      messagingSenderId: "785683001992",
      appId: "1:785683001992:web:d24e375041fb7c0f18653d",
      measurementId: "G-B78J4HK2NX"
    };

    // --- FIREBASE INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- FUNZIONI PER LA CHAT UTENTE-UTENTE ---
    
    // Crea un ID univoco per una chat tra due utenti
    const createChatId = (userId1, userId2) => {
        return [userId1, userId2].sort().join('_');
    };

    // Crea o recupera una chat tra due utenti
    const getOrCreateChat = async (userId1, userId2) => {
        const chatId = createChatId(userId1, userId2);
        const chatRef = doc(db, 'userChats', chatId);
        const chatDoc = await getDoc(chatRef);
        
        if (!chatDoc.exists()) {
            // Recupera i nickname degli utenti
            const user1Doc = await getDoc(doc(db, 'users', userId1));
            const user2Doc = await getDoc(doc(db, 'users', userId2));
            
            const user1Nickname = user1Doc.exists() ? user1Doc.data().nickname : 'Utente';
            const user2Nickname = user2Doc.exists() ? user2Doc.data().nickname : 'Utente';
            
            await setDoc(chatRef, {
                participants: [userId1, userId2],
                lastMessage: '',
                lastMessageTime: serverTimestamp(),
                user1Nickname: user1Nickname,
                user2Nickname: user2Nickname,
                createdAt: serverTimestamp()
            });
        }
        
        return chatId;
    };

    // Invia un messaggio in una chat
    const sendChatMessage = async (chatId, senderId, text, receiverId) => {
        const messagesRef = collection(db, 'userChats', chatId, 'messages');
        const messageData = {
            senderId: senderId,
            text: text,
            timestamp: serverTimestamp(),
            read: false
        };
        
        await addDoc(messagesRef, messageData);
        
        // Aggiorna l'ultimo messaggio nella chat
        const chatRef = doc(db, 'userChats', chatId);
        await updateDoc(chatRef, {
            lastMessage: text,
            lastMessageTime: serverTimestamp()
        });
    };

    // Recupera i messaggi di una chat
    const getChatMessages = async (chatId) => {
        const messagesRef = collection(db, 'userChats', chatId, 'messages');
        const q = query(messagesRef, orderBy('timestamp', 'desc'), limit(50));
        return await getDocs(q);
    };

    // Recupera tutte le chat di un utente
    const getUserChats = async (userId) => {
        const chatsRef = collection(db, 'userChats');
        const q = query(chatsRef, where('participants', 'array-contains', userId));
        const chatsSnapshot = await getDocs(q);

        // NUOVA MODIFICA: Usiamo Promise.all per recuperare i dati dell'altro utente in parallelo
        const chatPromises = chatsSnapshot.docs.map(async (chatDoc) => {
            const data = chatDoc.data();
            const otherUserId = data.participants.find(id => id !== userId);
            
            if (otherUserId) {
                const userDocRef = doc(db, "users", otherUserId);
                const userDocSnap = await getDoc(userDocRef);
                const otherUserData = userDocSnap.exists() ? userDocSnap.data() : { aiSuggestions: [], nickname: 'Utente Sconosciuto' };

                return {
                    id: chatDoc.id,
                    ...data,
                    otherUserId: otherUserId,
                    otherUserNickname: otherUserData.nickname || (data.participants[0] === userId ? data.user2Nickname : data.user1Nickname),
                    otherUserSuggestions: otherUserData.aiSuggestions || [] // Aggiungiamo i suggerimenti dell'altro utente
                };
            }
            return null; // Ritorna null se non c'√® un altro utente (improbabile)
        });

        const chats = (await Promise.all(chatPromises)).filter(Boolean); // Filtra eventuali risultati null
        
        return chats;
    };

    // Espone le funzioni globalmente
    window.createChatId = createChatId;
    window.getOrCreateChat = getOrCreateChat;
    window.sendChatMessage = sendChatMessage;
    window.getChatMessages = getChatMessages;
    window.getUserChats = getUserChats;

    document.addEventListener('DOMContentLoaded', () => {
    
        // --- LOGICA DI TRADUZIONE ---
        const translations = {
            it: {
                // Auth
                createAccount: "Crea il tuo account", registerEmailLabel: "Email", registerEmailPlaceholder: "nome@esempio.com",
                registerPasswordLabel: "Password", registerPasswordPlaceholder: "Minimo 6 caratteri", registerButton: "Registrati",
                switchToLogin: "Hai gi√† un account? Accedi", loginTitle: "Accedi", loginButton: "Accedi",
                switchToRegister: "Non hai un account? Registrati", forgotPasswordLink: "Password dimenticata?",
                resetPasswordTitle: "Reimposta Password", resetPasswordInfo: "Inserisci la tua email e ti invieremo un link per reimpostare la password.",
                sendLinkButton: "Invia Link", backToLogin: "Torna al Login",
                passwordResetSent: "Se l'utente esiste, un link per il reset √® stato inviato a %s.",
                // App
                navHome: "Home", navTopAI: "TOP AI", navSearch: "Cerca", navSearchUsers: "Utenti", navUserChats: "Chat", navLibrary: "Libreria",
                pageTitleHome: "Koda.AI Chatbot", pageTitleTopAI: "TOP AI", pageTitleSearch: "Cerca", pageTitleSearchUsers: "Utenti", pageTitleUserChats: "Chat Utenti", pageTitleLibrary: "La tua libreria",
                logout: "Logout", featured: "In evidenza", rankingsTitle: "Classifiche TOP AI", filterAll: "Tutti",
                searchPlaceholder: "Cerca strumenti, categorie...", browseAll: "Sfoglia tutto", browseByOrigin: "Sfoglia per nazionalit√†",
                backToSearch: "‚Äπ Torna a cercare", toolsFrom: "Strumenti da", libraryPromptTitle: "Salva i tuoi preferiti",
                libraryPromptText: "Accedi o registrati per salvare i preferiti.", emptyFavorites: "Nessun preferito trovato. Aggiungine qualcuno!",
                noResultsFor: "Nessun risultato per",
                // Rankings
                rankingTextTitle: "Classifica per il Testo", rankingCodeTitle: "Classifica per il Codice",
                rankingImagesTitle: "Classifica per le Immagini", rankingWebSearchTitle: "Classifica per la Ricerca Web",
                // Modal
                detailModalRemoveFavorite: "Rimuovi dai Preferiti", detailModalAddFavorite: "Aggiungi ai Preferiti",
                visitWebsite: "Visita Sito Web", alternativeSuggestion: "In alternativa prova:",
                 // Settings Modal
                settingsTitle: "Impostazioni account", changePasswordTitle: "Cambia password", newPasswordLabel: "Nuova password",
                newPasswordPlaceholder: "Minimo 6 caratteri", confirmPasswordLabel: "Conferma password", confirmPasswordPlaceholder: "Reinserisci la Nuova password",
                savePasswordButton: "Salva Password", passwordUpdateSuccess: "Password aggiornata con successo!",
                passwordTooShort: "La password deve contenere almeno 6 caratteri.", passwordsDoNotMatch: "Le password non coincidono.",
                updatePasswordError: "Errore: %s. Potrebbe essere necessario effettuare nuovamente il login.",
                // Side Menu
                history: "Cronologia", newChat: "Nuova chat", deleteAll: "Elimina tutto",
                confirmDeleteAll: "Sei sicuro di voler eliminare tutte le conversazioni? Questa azione √® irreversibile.",
                newChatTitle: "Nuova chat",
                // New Privileged User Translations (Local Storage)
                privilegedUnlocked: "Modalit√† privilegiata sbloccata!",
                addCustomApp: "Aggiungi App Custom", // New translation for the button
                addAppTitle: "Aggiungi Nuova App",
                appNameLabel: "Nome App", appNamePlaceholder: "Es. La mia AI fantastica",
                appDescriptionLabel: "Descrizione", appDescriptionPlaceholder: "Breve descrizione dell'app...",
                appWebsiteLabel: "Link Sito Web", appWebsitePlaceholder: "https://tuasito.com",
                appLogoLabel: "Logo (File Immagine)", // Updated label for file input
                addAppButton: "Aggiungi App",
                addAppSuccess: "App aggiunta con successo!",
                addAppError: "Errore nell'aggiunta dell'app: %s",
                markAsFeatured: "Segna come In evidenza",
                unmarkAsFeatured: "Rimuovi da In evidenza",
                featuredByYou: "In evidenza",
                emptyUserFeatured: "Nessuna app segnata come In evidenza.", // Keeping translation key but not used in UI
                emptyUserTools: "Nessuna app aggiunta da te.",
                appNameRequired: "Il nome dell'app √® obbligatorio.",
                appWebsiteRequired: "Il link del sito web √® obbligatorio.",
                appLogoRequired: "Il logo √® obbligatorio.", // Updated required message
                category: "Categoria", // Added missing category translation
                replaceFeaturedTitle: "Sostituisci AI In evidenza", // New translation
                selectAppToFeature: "Seleziona un'app dalla tua libreria per metterla In evidenza:", // New translation
                noUserApps: "Non hai ancora aggiunto app custom.", // New translation
                removeFeaturedReplacement: "Rimuovi Sostituzione", // New translation
                removeUserTool: "Rimuovi App Custom", // New translation for removing user tools
                registerNicknameLabel: "Nickname",
                registerNicknamePlaceholder: "Es. Koda",
                nicknameRequired: "Il nickname √® obbligatorio.",
                changeNicknameTitle: "Cambia nickname",
                saveNicknameButton: "Salva Nickname",
                nicknameUpdateSuccess: "Nickname aggiornato con successo!",
                aiSuggestionsTitle: "I tuoi suggerimenti AI",
                addAiSuggestionTitle: "Aggiungi Suggerimento AI",
                aiSuggestionLabel: "Suggerimento AI",
                aiSuggestionPlaceholder: "Scrivi il tuo suggerimento per un'AI...",
                selectCategory: "Seleziona categoria",
                selectCountry: "Seleziona paese",
                cancel: "Annulla",
                allFieldsRequired: "Tutti i campi sono obbligatori",
                addAiSuggestionButton: "Aggiungi Suggerimento",
                removeAiSuggestion: "Rimuovi suggerimento",
                aiSuggestionAdded: "Suggerimento aggiunto con successo!",
                aiSuggestionRemoved: "Suggerimento rimosso con successo!",
                searchUsersTitle: "Utenti",
                searchUsersSubtitle: "Trova altri utenti e scopri i loro suggerimenti AI",
                searchUsersPlaceholder: "Cerca per nickname o email...",
                searchUsersButton: "Cerca",
                noUsersFound: "Nessun utente trovato.",
                userSuggestionsTitle: "Suggerimenti di %s",
                viewSuggestions: "Vedi Suggerimenti",
                noSuggestions: "Nessun suggerimento disponibile.",
                suggestion: "suggerimento",
                suggestions: "suggerimenti",
                startChat: "Inizia Chat",
                chatWith: "Chatta con %s",
                hideChat: "Nascondi chat",
                noChatsFound: "Nessuna chat trovata. Inizia una nuova conversazione.",
                writeMessage: "Scrivi un messaggio...",
                sendError: "Errore nell'invio del messaggio",
            },
            en: {
                // Auth
                createAccount: "Create Your Account", registerEmailLabel: "Email", registerEmailPlaceholder: "name@example.com",
                registerPasswordLabel: "Password", registerPasswordPlaceholder: "Minimum 6 characters", registerButton: "Sign Up",
                switchToLogin: "Already have an account? Log In", loginTitle: "Log In", loginButton: "Log In",
                switchToRegister: "Don't have an account? Sign Up", forgotPasswordLink: "Forgot password?",
                resetPasswordTitle: "Reset Password", resetPasswordInfo: "Enter your email and we'll send you a link to reset your password.",
                sendLinkButton: "Send Link", backToLogin: "Back to Login",
                passwordResetSent: "If the user exists, a reset link has been sent to %s.",
                // App
                navHome: "Home", navTopAI: "TOP AI", navSearch: "Search", navSearchUsers: "Users", navUserChats: "Chats", navLibrary: "Library",
                pageTitleHome: "Koda.AI Chatbot", pageTitleTopAI: "TOP AI", pageTitleSearch: "Search", pageTitleSearchUsers: "Search Users", pageTitleUserChats: "User Chats", pageTitleLibrary: "Your Library",
                logout: "Logout", featured: "Featured", rankingsTitle: "TOP AI Rankings", filterAll: "All",
                searchPlaceholder: "Search tools, categories...", browseAll: "Browse All", browseByOrigin: "Browse by County",
                backToSearch: "‚Äπ Back to search", toolsFrom: "Tools from", libraryPromptTitle: "Save your favorites",
                libraryPromptText: "Log in or sign up to save your favorites.", emptyFavorites: "No favorites found. Add some!",
                noResultsFor: "No results for",
                // Rankings
                rankingTextTitle: "Ranking for Text", rankingCodeTitle: "Ranking for Code",
                rankingImagesTitle: "Ranking for Images", rankingWebSearchTitle: "Ranking for Web Search",
                // Modal
                detailModalRemoveFavorite: "Remove from Favorites", detailModalAddFavorite: "Add to Favorites",
                visitWebsite: "Visit Website", alternativeSuggestion: "Alternatively, try:",
                // Settings Modal
                settingsTitle: "Account Settings", changePasswordTitle: "Change Password", newPasswordLabel: "New Password",
                newPasswordPlaceholder: "Minimum 6 characters", confirmPasswordLabel: "Confirm Password", confirmPasswordPlaceholder: "Re-enter new password",
                savePasswordButton: "Save Password", passwordUpdateSuccess: "Password updated successfully!",
                passwordTooShort: "Password must be at least 6 characters long.", passwordsDoNotMatch: "Passwords do not match.",
                updatePasswordError: "Error: %s. You might need to log in again.",
                // Side Menu
                history: "History", newChat: "New Chat", deleteAll: "Delete All",
                confirmDeleteAll: "Are you sure you want to delete all conversations? This action is irreversible.",
                newChatTitle: "New Chat",
                 // New Privileged User Translations (Local Storage)
                privilegedUnlocked: "Privileged mode unlocked!",
                addCustomApp: "Add Custom App", // New translation for the button
                addAppTitle: "Add New App",
                appNameLabel: "App Name", appNamePlaceholder: "Ex. My Awesome AI",
                appDescriptionLabel: "Description", appDescriptionPlaceholder: "Brief description of the app...",
                appWebsiteLabel: "Website Link", appWebsitePlaceholder: "https://yourwebsite.com",
                appLogoLabel: "Logo (Image File)", // Updated label for file input
                addAppButton: "Add App",
                addAppSuccess: "App added successfully!",
                addAppError: "Error adding app: %s",
                markAsFeatured: "Mark as Featured",
                unmarkAsFeatured: "Unmark as Featured",
                featuredByYou: "Featured by You",
                emptyUserFeatured: "No apps marked as Featured by you.", // Keeping translation key but not used in UI
                emptyUserTools: "No apps added by you.",
                appNameRequired: "App name is required.",
                appWebsiteRequired: "Website link is required.",
                appLogoRequired: "Logo is required.", // Updated required message
                category: "Category", // Added missing category translation
                replaceFeaturedTitle: "Replace Featured AI", // New translation
                selectAppToFeature: "Select an app from your library to feature it:", // New translation
                noUserApps: "You haven't added any custom apps yet.", // New translation
                removeFeaturedReplacement: "Remove Replacement", // New translation
                removeUserTool: "Remove Custom App", // New translation for removing user tools
                registerNicknameLabel: "Nickname",
                registerNicknamePlaceholder: "Ex. Koda",
                nicknameRequired: "Nickname is required.",
                changeNicknameTitle: "Change Nickname",
                saveNicknameButton: "Save Nickname",
                nicknameUpdateSuccess: "Nickname updated successfully!",
                aiSuggestionsTitle: "Your AI Suggestions",
                addAiSuggestionTitle: "Add AI Suggestion",
                aiSuggestionLabel: "AI Suggestion",
                aiSuggestionPlaceholder: "Write your AI suggestion...",
                selectCategory: "Select category",
                selectCountry: "Select country",
                cancel: "Cancel",
                allFieldsRequired: "All fields are required",
                addAiSuggestionButton: "Add Suggestion",
                removeAiSuggestion: "Remove suggestion",
                aiSuggestionAdded: "Suggestion added successfully!",
                aiSuggestionRemoved: "Suggestion removed successfully!",
                searchUsersTitle: "Search Users",
                searchUsersSubtitle: "Find other users and discover their AI suggestions",
                searchUsersPlaceholder: "Search by nickname or email...",
                searchUsersButton: "Search",
                noUsersFound: "No users found.",
                userSuggestionsTitle: "Suggestions by %s",
                viewSuggestions: "View Suggestions",
                noSuggestions: "No suggestions available.",
                suggestion: "suggestion",
                suggestions: "suggestions",
                startChat: "Start Chat",
                chatWith: "Chat with %s",
                hideChat: "Hide chat",
                noChatsFound: "No chats found. Start a new conversation.",
                writeMessage: "Write a message...",
                sendError: "Error sending message",
            }
        };
        
        const applyTranslations = (lang) => {
            const t = translations[lang];
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (t[key]) {
                    if (el.placeholder) el.placeholder = t[key];
                    else el.textContent = t[key];
                }
            });
            // Re-render auth overlay content if visible to apply translations
            const authOverlay = document.getElementById('auth-overlay');
            if (authOverlay && authOverlay.style.display !== 'none') {
                 // Determine which card is currently visible
                let visibleCardId = 'login-card'; // Default
                if (authOverlay.querySelector('#register-card:not(.hidden)')) visibleCardId = 'register-card';
                else if (authOverlay.querySelector('#forgot-password-card:not(.hidden)')) visibleCardId = 'forgot-password-card';
                
                authOverlay.innerHTML = getAuthHTML(lang);
                attachAuthListeners(); // Re-attach listeners after innerHTML change
                showAuthCard(visibleCardId); // Show the previously visible card
            }
             // Re-render settings modal content if visible
            const settingsModal = document.getElementById('settings-modal');
            if (settingsModal && settingsModal.classList.contains('visible')) {
                 window.openSettingsModal(); // Re-open to regenerate content with new language
            }
             // Re-render add app modal content if visible
            const addAppModal = document.getElementById('add-app-modal');
            if (addAppModal && addAppModal.classList.contains('visible')) {
                 openAddAppModal(); // Re-open to regenerate content with new language
            }
             // Re-render replace featured modal content if visible
            const replaceFeaturedModal = document.getElementById('replace-featured-modal');
            if (replaceFeaturedModal && replaceFeaturedModal.classList.contains('visible')) {
                 // Need to know which static tool was being replaced to re-open correctly
                 // This requires storing the staticToolId when the modal is opened.
                 // For simplicity now, we'll just close it on language change.
                 closeModal(); 
            }
        };

        // --- DATABASE PERSONALIZZATO ---
        const aiToolsData = [
            { id: 'tool-001', name: 'ChatGPT', description: {it: 'Genera testo, immagini e risponde a domande con ricerca web.', en: 'Generates text, images, and answers questions with web search.'}, category: 'Testo', country: 'USA', website: 'https://chatgpt.com/', isFeatured: true, logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/04/ChatGPT_logo.svg/1024px-ChatGPT_logo.svg.png', recommendationId: 'tool-025' }, 
            { id: 'tool-012', name: 'Google Notebook', description: {it: "Permette di creare riassunti audio sulle fonti dell'utente, rispondere a domande e creare mappe mentali.", en: "Allows creating audio summaries from user sources, answering questions, and creating mind maps."}, category: 'Testo', country: 'USA', website: 'https://notebooklm.google.com/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRJbWdW2SCEWfJuDTh5PVxgmqDvXoX5vElJ6s94SZ8Fe1YPzfxzGPuIyE9cBMDswv3qUd4&usqp=CAU', recommendationId: 'tool-021' }, 
            { id: 'tool-013', name: 'Grok', description: {it: 'Assistente di ricerca conversazionale con accesso a dati in tempo reale. (Richiede VPN)', en: 'Conversational research assistant with real-time data access. (Requires VPN)'}, category: 'Testo', country: 'USA', website: 'https://grok.com/', isFeatured: false, logoUrl: 'https://i.namu.wiki/i/Wk8b-Vo4qqynLc4pN1T0otG83F383UPI_IR4VthZuZioAxVD_NS6uErIsecLMDK0F0L-KiUjL7xonRz4EwPL2g.webp', recommendationId: 'tool-001' }, 
            { id: 'tool-044', name: 'Perplexity', description: {it: 'Specializzata nella ricerca web, √® la migliore AI per trovare informazioni online.', en: 'Specialized in web search, it is the best AI for finding information online.'}, category: 'Testo', country: 'USA', website: 'https://www.perplexity.ai/', isFeatured: false, logoUrl: 'https://images.seeklogo.com/logo-png/51/2/perplexity-ai-logo-png_seeklogo-517845.png', recommendationId: 'tool-001' }, // Perplexity
            { id: 'tool-045', name: 'Deepseek', description: {it: 'Specializzata nella ricerca web, testi e programmazione.', en: 'Specialized in web search, text, and coding.'}, category: 'Testo', country: 'Cina', website: 'https://chat.deepseek.com/', isFeatured: false, logoUrl: 'data:image/png;base64,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' }, // Added Deepseek
            { id: 'tool-046', name: 'Qwen', description: {it: 'Specializzata nella ricerca web, testi e programmazione.', en: 'Specialized in web search, text, and coding.'}, category: 'Testo', country: 'Cina', website: 'https://chat.qwen.ai/', isFeatured: false, logoUrl: 'https://crystalpng.com/wp-content/uploads/2025/02/Qwen-03.png', recommendationId: 'tool-045' }, // Added Qwen
            { id: 'tool-062', name: 'Seeart', description: {it: 'Specializzata in immagini, video, animazioni e audio.', en: 'Specialized in images, videos, animations and audio.'}, category: 'Immagini', country: 'Cina', website: 'https://www.seaart.ai/it', isFeatured: false, logoUrl: 'https://play-lh.googleusercontent.com/BvytlaOWWEOrY0-VNThXm8xATNKZ_Vk_HgwSFXptkt3RRWgd9TF0J6JDED1bFlKyWkg', recommendationId: 'tool-014' }, // Added Seeart
            { id: 'tool-049', name: 'Copilot', description: {it: 'Specializzata in testi e ricerca web.', en: 'Specialized in text and web search.'}, category: 'Testo', country: 'USA', website: 'https://copilot.microsoft.com/chats/vAMUc1DGwXp5uX9uitvjF', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwqfCxHw2QW6DxEKqDayMoJTz4lrvE_nnurxpmg2mEmGAkOzjGmsVpKfwT6epVYInsAuc&usqp=CAU', recommendationId: 'tool-024' }, // Added Copilot
            { id: 'tool-050', name: 'ElevenLabs', description: {it: 'Genera voci realistiche e discorsi in diverse lingue.', en: 'Generates realistic voices and speech in various languages.'}, category: 'Audio', country: 'USA', website: 'https://elevenlabs.io/', isFeatured: false, logoUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcBAMAAACAI8KnAAAAFVBMVEX///+ZmZkZGRlZWVmRkZEAAABGRkb6Me63AAAAHElEQVR4AWMYUCBkwKyIxHVNYAsZVFyEIwcSAADWIQrDIppSoAAAAABJRU5ErkJggg==' }, // Added ElevenLabs
            { id: 'tool-014', name: 'FLUX', description: {it: 'Genera immagini, video e animazioni da prompt testuali e immagini.', en: 'Generates images, videos, and animations from text prompts and images.'}, category: 'Immagini', country: 'Cina', website: 'https://playground.bfl.ai/image/generate', isFeatured: false, logoUrl: 'https://kodexolabs.com/wp-content/uploads/2025/01/Flux.1.webp', recommendationId: 'tool-005' }, 
            { id: 'tool-015', name: 'Swap AI', description: {it: 'Esegue il "face swap" (scambio di volti) in immagini e video in modo realistico.', en: 'Performs realistic "face swap" in images and videos.'}, category: 'Immagini', country: 'USA', website: 'https://aifaceswap.io/', isFeatured: false, logoUrl: 'https://www.toolpilot.ai/cdn/shop/files/aifaceswap-l.jpg?v=1733037433', recommendationId: 'tool-016' }, 
            { id: 'tool-016', name: 'Inpaint AI', description: {it: 'Rimuove oggetti, persone o imperfezioni indesiderate dalle foto con un solo click.', en: 'Removes unwanted objects, people, or imperfections from photos with a single click.'}, category: 'Immagini', country: 'USA', website: 'https://theinpaint.com/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2CWmq3U9nnd7RqhhfyqjL-w6Lj-JUf1D9ow&s', recommendationId: 'tool-017' }, 
            { id: 'tool-017', name: 'Pixel Cut AI', description: {it: "Espande i bordi delle immagini (outpainting) per cambiare formato o stile.", en: 'Expands image borders (outpainting) to change format or style.'}, category: 'Immagini', country: 'USA', website: 'https://www.pixelcut.ai/t/uncrop', isFeatured: false, logoUrl: 'https://templateshake.com/wp-content/uploads/2021/09/Pixelcut_-AI-Graphic-Designer.png', recommendationId: 'tool-033' }, 
            { id: 'tool-041', name: 'Leonardo AI', description: {it: 'Piattaforma per la generazione di asset visivi di alta qualit√†, da concept art a texture per giochi.', en: 'Platform for generating high-quality visual assets, from concept art to game textures.'}, category: 'Immagini', country: 'USA', website: 'https://leonardo.ai/', isFeatured: false, logoUrl: 'https://yt3.googleusercontent.com/a04AUXisIIWkI-Pj5zORQTiDNS9tALLmPc8pxuRT_aEHrCOUDsPQoLuh4QRbfgICortk7tBhyg=s900-c-k-c0x00ffffff-no-rj', recommendationId: 'tool-014' }, 
            { id: 'tool-042', name: 'Midjourney', description: {it: 'Genera immagini artistiche e fotorealistiche di alta qualit√† da prompt testuali tramite Discord.', en: 'Generates high-quality artistic and fotorealistic images from text prompts via Discord.'}, category: 'Immagini', country: 'USA', website: 'https://www.midjourney.com/home', isFeatured: false, logoUrl: 'https://sadesign.ai/pictures/picfullsizes/2024/12/10/dsn1733795303.jpg', recommendationId: 'tool-041' }, 
            { id: 'tool-005', name: 'Whisk', description: {it: 'Genera immagini, video e animazioni da prompt testuali e immagini.', en: 'Generates images, videos, and animations from text prompts and images.'}, category: 'Immagini', country: 'USA', website: 'https://labs.google/fx/tools/whisk', isFeatured: false, logoUrl: 'https://artsology.com/blog/wp-content/uploads/2025/01/Iconic-Banksy-in-Manila-2025-01-17T161547.202.png' }, 
            { id: 'tool-034', name: 'Kling', description: {it: 'Genera video di alta qualit√† da prompt testuali, concentrandosi sul realismo e sul movimento complesso.', en: 'Generates high-quality videos from text prompts, focusing on realism and complex motion.'}, category: 'Video', country: 'Cina', website: 'https://klingai.com/global/', isFeatured: false, logoUrl: 'https://play-lh.googleusercontent.com/JOfjXqsShK8j1aGBc1xlHBnatoRKRwLsGuoFZUAvKksaEPvK71eLwSg4FbKlky9Es-s', recommendationId: 'tool-035' }, 
            { id: 'tool-035', name: 'Veo', description: {it: "Il modello di generazione video pi√π capace di Google, che crea video realistici e di alta qualit√† da prompt di testo e immagini.", en: "Google's most capable video generation model, creating realistic, high-quality videos from text and image prompts."}, category: 'Video', country: 'USA', website: 'https://deepmind.google/models/veo/', isFeatured: false, logoUrl: 'https://storage.googleapis.com/gweb-uniblog-publish-prod/images/IO25_Gemini_MOD_v33_PART_1_DG_FINAL_54.max-1440x810.png', isFeatured: false, recommendationId: 'tool-seedance' }, 
            { id: 'tool-021', name: 'Claude', description: {it: 'Specializzato in codice e creazione di applicazioni web. Pu√≤ anche scrivere testi e ricercare informazioni sul web.', en: 'Specialized in code and web app creation. Can also write text and search for information on the web.'}, category: 'Codice', country: 'USA', website: 'https://claude.ai/new', isFeatured: true, logoUrl: 'https://logo.svgcdn.com/l/claude-icon-8x.png', recommendationId: 'tool-022' }, 
            { id: 'tool-022', name: 'Gamma AI', description: {it: "Genera presentazioni, documenti e pagine web statiche partendo da un'idea.", en: 'Generates presentations, documents, and static web pages from an idea.'}, category: 'Presentazioni', country: 'USA', website: 'https://gamma.app/', isFeatured: false, logoUrl: 'https://www.fahimai.com/wp-content/uploads/2025/03/GAMMA-cta.png', recommendationId: 'tool-021' }, 
            { id: 'tool-023', name: 'Napkin AI', description: {it: 'Converte dati testuali e concetti in grafici statici e diagrammi chiari.', en: 'Converts text data and concepts into clear static charts and diagrams.'}, category: 'Presentazioni', country: 'USA', website: 'https://www.napkin.ai/', isFeatured: false, logoUrl: 'https://media.licdn.com/dms/image/v2/D560BAQEYfmQKrdByPg/company-logo_200_200/company-logo_200_200/0/1723039432148/napkin_ai_logo?e=2147483647&v=beta&t=Nsr22RG3uiy9usBNh55leGVf8ES5YJQwUANW-2N7yEA', recommendationId: 'tool-022' }, 
            { id: 'tool-024', name: 'Google AI Studio', description: {it: "Crea app, siti e prototipi basati sui modelli Gemini di Google.", en: "Creates apps, sites, and prototypes based on Google's Gemini models."}, category: 'Codice', country: 'USA', website: 'https://aistudio.google.com/prompts/new_chat', isFeatured: true, logoUrl: 'data:image/png;base64,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', recommendationId: 'tool-021' }, 
            { 
                id: 'tool-025', 
                name: 'Manus', 
                description: {it: 'Piattaforma di AI estremamente potente. Pu√≤ eseguire compiti come ChatGPT e gestirli in background, creando testi, ricerche, presentazioni, video, immagini e molto altro.', en: 'Extremely powerful AI platform. It can perform tasks like ChatGPT and manage them in the background, creating text, research, presentations, videos, images and much more.'}, category: 'Codice', country: 'Cina', website: 'https://manus.im/app', isFeatured: true, logoUrl: 'data:image/png;base64,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' },
            { 
                id: 'tool-043', 
                name: 'Rows', 
                description: { 
                    it: 'Specializzata in Excel, svolge il ruolo di analista dati utilizzando l\'AI direttamente dentro al foglio di Excel.', 
                    en: 'Specialized in Excel, acts as a data analyst using AI directly within the Excel sheet.' 
                }, 
                category: 'Testo', 
                country: 'Europe', 
                website: 'https://rows.com/ai', 
                isFeatured: false, 
                logoUrl: 'https://images.genai.works/Screenshot_16_5b63d7dfa1.jpg', 
                recommendationId: 'tool-049' 
            },
            { id: 'tool-047', name: 'Mistral', description: {it: 'Specializzata nella programmazione e nei testi.', en: 'Specialized in coding and text.'}, category: 'Codice', country: 'Europe', website: 'https://mistral.ai/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTJ-GF4yjk576hl_W3Z_JY3tVSKBkGHhXFfMA&s', recommendationId: 'tool-001' }, // Added Mistral
            { id: 'tool-048', name: 'bolt', description: {it: 'Specializzata nella programmazione e nei testi.', en: 'Specialized in coding and text.'}, category: 'Codice', country: 'USA', website: 'https://bolt.new/', isFeatured: false, logoUrl: 'https://cdn-1.webcatalog.io/catalog/bolt-new/bolt-new-icon-filled-256.png?v=1730692903154', recommendationId: 'tool-052' }, // Added bolt
            { id: 'tool-049', name: 'Copilot', description: {it: 'Specializzata in testi e ricerca web.', en: 'Specialized in text and web search.'}, category: 'Testo', country: 'USA', website: 'https://copilot.microsoft.com/chats/vAMUc1DGwXp5uX9uitvjF', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwqfCxHw2QW6DxEKqDayMoJTz4lrvE_nnurxpmg2mEmGAkOzjGmsVpKfwT6epVYInsAuc&usqp=CAU', recommendationId: 'tool-024' }, // Added Copilot
            { id: 'tool-050', name: 'ElevenLabs', description: {it: 'Genera voci realistiche e discorsi in diverse lingue.', en: 'Generates realistic voices and speech in various languages.'}, category: 'Audio', country: 'USA', website: 'https://elevenlabs.io/', isFeatured: false, logoUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcBAMAAACAI8KnAAAAFVBMVEX///+ZmZkZGRlZWVmRkZEAAABGRkb6Me63AAAAHElEQVR4AWMYUCBkwKyIxHVNYAsZVFyEIwcSAADWIQrDIppSoAAAAABJRU5ErkJggg==' }, // Added ElevenLabs
            { id: 'tool-014', name: 'FLUX', description: {it: 'Genera immagini, video e animazioni da prompt testuali e immagini.', en: 'Generates images, videos, and animations from text prompts and images.'}, category: 'Immagini', country: 'Cina', website: 'https://playground.bfl.ai/image/generate', isFeatured: false, logoUrl: 'https://kodexolabs.com/wp-content/uploads/2025/01/Flux.1.webp', recommendationId: 'tool-005' }, 
            { id: 'tool-015', name: 'Swap AI', description: {it: 'Esegue il "face swap" (scambio di volti) in immagini e video in modo realistico.', en: 'Performs realistic "face swap" in images and videos.'}, category: 'Immagini', country: 'USA', website: 'https://aifaceswap.io/', isFeatured: false, logoUrl: 'https://www.toolpilot.ai/cdn/shop/files/aifaceswap-l.jpg?v=1733037433', recommendationId: 'tool-016' }, 
            { id: 'tool-016', name: 'Inpaint AI', description: {it: 'Rimuove oggetti, persone o imperfezioni indesiderate dalle foto con un solo click.', en: 'Removes unwanted objects, people, or imperfections from photos with a single click.'}, category: 'Immagini', country: 'USA', website: 'https://theinpaint.com/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2CWmq3U9nnd7RqhhfyqjL-w6Lj-JUf1D9ow&s', recommendationId: 'tool-017' }, 
            { id: 'tool-017', name: 'Pixel Cut AI', description: {it: "Espande i bordi delle immagini (outpainting) per cambiare formato o stile.", en: 'Expands image borders (outpainting) to change format or style.'}, category: 'Immagini', country: 'USA', website: 'https://www.pixelcut.ai/t/uncrop', isFeatured: false, logoUrl: 'https://templateshake.com/wp-content/uploads/2021/09/Pixelcut_-AI-Graphic-Designer.png', recommendationId: 'tool-033' }, 
            { id: 'tool-041', name: 'Leonardo AI', description: {it: 'Piattaforma per la generazione di asset visivi di alta qualit√†, da concept art a texture per giochi.', en: 'Platform for generating high-quality visual assets, from concept art to game textures.'}, category: 'Immagini', country: 'USA', website: 'https://leonardo.ai/', isFeatured: false, logoUrl: 'https://yt3.googleusercontent.com/a04AUXisIIWkI-Pj5zORQTiDNS9tALLmPc8pxuRT_aEHrCOUDsPQoLuh4QRbfgICortk7tBhyg=s900-c-k-c0x00ffffff-no-rj', recommendationId: 'tool-014' }, 
            { id: 'tool-042', name: 'Midjourney', description: {it: 'Genera immagini artistiche e fotorealistiche di alta qualit√† da prompt testuali tramite Discord.', en: 'Generates high-quality artistic and fotorealistic images from text prompts via Discord.'}, category: 'Immagini', country: 'USA', website: 'https://www.midjourney.com/home', isFeatured: false, logoUrl: 'https://sadesign.ai/pictures/picfullsizes/2024/12/10/dsn1733795303.jpg', recommendationId: 'tool-041' }, 
            { id: 'tool-005', name: 'Whisk', description: {it: 'Genera immagini, video e animazioni da prompt testuali e immagini.', en: 'Generates images, videos, and animations from text prompts and images.'}, category: 'Immagini', country: 'USA', website: 'https://labs.google/fx/tools/whisk', isFeatured: false, logoUrl: 'https://artsology.com/blog/wp-content/uploads/2025/01/Iconic-Banksy-in-Manila-2025-01-17T161547.202.png' }, 
            { id: 'tool-034', name: 'Kling', description: {it: 'Genera video di alta qualit√† da prompt testuali, concentrandosi sul realismo e sul movimento complesso.', en: 'Generates high-quality videos from text prompts, focusing on realism and complex motion.'}, category: 'Video', country: 'Cina', website: 'https://klingai.com/global/', isFeatured: false, logoUrl: 'https://play-lh.googleusercontent.com/JOfjXqsShK8j1aGBc1xlHBnatoRKRwLsGuoFZUAvKksaEPvK71eLwSg4FbKlky9Es-s', recommendationId: 'tool-035' }, 
            { id: 'tool-035', name: 'Veo', description: {it: "Il modello di generazione video pi√π capace di Google, che crea video realistici e di alta qualit√† da prompt di testo e immagini.", en: "Google's most capable video generation model, creating realistic, high-quality videos from text and image prompts."}, category: 'Video', country: 'USA', website: 'https://deepmind.google/models/veo/', isFeatured: false, logoUrl: 'https://storage.googleapis.com/gweb-uniblog-publish-prod/images/IO25_Gemini_MOD_v33_PART_1_DG_FINAL_54.max-1440x810.png', isFeatured: false, recommendationId: 'tool-seedance' }, 
            { id: 'tool-021', name: 'Claude', description: {it: 'Specializzato in codice e creazione di applicazioni web. Pu√≤ anche scrivere testi e ricercare informazioni sul web.', en: 'Specialized in code and web app creation. Can also write text and search for information on the web.'}, category: 'Codice', country: 'USA', website: 'https://claude.ai/new', isFeatured: true, logoUrl: 'https://logo.svgcdn.com/l/claude-icon-8x.png', recommendationId: 'tool-022' }, 
            { id: 'tool-022', name: 'Gamma AI', description: {it: "Genera presentazioni, documenti e pagine web statiche partendo da un'idea.", en: 'Generates presentations, documents, and static web pages from an idea.'}, category: 'Presentazioni', country: 'USA', website: 'https://gamma.app/', isFeatured: false, logoUrl: 'https://www.fahimai.com/wp-content/uploads/2025/03/GAMMA-cta.png', recommendationId: 'tool-021' }, 
            { id: 'tool-023', name: 'Napkin AI', description: {it: 'Converte dati testuali e concetti in grafici statici e diagrammi chiari.', en: 'Converts text data and concepts into clear static charts and diagrams.'}, category: 'Presentazioni', country: 'USA', website: 'https://www.napkin.ai/', isFeatured: false, logoUrl: 'https://media.licdn.com/dms/image/v2/D560BAQEYfmQKrdByPg/company-logo_200_200/company-logo_200_200/0/1723039432148/napkin_ai_logo?e=2147483647&v=beta&t=Nsr22RG3uiy9usBNh55leGVf8ES5YJQwUANW-2N7yEA', recommendationId: 'tool-022' }, 
            { id: 'tool-024', name: 'Google AI Studio', description: {it: "Crea app, siti e prototipi basati sui modelli Gemini di Google.", en: "Creates apps, sites, and prototypes based on Google's Gemini models."}, category: 'Codice', country: 'USA', website: 'https://aistudio.google.com/prompts/new_chat', isFeatured: true, logoUrl: 'data:image/png;base64,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', recommendationId: 'tool-026' }, 
            { 
                id: 'tool-043', 
                name: 'Rows', 
                description: { 
                    it: 'Specializzata in Excel, svolge il ruolo di analista dati utilizzando l\'AI direttamente dentro al foglio di Excel.', 
                    en: 'Specialized in Excel, acts as a data analyst using AI directly within the Excel sheet.' 
                }, 
                category: 'Testo', 
                country: 'Europe', 
                website: 'https://rows.com/ai', 
                isFeatured: false, 
                logoUrl: 'https://images.genai.works/Screenshot_16_5b63d7dfa1.jpg', 
                recommendationId: 'tool-049' 
            },
            { id: 'tool-047', name: 'Mistral', description: {it: 'Specializzata nella programmazione e nei testi.', en: 'Specialized in coding and text.'}, category: 'Codice', country: 'Europe', website: 'https://mistral.ai/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTJ-GF4yjk576hl_W3Z_JY3tVSKBkGHhXFfMA&s', recommendationId: 'tool-001' }, // Added Mistral
            { id: 'tool-048', name: 'bolt', description: {it: 'Specializzata nella programmazione e nei testi.', en: 'Specialized in coding and text.'}, category: 'Codice', country: 'USA', website: 'https://bolt.new/', isFeatured: false, logoUrl: 'https://cdn-1.webcatalog.io/catalog/bolt-new/bolt-new-icon-filled-256.png?v=1730692903154', recommendationId: 'tool-052' }, // Added bolt
            { id: 'tool-049', name: 'Copilot', description: {it: 'Specializzata in testi e ricerca web.', en: 'Specialized in text and web search.'}, category: 'Testo', country: 'USA', website: 'https://copilot.microsoft.com/chats/vAMUc1DGwXp5uX9uitvjF', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwqfCxHw2QW6DxEKqDayMoJTz4lrvE_nnurxpmg2mEmGAkOzjGmsVpKfwT6epVYInsAuc&usqp=CAU', recommendationId: 'tool-024' }, // Added Copilot
            { id: 'tool-050', name: 'ElevenLabs', description: {it: 'Genera voci realistiche e discorsi in diverse lingue.', en: 'Generates realistic voices and speech in various languages.'}, category: 'Audio', country: 'USA', website: 'https://elevenlabs.io/', isFeatured: false, logoUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcBAMAAACAI8KnAAAAFVBMVEX///+ZmZkZGRlZWVmRkZEAAABGRkb6Me63AAAAHElEQVR4AWMYUCBkwKyIxHVNYAsZVFyEIwcSAADWIQrDIppSoAAAAABJRU5ErkJggg==' }, // Added ElevenLabs
            { id: 'tool-052', name: 'Cursor', description: {it: 'Un editor di codice potenziato dall\'AI per una programmazione pi√π veloce.', en: 'An AI-powered code editor for faster programming.'}, category: 'Codice', country: 'USA', website: 'https://cursor.com/', isFeatured: false, logoUrl: 'https://paulstamatiou.com/_next/image?url=%2Fgear%2Fcursor-app-icon.png&w=3840&q=75', recommendationId: 'tool-053' }, // Added Lovable
            { id: 'tool-053', name: 'Lovable', description: {it: 'AI per la programmazione e sviluppo di codice.', en: 'AI for coding and software development.'}, category: 'Codice', country: 'USA', website: 'https://lovable.dev/', isFeatured: false, logoUrl: 'https://miro.medium.com/v2/resize:fit:1400/1*8oWCX9tq3LPGxXqs7TRicg.png', recommendationId: 'tool-052' }, // Lovable
            { id: 'tool-054', name: 'Ideogram', description: {it: 'AI per la generazione di immagini creative e artistiche.', en: 'AI for creative and artistic image generation.'}, category: 'Immagini', country: 'USA', website: 'https://ideogram.ai/t/explore', isFeatured: false, logoUrl: 'https://www.fahimai.com/wp-content/uploads/2024/03/CTA-4.png', recommendationId: 'tool-056' }, // Ideogram
            { id: 'tool-055', name: 'Sora', description: {it: 'AI per la generazione di video avanzati da prompt testuali.', en: 'AI for advanced video generation from text prompts.'}, category: 'Video', country: 'USA', website: 'https://openai.com/sora/', isFeatured: false, logoUrl: 'https://whatisai.sirv.com/WP_whatisai.co.uk/2024/12/openai-sora-logo.webp', recommendationId: 'tool-034' }, // Sora
            { id: 'tool-056', name: 'Firefly', description: {it: 'AI di Adobe per la generazione di immagini creative.', en: 'Adobe AI for creative image generation.'}, category: 'Immagini', country: 'USA', website: 'https://www.adobe.com/it/products/firefly.html', isFeatured: false, logoUrl: 'https://www.graphiland.it/34712-large_default/adobe-firefly-standard-for-teams-abbonamento-12-mesi-italiano.jpg', recommendationId: 'tool-054' }, // Firefly
            { id: 'tool-057', name: 'Jules', description: {it: 'AI di Google per la programmazione e assistenza nello sviluppo di codice.', en: 'Google AI for coding and development assistance.'}, category: 'Codice', country: 'USA', website: 'https://jules.google/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQvAXEz4EsU3RQHCV96BAfJusei09ZBjQOG2g&s', recommendationId: 'tool-047' }, // Jules
            { id: 'tool-058', name: 'V0', description: {it: 'AI per la generazione di codice e prototipi da prompt testuali.', en: 'AI for code and prototype generation from text prompts.'}, category: 'Codice', country: 'USA', website: 'https://v0.dev/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMM_gwto8EzGwGDX6ACnaEr1nCZtLf5tcwjkIFkpsXDPZI6s5hp5RpUH0rga2Im4gHGBU&usqp=CAU', recommendationId: 'tool-053' }, // V0
            { id: 'tool-059', name: 'Convex', description: {it: 'AI per la generazione di codice e automazione tramite Chef.', en: 'AI for code generation and automation via Chef.'}, category: 'Codice', country: 'USA', website: 'https://chef.convex.dev//', isFeatured: false, logoUrl: 'https://chef.convex.dev/chef.svg', recommendationId: 'tool-052' }, // Convex
            { id: 'tool-060', name: 'Krea', description: {it: 'AI per la generazione di immagini e creativit√† visiva.', en: 'AI for image generation and visual creativity.'}, category: 'Immagini', country: 'USA', website: 'https://www.krea.ai/', isFeatured: false, logoUrl: 'https://aithirst.com/wp-content/uploads/2022/11/krealogo.png', recommendationId: 'tool-014' }, // Krea
            { id: 'tool-061', name: 'Gemini', description: {it: "L'alternativa naturale a ChatGPT per la generazione di testo.", en: "The natural alternative to ChatGPT for text generation."}, category: 'Testo', country: 'USA', website: 'https://gemini.google.com/app?hl=it', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcThr7qrIazsvZwJuw-uZCtLzIjaAyVW_ZrlEQ&s', recommendationId: 'tool-001' }, // Gemini
            { id: 'tool-034', name: 'Kling', description: {it: 'Genera video di alta qualit√† da prompt testuali, concentrandosi sul realismo e sul movimento complesso.', en: 'Generates high-quality videos from text prompts, focusing on realism and complex motion.'}, category: 'Video', country: 'Cina', website: 'https://klingai.com/global/', isFeatured: false, logoUrl: 'https://play-lh.googleusercontent.com/JOfjXqsShK8j1aGBc1xlHBnatoRKRwLsGuoFZUAvKksaEPvK71eLwSg4FbKlky9Es-s', recommendationId: 'tool-035' }, 
            { id: 'tool-seedance', name: 'Seedance', description: {it: 'AI cinese specializzata nella creazione di video, alternativa a Veo3.', en: 'Chinese AI specialized in video creation, alternative to Veo3.'}, category: 'Video', country: 'Cina', website: 'https://seedance.net/seedance', isFeatured: false, logoUrl: 'https://seedance.net/logo.png', recommendationId: 'tool-035' }, // Seedance
            { id: 'tool-heygen', name: 'HeyGen', description: {it: 'AI americana specializzata nella creazione di avatar virtuali e video.', en: 'American AI specialized in virtual avatar and video creation.'}, category: 'Video', country: 'USA', website: 'https://www.heygen.com', isFeatured: false, logoUrl: 'https://img.icons8.com/fluent/512/heygen.png', recommendationId: 'tool-034' }, // HeyGen
            { id: 'tool-genspark', name: 'GenSpark', description: {it: 'AI americana alternativa a Manus; pu√≤ scrivere testi, fare ricerche web, creare presentazioni e siti web.', en: 'American AI alternative to Manus; can write text, perform web searches, create presentations and websites.'}, category: 'Codice', country: 'USA', website: 'https://www.genspark.ai', isFeatured: false, logoUrl: 'https://pbs.twimg.com/profile_images/1782715833099382784/R6nadR8G_400x400.jpg', recommendationId: 'tool-suna' }, // GenSpark
            { id: 'tool-suna', name: 'Suna', description: {it: "L'alternativa a Manus specializzata in ricerche web, programmazione, presentazioni e testi", en: 'European AI recommended as an alternative to Manus and Genspark; can write text, perform web searches, create presentations and websites.'}, category: 'Codice', country: 'Europe', website: 'https://www.suna.so', isFeatured: false, logoUrl: 'https://pbs.twimg.com/profile_images/1839883420782018560/pqz5Txwt_400x400.jpg', recommendationId: 'tool-genspark' }, // Suna
            { id: 'tool-dzine', name: 'Dzine', description: {it: "AI americana specializzata nell'editing grafico. Pu√≤ generare e cambiare lo stile delle tue immagini.", en: 'American AI specialized in graphic editing. It can generate and change the style of your images.'}, category: 'Immagini', country: 'USA', website: 'https://www.dzine.ai/', isFeatured: false, logoUrl: 'https://apktodo.io/uploads/2025/3/dzine-ai-download.jpg', recommendationId: 'tool-056' }, // Dzine
            { id: 'tool-kimi', name: 'Kimi', description: {it: 'AI cinese specializzata nella programmazione e nello sviluppo di codice.', en: 'Chinese AI specialized in programming and code development.'}, category: 'Codice', country: 'Cina', website: 'https://www.kimi.com/', isFeatured: false, logoUrl: 'https://hdrobots.com/wp-content/uploads/2025/02/kimi-ai-logo.webp', recommendationId: 'tool-047' }, // Kimi
        ];
        
        // Funzione globale accessibile anche dallo script React
        window.getLocalizedToolsData = (lang) => {
            return aiToolsData.map(tool => ({ ...tool, description: tool.description[lang] || tool.description['en'] }));
        }
        window.aiToolsData = aiToolsData; // Keep static data accessible

        // MODIFICA: Le categorie ora hanno un ID e nomi traducibili
        const categories = [
            { id: 'Testo', name: { it: 'Testo', en: 'Text' }, color: '#2659A9' },
            { id: 'Immagini', name: { it: 'Immagini', en: 'Images' }, color: '#8D49F2' },
            { id: 'Video', name: { it: 'Video', en: 'Video' }, color: '#AF2896' },
            { id: 'Presentazioni', name: { it: 'Presentazioni', en: 'Presentations' }, color: '#E13300' },
            { id: 'Codice', name: { it: 'Codice', en: 'Code' }, color: '#BA5D07' },
            { id: 'Audio', name: { it: 'Audio', en: 'Audio' }, color: '#006450' },
            // Add a generic category for user tools if needed, or let user specify
            // For simplicity, let's allow user to pick from existing categories
        ];
        const countries = [...new Set(aiToolsData.map(t => t.country))]
            .filter(c => c !== 'Global')
            .map(c => ({ name: c, flag: { 'USA': 'üá∫üá∏', 'Cina': 'üá®üá≥', 'Europe': 'üá™üá∫' }[c] || 'üè≥Ô∏è' }));

        // currentUser will now include Firestore data (favorites, userTools, userFeaturedTools, userFeaturedReplacements)
        // and the privileged status loaded from Firestore
        let currentUser = {}; 
        let currentView = 'home';
        let activeFilter = 'All'; // Filter for Favorites page
        let exploreFilter = { type: null, value: null }; // Filter for Explore page
        let rankingFilter = 'All'; // Filter for Top AI page
        let reactRoot = null;
        let conversations = {};
        let activeConversationId = null;
        let currentLanguage = localStorage.getItem('koda-lang') || 'it';
        let currentTheme = localStorage.getItem('koda-theme') || 'dark';
        let searchTimeout = null; // For debouncing user search

        // State for K button click counter (still local)
        let kButtonClickCount = 0;
        let lastKButtonClickTime = 0;
        let kButtonClickTimeout = null;
        const K_BUTTON_CLICK_THRESHOLD = 5;
        const K_BUTTON_CLICK_RESET_DELAY = 500; // ms

        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79zM1 10.5h3v2H1zM11 .55h2V3.5h-2zm8.04 1.49l1.79-1.8-1.41-1.41-1.8 1.79zM20 10.5h3v2h-3zm-9.24 10.96l1.8 1.79 1.41-1.41-1.79-1.79zm-6.36-1.8l-1.79 1.8 1.41 1.41 1.8-1.79zM12 5.5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9.37 5.51A7.35 7.35 0 009.1 7.5c0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49z"/></svg>`;
        // Pencil icon SVG for editing
        const pencilIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M14.06 9.02l.92.92L5.92 18H5v-.92l9.06-9.06zm4.6-4.6l-1.39-1.39c-.2-.2-.51-.2-.71 0l-1.83 1.83 3.29 3.29 1.83-1.83c.2-.2.2-.51 0-.71zM3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>`;


        const el = { 
            mainContent: document.getElementById('main-content'), 
            bottomNav: document.getElementById('bottom-nav'), 
            modalContainer: document.getElementById('modal-container'),
            appContainer: document.getElementById('app-container'),
            authOverlay: document.getElementById('auth-overlay'),
            sideMenuOverlay: document.getElementById('side-menu-overlay'),
            sideMenu: document.getElementById('side-menu'),
            conversationListContainer: document.getElementById('conversation-list-container'),
        };
        
        const getStorageKey = () => `conversations_${currentUser.uid || 'guest'}`;

        const loadConversations = () => {
            const saved = localStorage.getItem(getStorageKey());
            conversations = saved ? JSON.parse(saved) : {};
            const savedActiveId = localStorage.getItem(`activeConversationId_${currentUser.uid || 'guest'}`);
            activeConversationId = savedActiveId && conversations[savedActiveId] ? savedActiveId : null;

            if (Object.keys(conversations).length === 0 || !activeConversationId) {
                startNewChat(false);
            }
        };

        const saveConversations = (newConversations) => {
            conversations = newConversations; // Corrected variable name
            localStorage.setItem(getStorageKey(), JSON.stringify(conversations));
        };

        const saveActiveConversationId = () => {
             localStorage.setItem(`activeConversationId_${currentUser.uid || 'guest'}`, activeConversationId);
        }

        const startNewChat = (remountApp = true) => {
            const newId = `chat-${Date.now()}`;
            const t = translations[currentLanguage];
            conversations[newId] = { id: newId, title: t.newChatTitle, messages: [], timestamp: Date.now() };
            activeConversationId = newId;
            saveConversations(conversations);
            saveActiveConversationId();
            if (remountApp) {
                renderView();
            }
            toggleSideMenu(false);
        };

        const showToast = (message) => {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };

        // Espone la funzione showToast globalmente
        window.showToast = showToast;
        
        // NUOVA FUNZIONE: Ottiene il nome tradotto di una categoria
        const getTranslatedCategoryName = (categoryId) => {
            const category = categories.find(c => c.id === categoryId);
            return category ? category.name[currentLanguage] : categoryId;
        };

        // NEW FUNCTION: Get all tools (static + user's)
        window.getAllToolsForCurrentUser = () => { // Make it globally accessible for React
             const staticTools = window.getLocalizedToolsData(currentLanguage);
             const userTools = currentUser.userTools || []; // userTools now comes from currentUser (synced with Firestore)
             // Ensure user tools have localized descriptions if possible, or fallback
             const localizedUserTools = userTools.map(tool => ({
                 ...tool,
                 description: typeof tool.description === 'object' ? (tool.description[currentLanguage] || tool.description['en'] || '') : tool.description
             }));
             // Filtro per eliminare duplicati per id
             const allTools = [...staticTools, ...localizedUserTools];
             return allTools.filter((tool, idx, arr) => arr.findIndex(t => t.id === tool.id) === idx);
        };


        // Modified createGridCard to optionally show an edit icon and specify its action
        const createGridCard = (tool, context) => {
            let editIconHTML = '';
            // Check if user is logged in AND privileged (status loaded from Firestore)
            if (currentUser.uid && currentUser.isPrivileged) {
                const isUserTool = tool.id.startsWith('user-');
                let action = '';
                let title = '';

                if (context === 'user-featured-section' && isUserTool) {
                    // Pencil on user tool in Featured by You section -> Toggle Featured status
                    action = 'toggle-user-featured';
                    title = translations[currentLanguage].unmarkAsFeatured; // Assuming it's already featured here
                } else if (context === 'top-ai-featured') {
                     const replacementToolId = currentUser.userFeaturedReplacements?.[tool.id];
                     if (replacementToolId) {
                         // Pencil on a static tool that has been replaced -> Remove replacement
                         action = 'remove-featured-replacement';
                         title = translations[currentLanguage].removeFeaturedReplacement;
                     } else if (!isUserTool) {
                         // Pencil on a static featured tool (not replaced) -> Open replace modal
                         action = 'replace-featured-static';
                         title = translations[currentLanguage].replaceFeaturedTitle;
                     }
                     // No pencil on user tools in Top AI Featured unless they are replacements (handled above)
                }

                if (action) {
                     editIconHTML = `<div class="edit-icon" data-action="${action}" data-id="${tool.id}" title="${title}"> ${pencilIcon} </div>`;
                }
            }

            return `<div class="tool-card-grid" data-id="${tool.id}"><div class="logo-container"><img src="${tool.logoUrl}" class="tool-logo" alt="${tool.name}" loading="lazy">${editIconHTML}</div><div class="tool-name">${tool.name}</div></div>`;
        };

        const createListCard = (tool, context) => {
            const isUserTool = tool.id.startsWith('user-'); // Simple check for user tools
            const isFavorited = currentUser.uid && currentUser.favorites.includes(tool.id);
            
            // Favorite icon is shown for all tools if logged in
            const favoriteIconHTML = currentUser.uid ? `<div class="favorite-icon" data-action="toggle-favorite" data-id="${tool.id}">${isFavorited ? '‚ô•' : '‚ô°'}</div>` : '';

            let editIconHTML = '';
            // Pencil icon is shown for user tools in the Library list if privileged
            if (context === 'library' && isUserTool && currentUser.uid && currentUser.isPrivileged) {
                 editIconHTML = `<div class="edit-icon" data-action="remove-user-tool" data-id="${tool.id}" title="${translations[currentLanguage].removeUserTool}"> ${pencilIcon} </div>`;
            }

            return `<div class="tool-card-list" data-id="${tool.id}"><div class="logo-container"><img src="${tool.logoUrl}" class="tool-logo" alt="${tool.name}" loading="lazy">${editIconHTML}</div><div class="info"><div class="tool-name">${tool.name}</div><div class="tool-subtext">${getTranslatedCategoryName(tool.category)}</div></div>${favoriteIconHTML}</div>`;
        };

        const createCategoryCard = (category) => {
            const currentTools = window.getLocalizedToolsData(currentLanguage);
            const toolForLogo = currentTools.find(t=>t.category===category.id) || { logoUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcBAMAAACAI8KnAAAAFVBMVEX///+ZmZkZGRlZWVmRkZEAAABGRkb6Me63AAAAHElEQVR4AWMYUCBkwKyIxHVNYAsZVFyEIwcSAADWIQrDIppSoAAAAABJRU5ErkJggg==' }; // Fallback per logo
            // Usa category.id per il filtro e category.name per la visualizzazione
            return `<div class="category-card" style="background-color: ${category.color};" data-action="set-explore-filter" data-filter-type="category" data-filter-value="${category.id}"><h3>${category.name[currentLanguage]}</h3><div class="logo-container"><img src="${toolForLogo.logoUrl}" class="tool-logo" loading="lazy"></div></div>`;
        };
        const createCountryCard = (country) => `<div class="category-card" style="background-color: #333;" data-action="set-explore-filter" data-filter-type="country" data-filter-value="${country.name}"><h3 style="font-size: 24px;">${country.flag} ${country.name}</h3></div>`;

        window.openDetailModal = (toolId) => {
            const allTools = getAllToolsForCurrentUser(); // Use combined list
            const tool = allTools.find(t => t.id === toolId);
            if (!tool) return;
            const t = translations[currentLanguage];
            const isFavorited = currentUser.uid && currentUser.favorites.includes(toolId);
            const isUserTool = tool.id.startsWith('user-');
            // Check privileged status loaded from Firestore
            const isUserFeatured = currentUser.uid && currentUser.isPrivileged && currentUser.userFeaturedTools?.includes(toolId);

            let recommendationHTML = '';
            let recommendedTool = null;
            if (tool.recommendationId) {
                recommendedTool = allTools.find(t => t.id === tool.recommendationId); // Check in all tools
            } else {
                // Trova una AI alternativa della stessa categoria, diversa dalla selezionata
                const sameCategory = allTools.filter(t => t.category === tool.category && t.id !== tool.id);
                if (sameCategory.length > 0) {
                    // Scegli una a caso
                    recommendedTool = sameCategory[Math.floor(Math.random() * sameCategory.length)];
                }
            }
            if (recommendedTool) {
                recommendationHTML = `<div class="recommendation-box" data-action="open-detail-modal" data-id="${recommendedTool.id}"><img src="${recommendedTool.logoUrl}" alt="${recommendedTool.name}" class="recommendation-logo" loading="lazy"><div class="recommendation-text">${t.alternativeSuggestion}<strong>${recommendedTool.name}</strong></div></div>`;
            }
            let userToolActionsHTML = '';
            // Show Mark Featured button only for user's own tools if privileged
            if (isUserTool && currentUser.uid && currentUser.isPrivileged) {
                 userToolActionsHTML = `<button class="button" data-action="toggle-user-featured" data-id="${tool.id}">${isUserFeatured ? t.unmarkAsFeatured : t.markAsFeatured}</button>`;
            }

            const modalHTML = `<div id="detail-modal" class="modal-overlay visible"><div class="modal-content"><button class="modal-close-btn" data-action="close-modal">√ó</button><div id="detail-content"><h2>${tool.name}</h2><p>${tool.description}</p><div class="detail-tags"><span class="tag">üåç ${tool.country || 'N/A'}</span><span class="tag">${getTranslatedCategoryName(tool.category || 'N/A')}</span></div><div class="detail-actions">${userToolActionsHTML}${currentUser.uid ? `<button class="button" data-action="toggle-favorite" data-id="${tool.id}">${isFavorited ? t.detailModalRemoveFavorite : t.detailModalAddFavorite}</button>` : ''}<a href="${tool.website}" target="_blank" class="button" style="text-decoration: none; display: flex; justify-content: center; align-items: center;">${t.visitWebsite}</a></div>${recommendationHTML}</div></div></div>`;
            el.modalContainer.innerHTML = modalHTML;
        };
        
        const closeModal = () => {
            el.modalContainer.innerHTML = '';
            closeUserProfileDropdown();
        };

        // Variable to store pending favorite action
        let pendingFavoriteAction = null;

        const toggleFavorite = async (toolId) => {
            if (!currentUser || !currentUser.uid) { 
                // Store the pending action and trigger auth flow
                pendingFavoriteAction = toolId;
                triggerAuthFlow(); 
                return; 
            }
            // Removed the check !toolId.startsWith('user-')
            // Now all tools can be favorited

            const userDocRef = doc(db, "users", currentUser.uid);
            const isFavorited = currentUser.favorites.includes(toolId);
            try {
                if (isFavorited) {
                    await updateDoc(userDocRef, { favorites: arrayRemove(toolId) });
                    currentUser.favorites = currentUser.favorites.filter(id => id !== toolId);
                } else {
                    await updateDoc(userDocRef, { favorites: arrayUnion(toolId) });
                    currentUser.favorites.push(toolId);
                }
            } catch (error) { console.error("Error updating favorites:", error); showToast("Could not update favorites. Please try again."); return; }
            // Re-render the current view to update favorite icons
            renderView();
            // If detail modal is open, update it
            if (document.getElementById('detail-modal')) { window.openDetailModal(toolId); }
        };

        // NEW FUNCTION: Toggle user-added tool featured status (Firestore)
        const toggleUserFeatured = async (toolId) => {
             // Check privileged status loaded from Firestore
             if (!currentUser || !currentUser.uid || !currentUser.isPrivileged) return;
             // Ensure it is a user-added tool
             if (!toolId.startsWith('user-')) return;

             const userDocRef = doc(db, "users", currentUser.uid);
             const isUserFeatured = currentUser.userFeaturedTools?.includes(toolId);
             const newFeaturedList = isUserFeatured
                 ? currentUser.userFeaturedTools.filter(id => id !== toolId)
                 : [...(currentUser.userFeaturedTools || []), toolId];

             try {
                 await updateDoc(userDocRef, { userFeaturedTools: newFeaturedList });
                 currentUser.userFeaturedTools = newFeaturedList; // Update local state after successful Firestore update
             } catch (error) {
                 console.error("Error updating user featured tools:", error);
                 showToast("Could not update featured status. Please try again.");
                 return;
             }

             // Re-render the current view (Library) and update the detail modal
             renderView();
             if (document.getElementById('detail-modal')) { window.openDetailModal(toolId); }
        };

        // NEW FUNCTION: Replace static featured tool with user tool (Firestore)
        const replaceFeaturedStatic = async (staticToolId, userToolId) => {
             // Check privileged status loaded from Firestore
             if (!currentUser || !currentUser.uid || !currentUser.isPrivileged) return;
             if (!staticToolId || !userToolId) return;

             const userDocRef = doc(db, "users", currentUser.uid);
             const newReplacements = { ...(currentUser.userFeaturedReplacements || {}), [staticToolId]: userToolId };

             try {
                 await updateDoc(userDocRef, { userFeaturedReplacements: newReplacements });
                 currentUser.userFeaturedReplacements = newReplacements; // Update local state
                 showToast(translations[currentLanguage].addAppSuccess); // Reuse success toast
             } catch (error) {
                 console.error("Error replacing featured tool:", error);
                 showToast(`Error: ${error.message}`); // Generic error
                 return;
             }

             closeModal();
             renderView(); // Re-render Top AI view
        };

         // NEW FUNCTION: Remove featured replacement (Firestore)
        const removeFeaturedReplacement = async (staticToolId) => {
             // Check privileged status loaded from Firestore
             if (!currentUser || !currentUser.uid || !currentUser.isPrivileged) return;
             if (!staticToolId) return;

             const userDocRef = doc(db, "users", currentUser.uid);
             const newReplacements = { ...(currentUser.userFeaturedReplacements || {}) };
             delete newReplacements[staticToolId];

             try {
                 await updateDoc(userDocRef, { userFeaturedReplacements: newReplacements });
                 currentUser.userFeaturedReplacements = newReplacements; // Update local state
                 showToast(translations[currentLanguage].removeFeaturedReplacement + " Success!"); // Toast confirmation
             } catch (error) {
                 console.error("Error removing featured replacement:", error);
                 showToast(`Error: ${error.message}`); // Generic error
                 return;
             }

             renderView(); // Re-render Top AI view
        };

        // NEW FUNCTION: Remove user-added tool entirely (Firestore)
        const removeUserTool = async (toolId) => {
            if (!currentUser || !currentUser.uid || !currentUser.isPrivileged || !toolId.startsWith('user-')) {
                showToast("Action not allowed."); // Or a more specific message
                return;
            }

            const userDocRef = doc(db, "users", currentUser.uid);
            const t = translations[currentLanguage];

            try {
                // 1. Read the current user document
                const userDocSnap = await getDoc(userDocRef);
                if (!userDocSnap.exists()) {
                    showToast("User data not found.");
                    return;
                }
                const userData = userDocSnap.data();

                // 2. Filter the userTools array in memory
                const updatedUserTools = (userData.userTools || []).filter(tool => tool.id !== toolId);

                // 3. Filter the userFeaturedTools array
                const updatedUserFeaturedTools = (userData.userFeaturedTools || []).filter(id => id !== toolId);

                // 4. Remove the tool from userFeaturedReplacements if it was used as a replacement
                const updatedUserFeaturedReplacements = { ...(userData.userFeaturedReplacements || {}) };
                let replacementRemoved = false;
                for (const staticId in updatedUserFeaturedReplacements) {
                    if (updatedUserFeaturedReplacements[staticId] === toolId) {
                        delete updatedUserFeaturedReplacements[staticId];
                        replacementRemoved = true;
                        break; // Assuming a user tool can only replace one static tool at a time
                    }
                }
                
                // 5. Remove the tool from favorites if it was favorited
                const updatedFavorites = (userData.favorites || []).filter(id => id !== toolId);


                // 6. Prepare the update object
                const updateData = {
                    userTools: updatedUserTools,
                    userFeaturedTools: updatedUserFeaturedTools,
                    userFeaturedReplacements: updatedUserFeaturedReplacements,
                    favorites: updatedFavorites // Update favorites as well
                };

                // 7. Write the updated data back to Firestore
                await updateDoc(userDocRef, updateData);

                // 8. Update local state
                currentUser.userTools = updatedUserTools;
                currentUser.userFeaturedTools = updatedUserFeaturedTools;
                currentUser.userFeaturedReplacements = updatedUserFeaturedReplacements;
                currentUser.favorites = updatedFavorites; // Update local favorites

                showToast(t.removeUserTool + " Success!"); // Need this translation
                renderView(); // Re-render the Library view
                closeModal(); // Close any open modal (like detail modal)
            } catch (error) {
                console.error("Error removing user tool:", error);
                showToast(`Error: ${error.message}`);
            }
        };


        
        const unmountReactApp = () => {
            if (reactRoot) {
                reactRoot.unmount();
                reactRoot = null;
            }
        };

        const renderSideMenu = () => {
            const sortedConversations = Object.values(conversations).sort((a, b) => b.timestamp - a.timestamp);
            el.conversationListContainer.innerHTML = sortedConversations.map(conv => `
                <button class="conversation-item" data-action="select-conversation" data-id="${conv.id}">
                    ${conv.title}
                </button>
            `).join('');
            el.conversationListContainer.querySelector(`[data-id="${activeConversationId}"]`)?.classList.add('active');
            applyTranslations(currentLanguage); // Apply translations to menu items
        };

        const toggleSideMenu = (show) => {
            if (show) {
                renderSideMenu(); // Render menu content before showing
                el.sideMenuOverlay.classList.add('visible');
                el.sideMenu.classList.remove('hidden'); /* Ensure it's not hidden by mistake */
                el.sideMenu.classList.add('visible');
            } else {
                el.sideMenuOverlay.classList.remove('visible');
                el.sideMenu.classList.remove('visible');
                // Add a small delay before hiding overlay completely to allow transition
                setTimeout(() => {
                     el.sideMenuOverlay.classList.add('hidden');
                }, 300); // Match CSS transition duration
            }
        };

        // User Profile Dropdown Functions
        const toggleUserProfileDropdown = () => {
            const dropdown = document.getElementById('user-profile-dropdown');
            if (dropdown) {
                const isVisible = dropdown.classList.contains('visible');
                if (isVisible) {
                    closeUserProfileDropdown();
                } else {
                    openUserProfileDropdown();
                }
            }
        };

        const openUserProfileDropdown = () => {
            const dropdown = document.getElementById('user-profile-dropdown');
            if (dropdown) {
                // Close any other open dropdowns first
                closeUserProfileDropdown();
                
                // Update user info in dropdown
                const nameElement = dropdown.querySelector('.user-profile-name');
                const emailElement = dropdown.querySelector('.user-profile-email');
                const avatarElement = dropdown.querySelector('.user-profile-avatar');
                
                if (nameElement) nameElement.textContent = currentUser.nickname || currentUser.name;
                if (emailElement) emailElement.textContent = currentUser.name;
                if (avatarElement) avatarElement.textContent = currentUser.nickname ? currentUser.nickname.charAt(0).toUpperCase() : currentUser.name.charAt(0).toUpperCase();
                
                // Apply translations
                applyTranslations(currentLanguage);
                
                // Show dropdown
                dropdown.classList.add('visible');
                
                // Add click outside listener
                setTimeout(() => {
                    document.addEventListener('click', closeUserProfileDropdownOnClickOutside);
                }, 100);
            }
        };

        const closeUserProfileDropdown = () => {
            const dropdown = document.getElementById('user-profile-dropdown');
            if (dropdown) {
                dropdown.classList.remove('visible');
                document.removeEventListener('click', closeUserProfileDropdownOnClickOutside);
            }
        };

        const closeUserProfileDropdownOnClickOutside = (event) => {
            const dropdown = document.getElementById('user-profile-dropdown');
            const container = document.querySelector('.user-profile-container');
            
            if (dropdown && container && !container.contains(event.target)) {
                closeUserProfileDropdown();
            }
        };

        const getGlobalControlsHTML = (options = {}) => {
            const { includeLangToggle = true } = options;

            const themeIcon = currentTheme === 'dark' ? sunIcon : moonIcon;
            const isGuest = !currentUser.uid;
            const userInitial = isGuest ? '?' : (currentUser.nickname ? currentUser.nickname.charAt(0).toUpperCase() : 'U');
            
            // The avatar is now always rendered in the top-bar, but its click action depends on login status
            const avatarHTML = `
            <div class="user-profile-container">
                <div class="user-avatar" data-action="profile-avatar-click">${userInitial}</div>
                <div class="user-profile-dropdown" id="user-profile-dropdown">
                    <div class="user-profile-header">
                        <div class="user-profile-avatar">${userInitial}</div>
                        <div class="user-profile-name">${currentUser.nickname || currentUser.name}</div>
                        <div class="user-profile-email">${currentUser.name}</div>
                    </div>
                    <div class="user-profile-menu">
                        <div class="user-profile-item" data-action="open-settings">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span data-translate="settingsTitle">Impostazioni account</span>
                        </div>
                        <div class="user-profile-item" data-action="change-nickname">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            <span data-translate="changeNicknameTitle">Cambia nickname</span>
                        </div>
                        <div class="user-profile-item" data-action="change-password">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                            </svg>
                            <span data-translate="changePasswordTitle">Cambia password</span>
                        </div>
                        <div class="user-profile-divider"></div>
                        <div class="user-profile-item user-profile-logout" data-action="logout">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                            </svg>
                            <span data-translate="logout">Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
            
            let otherControlsHTML = `
                <button id="theme-toggle-btn" class="global-btn" data-action="toggle-theme">${themeIcon}</button>
            `;

            if (includeLangToggle) {
                otherControlsHTML += `
                    <button id="lang-toggle-btn" class="global-btn" data-action="toggle-lang">${currentLanguage.toUpperCase()}</button>
                `;
            }

            // Return as an object to pass to React
            return { avatar: avatarHTML, otherControls: otherControlsHTML };
        };

        const renderView = () => {
            // Close any open dropdowns when navigating
            closeUserProfileDropdown();
            unmountReactApp(); 
            el.mainContent.innerHTML = '';
            
            const t = translations[currentLanguage];
            const staticTools = window.getLocalizedToolsData(currentLanguage);
            const allTools = getAllToolsForCurrentUser(); // Use combined list for search/explore
            const isGuest = !currentUser.uid;
            // Check privileged status loaded from Firestore
            const isPrivileged = currentUser.uid && currentUser.isPrivileged; 
            const pageTitles = { home: t.pageTitleHome, 'top-ai': t.pageTitleTopAI, search: t.pageTitleSearch, 'search-users': t.pageTitleSearchUsers, 'user-chats': t.pageTitleUserChats, favorites: t.pageTitleLibrary };

            // Top bar is only rendered for non-home views
            if (currentView !== 'home') {
                const globalControls = getGlobalControlsHTML();
                const pageTitle = pageTitles[currentView] || currentView;
                const topBarHTML = `<div class="top-bar" style="display: flex; align-items: center; gap: 8px;">
                    <div id="profile-avatar-menu" style="margin-right: 8px;">${globalControls.avatar}</div>
                    <div class="page-title">${pageTitle}</div>
                    <div id="global-controls" style="margin-left: auto;">${globalControls.otherControls}</div>
                </div>`;
                el.mainContent.insertAdjacentHTML('beforeend', topBarHTML);
            }

            const contentArea = document.createElement('div');
            contentArea.id = 'content-area';
            
            if (currentView === 'home') {
                // Chatbot view handles its own header and global controls via React prop
                el.mainContent.innerHTML = `<div id="chatbot-container-wrapper"></div>`;
                const chatbotContainer = document.getElementById('chatbot-container-wrapper');
                if (window.mountChatbotApp) {
                    reactRoot = window.mountChatbotApp(chatbotContainer, {
                        tools: allTools, // Pass all tools to chatbot for recommendations
                        initialConversations: conversations,
                        initialActiveId: activeConversationId,
                        onConversationsChange: (newConvos) => {
                            saveConversations(newConvos);
                            if(el.sideMenu.classList.contains('visible')) {
                                renderSideMenu();
                            }
                        },
                        onOpenDetail: window.openDetailModal,
                        lang: currentLanguage,
                        globalControlsHTML: getGlobalControlsHTML() // Pass controls HTML to React app
                    });
                } else {
                    console.error("Chatbot mount function not found.");
                }
            } else if (currentView === 'top-ai') {
                // Limita a 4 le AI In evidenza
                const featuredTools = staticTools.filter(t => t.isFeatured).slice(0, 4); // Solo 4 AI In evidenza
                let contentHTML = `<div class="section-title" data-translate="featured">${t.featured}</div><div class="grid-container">`;
                
                // Render static featured tools, potentially replaced by user tools
                contentHTML += featuredTools.map(staticTool => {
                    const replacementToolId = currentUser.uid && currentUser.userFeaturedReplacements ? currentUser.userFeaturedReplacements[staticTool.id] : null;
                    const toolToDisplay = replacementToolId ? (currentUser.userTools || []).find(ut => ut.id === replacementToolId) : staticTool;
                    if (!toolToDisplay) return '';
                    // Forza la visualizzazione dei controlli di modifica/rimozione per utenti privilegiati
                    return createGridCard(toolToDisplay, 'top-ai-featured');
                }).join('');

                contentHTML += `</div>`; // Close grid-container

                const rankings = [
                    { titleKey: "rankingTextTitle", category: "Testo", toolIds: ['tool-044', 'tool-013', 'tool-001'] }, // Added Perplexity to Text ranking
                    { titleKey: "rankingCodeTitle", category: "Codice", toolIds: ["tool-024", "tool-021", "tool-052"] },
                    { titleKey: "rankingImagesTitle", category: "Immagini", toolIds: ["tool-014", "tool-001", "tool-033", "tool-005"] }
                ];
                
                const rankingCategoryIdentifiers = ["All", "Testo", "Codice", "Immagini"];
                const filtersHTML = `<div class="filters-container" style="top: 64px; margin-bottom: 20px;">
                    <div class="filter-pills" id="ranking-filters">
                        ${rankingCategoryIdentifiers.map(id => `<button class="pill-btn ${rankingFilter === id ? 'active' : ''}" data-action="set-ranking-filter" data-filter="${id}">${id === 'All' ? t.filterAll : getTranslatedCategoryName(id)}</button>`).join('')}
                    </div>
                </div>`;

                const createRankingItem = (toolId, rank) => {
                    // Find the tool in the static list first, then user tools if not found
                    const tool = staticTools.find(t => t.id === toolId) || (currentUser.userTools || []).find(t => t.id === toolId);
                    if (!tool) return '';
                    return `
                        <li class="ranking-item" data-id="${tool.id}">
                            <span class="ranking-item-rank">${rank}</span>
                            <img src="${tool.logoUrl}" alt="${tool.name}" class="ranking-item-logo" loading="lazy">
                            <div class="ranking-item-info">
                                <div class="tool-name">${tool.name}</div>
                                <div class="tool-subtext">${getTranslatedCategoryName(tool.category)}</div>
                            </div>
                        </li>
                    `;
                };

                const rankingsHTML = `
                    <div class="section-title" style="margin-top: 40px;" data-translate="rankingsTitle">${t.rankingsTitle}</div>
                    ${filtersHTML}
                    <div class="ranking-section-container">
                        ${rankings.map(ranking => `
                            <div class="ranking-card" data-ranking-category="${ranking.category}">
                                <h3>${t[ranking.titleKey]}</h3>
                                <ol class="ranking-list">
                                    ${ranking.toolIds.map((id, index) => createRankingItem(id, index + 1)).join('')}
                                </ol>
                            </div>
                        `).join('')}
                    </div>
                `;

                contentHTML += rankingsHTML;
                contentArea.innerHTML = contentHTML;
                el.mainContent.appendChild(contentArea);
                
                const rankingCards = document.querySelectorAll('.ranking-card');
                rankingCards.forEach(card => {
                    if (rankingFilter !== 'All' && card.dataset.rankingCategory !== rankingFilter) {
                        card.classList.add('hidden');
                    } else {
                         card.classList.remove('hidden'); // Ensure it's visible if filter matches or is 'All'
                    }
                });

            } else if (currentView === 'explore') {
                el.mainContent.insertAdjacentHTML('beforeend', `<div class="search-bar-container"><input type="text" id="search-input" placeholder="${t.searchPlaceholder}"></div>`);
                // Filtro per eliminare duplicati per id
                const uniqueTools = allTools.filter((tool, idx, arr) => arr.findIndex(t => t.id === tool.id) === idx);
                if (!exploreFilter.type) {
                    contentArea.innerHTML = `<div class="section-title" data-translate="browseAll">${t.browseAll}</div><div class="category-grid">${categories.map(createCategoryCard).join('')}</div><div class="section-title" style="margin-top: 30px;" data-translate="browseByOrigin">${t.browseByOrigin}</div><div class="category-grid">${countries.map(c => createCountryCard(c)).join('')}</div>`;
                } else {
                    // Filter from all unique tools (static + user, senza duplicati)
                    const filteredTools = uniqueTools.filter(t => t[exploreFilter.type] === exploreFilter.value);
                    const title = exploreFilter.type === 'category' ? getTranslatedCategoryName(exploreFilter.value) : `${t.toolsFrom} ${exploreFilter.value}`;
                    // Pass context 'explore' to createListCard for search results
                    contentArea.innerHTML = `<div class="back-button" data-action="back-to-explore">${t.backToSearch}</div><h2 class="section-title">${title}</h2><div class="list-container">${filteredTools.map(tool => createListCard(tool, 'explore')).join('')}</div>`;
                }
                el.mainContent.appendChild(contentArea);
            } else if (currentView === 'search-users') {
                if (isGuest) {
                    contentArea.innerHTML = `
                        <div class="auth-prompt-card">
                            <h3 data-translate="libraryPromptTitle">${t.libraryPromptTitle}</h3>
                            <p data-translate="libraryPromptText">${t.libraryPromptText}</p>
                            <div class="auth-prompt-actions">
                                <button class="button" data-action="prompt-login" data-translate="loginButton">${t.loginButton}</button>
                                <button class="pill-btn" data-action="prompt-register" data-translate="registerButton">${t.registerButton}</button>
                            </div>
                        </div>
                    `;
                } else {
                    contentArea.innerHTML = `
                        <div class="search-users-container">
                            <div class="search-users-header">
                                <div class="search-users-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 0 24 24" width="48" fill="currentColor">
                                        <path d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H15.46c-.84 0-1.61.5-1.96 1.37L11 18h2v6h7zM12.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4z"/>
                                    </svg>
                                </div>
                                <h1 class="search-users-title" data-translate="searchUsersTitle">${t.searchUsersTitle}</h1>
                                <p class="search-users-subtitle" data-translate="searchUsersSubtitle">${t.searchUsersSubtitle}</p>
                            </div>
                            
                            <div class="search-users-input-container">
                                <div class="search-input-wrapper">
                                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor">
                                        <path d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                    </svg>
                                    <input type="text" id="user-search-input" class="search-users-input" placeholder="${t.searchUsersPlaceholder}" autocomplete="off">
                                </div>
                            </div>
                            
                            <div id="user-search-results" class="search-results-container">
                                <!-- Search results will be populated here -->
                            </div>
                            

                        </div>
                    `;
                }
                el.mainContent.appendChild(contentArea);
            } else if (currentView === 'user-chats') {
                if (isGuest) {
                    contentArea.innerHTML = `
                        <div class="auth-prompt-card">
                            <h3 data-translate="libraryPromptTitle">${t.libraryPromptTitle}</h3>
                            <p data-translate="libraryPromptText">${t.libraryPromptText}</p>
                            <div class="auth-prompt-actions">
                                <button class="button" data-action="prompt-login" data-translate="loginButton">${t.loginButton}</button>
                                <button class="pill-btn" data-action="prompt-register" data-translate="registerButton">${t.registerButton}</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Render user chat app
                    el.mainContent.innerHTML = `<div id="user-chat-container-wrapper"></div>`;
                    const userChatContainer = document.getElementById('user-chat-container-wrapper');
                    if (window.mountUserChatApp) {
                        reactRoot = window.mountUserChatApp(userChatContainer, {
                            currentUser: currentUser,
                            onOpenDetail: window.openDetailModal,
                            lang: currentLanguage,
                            globalControlsHTML: getGlobalControlsHTML({ includeLangToggle: false })
                        });
                    } else {
                        console.error("User chat mount function not found.");
                    }
                }
                el.mainContent.appendChild(contentArea);
            } else if (currentView === 'favorites') {
                if (isGuest) {
                    contentArea.innerHTML = `
                        <div class="auth-prompt-card">
                            <h3 data-translate="libraryPromptTitle">${t.libraryPromptTitle}</h3>
                            <p data-translate="libraryPromptText">${t.libraryPromptText}</p>
                            <div class="auth-prompt-actions">
                                <button class="button" data-action="prompt-login" data-translate="loginButton">${t.loginButton}</button>
                                <button class="pill-btn" data-action="prompt-register" data-translate="registerButton">${t.registerButton}</button>
                            </div>
                        </div>
                    `;
                } else {
                    let contentHTML = '';

                    // Add the K button for logged-in users (only if not already privileged)
                    if (currentUser.uid && !currentUser.isPrivileged) {
                         contentHTML += `<button id="privileged-unlock-btn" data-action="unlock-privileged">K</button>`;
                    }

                    // Add "Add Custom App" Button for privileged users
                    if (isPrivileged) {
                         contentHTML += `<div style="text-align: center; margin-bottom: 20px;">
                             <button id="add-app-button" class="button" data-action="open-add-app-modal" data-translate="addCustomApp">${t.addCustomApp}</button>
                         </div>`;
                    }


                    // AI Suggestions Section for all logged-in users
                    if (currentUser.uid) {
                        contentHTML += `
                            <div class="section-title" style="margin-top: 30px;" data-translate="aiSuggestionsTitle">${t.aiSuggestionsTitle}</div>
                            <div style="text-align: center; margin-bottom: 20px;">
                                <button id="add-ai-suggestion-btn" class="button" data-action="add-ai-suggestion" data-translate="addAiSuggestionButton">${t.addAiSuggestionButton}</button>
                            </div>
                            <div id="ai-suggestions-list" class="suggestions-grid">
                                ${(currentUser.aiSuggestions || []).map(suggestion => {
                                    // Handle both old format (text) and new format (appName, description, etc.)
                                    if (suggestion.text) {
                                        // Old format - show as simple text
                                        return `
                                            <div class="suggestion-item old-format" data-id="${suggestion.id}">
                                                <div class="suggestion-text">${suggestion.text}</div>
                                                <div class="suggestion-actions">
                                                    <div class="suggestion-date">${new Date(suggestion.timestamp).toLocaleDateString()}</div>
                                                    <button class="remove-suggestion-btn" data-action="remove-ai-suggestion" data-id="${suggestion.id}" title="${t.removeAiSuggestion}">√ó</button>
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        // New format - show as app card
                                        return `
                                            <div class="suggestion-item new-format" data-id="${suggestion.id}">
                                                <div class="suggestion-header">
                                                    <h3 class="suggestion-app-name">${suggestion.appName}</h3>
                                                    <div class="suggestion-meta">
                                                        <span class="suggestion-category">${suggestion.category}</span>
                                                        <span class="suggestion-country">${suggestion.country}</span>
                                                    </div>
                                                </div>
                                                <div class="suggestion-description">${suggestion.description}</div>
                                                <div class="suggestion-actions">
                                                    <a href="${suggestion.website}" target="_blank" class="suggestion-website-btn">
                                                        üåê ${t.visitWebsite}
                                                    </a>
                                                    <div class="suggestion-date">${new Date(suggestion.timestamp).toLocaleDateString()}</div>
                                                    <button class="remove-suggestion-btn" data-action="remove-ai-suggestion" data-id="${suggestion.id}" title="${t.removeAiSuggestion}">üóëÔ∏è</button>
                                                </div>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        `;
                    }

                    // User Featured Section for privileged users
                    // userFeaturedTools now comes from currentUser (synced with Firestore)
                    const userFeaturedTools = (currentUser.userTools || []).filter(tool => currentUser.userFeaturedTools?.includes(tool.id));
                    if (isPrivileged) {
                         contentHTML += `
                             <div class="user-featured-section">
                                 <div class="section-title" data-translate="featuredByYou">${t.featuredByYou}</div>
                                 <div class="grid-container">
                                     ${userFeaturedTools.length > 0 ? userFeaturedTools.map(tool => createGridCard(tool, 'user-featured-section')).join('') : '' /* Removed empty state text */}
                                 </div>
                             </div>
                         `;
                    }

                    // Main Library List (Static Favorites + All User Tools)
                    const staticFavorites = staticTools.filter(t => currentUser.favorites.includes(t.id));
                    const allUserTools = currentUser.userTools || []; // userTools now comes from currentUser (synced with Firestore)
                    // Unisco e filtro per unicit√†
                    const combinedLibraryTools = [...staticFavorites, ...allUserTools].filter((tool, idx, arr) => arr.findIndex(t => t.id === tool.id) === idx);

                    // Determine available categories for filtering (from static favorites + user tools)
                    const availableCategoriesInLibrary = [...new Set(combinedLibraryTools.map(t => t.category))];
                    const filterPills = ['All', ...availableCategoriesInLibrary.filter(cat => cat)]; // Filter out undefined/null categories
                    const filtersHTML = `<div class="filters-container"><div class="filter-pills">${filterPills.map(f_id => `<button class="pill-btn ${activeFilter === f_id ? 'active' : ''}" data-action="set-favorite-filter" data-filter="${f_id}">${f_id === 'All' ? t.filterAll : getTranslatedCategoryName(f_id)}</button>`).join('')}</div></div>`;
                    el.mainContent.insertAdjacentHTML('beforeend', filtersHTML);

                    let filteredLibraryTools = activeFilter === 'All' ? combinedLibraryTools : combinedLibraryTools.filter(t => t.category === activeFilter);

                    // Exclude user featured tools from the main list if they are shown in the featured section AND the user is privileged
                    if (isPrivileged) {
                         const userFeaturedIds = userFeaturedTools.map(t => t.id);
                         filteredLibraryTools = filteredLibraryTools.filter(tool => !userFeaturedIds.includes(tool.id));
                    }

                    // Pass context 'library' to createListCard
                    contentHTML += filteredLibraryTools.length > 0 ? `<div class="list-container">${filteredLibraryTools.map(tool => createListCard(tool, 'library')).join('')}</div>` : `<div id="empty-state">${t.emptyFavorites}</div>`; // Use emptyFavorites for now, could add emptyUserTools state

                    contentArea.innerHTML = contentHTML;
                    
                    // Add event listeners for AI suggestions buttons
                    if (currentUser.uid) {
                        const addSuggestionBtn = document.getElementById('add-ai-suggestion-btn');
                        if (addSuggestionBtn) {
                            console.log('Adding event listener to add-ai-suggestion-btn');
                            addSuggestionBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                console.log('Add suggestion button clicked');
                                if (currentUser.uid) {
                                    console.log('Calling addAiSuggestion function');
                                    window.addAiSuggestion();
                                } else {
                                    triggerAuthFlow();
                                }
                            });
                        } else {
                            console.log('add-ai-suggestion-btn not found in DOM');
                        }
                    }
                }
                el.mainContent.appendChild(contentArea);
            }
            
            updateNavActiveState();
            applyTranslations(currentLanguage); // Apply translations after rendering content
        };

        const updateNavActiveState = () => el.bottomNav.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.page === currentView));
        
        // --- AUTHENTICATION FUNCTIONS (Copied from index.html and adapted) ---

        const getAuthHTML = (lang) => {
            const t = translations[lang];
            return `
            <div id="register-card" class="auth-card">
                <button class="auth-close-btn" data-action="close-auth">√ó</button>
                <svg class="auth-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="4" fill="none"/><text x="50" y="62" font-size="40" font-weight="bold" text-anchor="middle" fill="currentColor">AI</text></svg>
                <h2 data-translate="createAccount">${t.createAccount}</h2>
                <div class="input-group"><label for="register-nickname" data-translate="registerNicknameLabel">${t.registerNicknameLabel}</label><input type="text" id="register-nickname" placeholder="${t.registerNicknamePlaceholder}"></div>
                <div class="input-group"><label for="register-email" data-translate="registerEmailLabel">${t.registerEmailLabel}</label><input type="email" id="register-email" placeholder="${t.registerEmailPlaceholder}"></div>
                <div class="input-group"><label for="register-password" data-translate="registerPasswordLabel">${t.registerPasswordLabel}</label><input type="password" id="register-password" placeholder="${t.registerPasswordPlaceholder}"></div>
                <button id="register-btn" class="button" data-translate="registerButton">${t.registerButton}</button>
                <div class="auth-links"><a class="auth-switch-link" data-action="show-login" data-translate="switchToLogin">${t.switchToLogin}</a></div>
            </div>
            <div id="login-card" class="auth-card hidden">
                <button class="auth-close-btn" data-action="close-auth">√ó</button>
                <svg class="auth-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="4" fill="none"/><text x="50" y="62" font-size="40" font-weight="bold" text-anchor="middle" fill="currentColor">AI</text></svg>
                <h2 data-translate="loginTitle">${t.loginTitle}</h2>
                <div class="input-group"><label for="login-email" data-translate="registerEmailLabel">${t.registerEmailLabel}</label><input type="email" id="login-email" placeholder="${t.registerEmailPlaceholder}"></div>
                <div class="input-group"><label for="login-password" data-translate="registerPasswordLabel">${t.registerPasswordLabel}</label><input type="password" id="login-password" placeholder="${t.registerPasswordPlaceholder}"></div>
                <button id="login-btn" class="button" data-translate="loginButton">${t.loginButton}</button>
                <div class="auth-links"><a class="auth-switch-link" data-action="show-register" data-translate="switchToRegister">${t.switchToRegister}</a><a class="forgot-password-link" data-action="show-forgot" data-translate="forgotPasswordLink">${t.forgotPasswordLink}</a></div>
            </div>
            <div id="forgot-password-card" class="auth-card hidden">
                <button class="auth-close-btn" data-action="close-auth">√ó</button>
                <svg class="auth-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="4" fill="none"/><text x="50" y="62" font-size="40" font-weight="bold" text-anchor="middle" fill="currentColor">AI</text></svg>
                <h2 data-translate="resetPasswordTitle">${t.resetPasswordTitle}</h2>
                <p style="color: var(--spotify-text-secondary); font-size: 14px; margin-bottom: 20px;" data-translate="resetPasswordInfo">${t.resetPasswordInfo}</p>
                <div class="input-group"><label for="forgot-email" data-translate="registerEmailLabel">${t.registerEmailLabel}</label><input type="email" id="forgot-email" placeholder="${t.registerEmailPlaceholder}"></div>
                <button id="forgot-btn" class="button" data-translate="sendLinkButton">${t.sendLinkButton}</button>
                <div class="auth-links"><a class="auth-switch-link" data-action="show-login" data-translate="backToLogin">${t.backToLogin}</a></div>
            </div>`;
        };

        const showAuthCard = (cardId) => { 
            el.authOverlay.querySelectorAll('.auth-card').forEach(c => c.classList.add('hidden'));
            const cardToShow = el.authOverlay.querySelector('#' + cardId);
            if(cardToShow) cardToShow.classList.remove('hidden');
        };

        const attachAuthListeners = () => {
            // Remove previous listeners to avoid duplicates
            // This is a bit heavy, ideally use event delegation or remove specific listeners
            // For this structure, re-attaching to the overlay is simpler.
            // Ensure the overlay itself is the target for delegation.
            
            // Clear existing listeners by replacing the element (simple but effective)
            const oldAuthOverlay = el.authOverlay;
            const newAuthOverlay = oldAuthOverlay.cloneNode(true);
            oldAuthOverlay.parentNode.replaceChild(newAuthOverlay, oldAuthOverlay);
            el.authOverlay = newAuthOverlay;


            el.authOverlay.addEventListener('click', (e) => {
                const target = e.target;
                const actionTarget = target.closest('[data-action]');
                
                if(actionTarget) {
                     const action = actionTarget.dataset.action;
                     if (action === 'close-auth') { e.preventDefault(); closeAuthAndReturnToApp(); }
                     else if (action === 'show-login') { e.preventDefault(); showAuthCard('login-card'); }
                     else if (action === 'show-register') { e.preventDefault(); showAuthCard('register-card'); }
                     else if (action === 'show-forgot') { e.preventDefault(); showAuthCard('forgot-password-card'); }
                }

                // Handle button clicks directly (delegation is better but keeping original structure)
                if (target.id === 'register-btn') {
                    const nickname = el.authOverlay.querySelector('#register-nickname').value.trim();
                    const email = el.authOverlay.querySelector('#register-email').value;
                    const password = el.authOverlay.querySelector('#register-password').value;
                    const t = translations[currentLanguage];
                    if (!nickname) { showToast(t.nicknameRequired); return; }
                    if (!email.includes('@') || password.length < 6) { showToast(t.passwordTooShort); return; }
                    createUserWithEmailAndPassword(auth, email, password).then((userCredential) => {
                        // After successful registration, save nickname to Firestore
                        const userDocRef = doc(db, "users", userCredential.user.uid);
                        const initialUserData = { 
                            email: email,
                            nickname: nickname,
                            favorites: [],
                            userTools: [],
                            userFeaturedTools: [],
                            userFeaturedReplacements: {},
                            isPrivileged: false,
                            aiSuggestions: [] // New field for AI suggestions
                        };
                        setDoc(userDocRef, initialUserData).catch(e => console.error("Error creating user doc:", e));
                    }).catch(error => showToast(`Error: ${error.message}`));
                }
                if (target.id === 'login-btn') {
                     const email = el.authOverlay.querySelector('#login-email').value;
                    const password = el.authOverlay.querySelector('#login-password').value;
                    const t = translations[currentLanguage];
                    if (!email || !password) { showToast(t.registerEmailLabel + ' / ' + t.registerPasswordLabel); return; } // Simplified message
                    signInWithEmailAndPassword(auth, email, password).catch(error => showToast(`Error: ${error.message}`));
                }
                if (target.id === 'forgot-btn') {
                    const email = el.authOverlay.querySelector('#forgot-email').value;
                    const t = translations[currentLanguage];
                    if (!email.includes('@')) { showToast(t.registerEmailLabel); return; } // Simplified message
                    sendPasswordResetEmail(auth, email).then(() => {
                        showToast(t.passwordResetSent.replace('%s', email));
                        showAuthCard('login-card');
                    }).catch(error => showToast(`Error: ${error.message}`));
                }
            });
        };
        
        const triggerAuthFlow = (card = 'login-card') => {
            el.appContainer.style.display = 'none';
            el.authOverlay.innerHTML = getAuthHTML(currentLanguage); // Generate HTML
            attachAuthListeners(); // Attach listeners to the new HTML
            el.authOverlay.style.display = 'flex';
            el.authOverlay.classList.remove('hidden');
            showAuthCard(card); // Show the requested card
        };
        
        const closeAuthAndReturnToApp = () => {
            el.authOverlay.classList.add('hidden');
            el.authOverlay.addEventListener('transitionend', () => {
                 el.authOverlay.style.display = 'none';
                 el.authOverlay.innerHTML = ''; // Clear content after transition
            }, { once: true });
            el.appContainer.style.display = 'flex';
        };

        // --- SETTINGS MODAL FUNCTIONS (Copied from index.html and adapted) ---

        window.openSettingsModal = () => {
            if (!currentUser.uid) return;
            const t = translations[currentLanguage];
            
            const modalHTML = `
                <div id="settings-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <button class="modal-close-btn" data-action="close-modal">√ó</button>
                        <h2 data-translate="settingsTitle">${t.settingsTitle}</h2>
                        
                        <p style="font-size: 16px; color: var(--spotify-text-secondary); margin-top: 16px; margin-bottom: 24px;">${currentUser.name}</p>
                        
                        <hr class="modal-divider">

                        <h4 data-translate="changeNicknameTitle">${t.changeNicknameTitle}</h4>
                        <div class="input-group" style="margin-top: 16px;">
                            <label for="profile-nickname" data-translate="registerNicknameLabel">${t.registerNicknameLabel}</label>
                            <input type="text" id="profile-nickname" placeholder="${t.registerNicknamePlaceholder}" value="${currentUser.nickname || ''}">
                        </div>
                        <button class="button" id="update-nickname-btn" data-translate="saveNicknameButton">${t.saveNicknameButton}</button>

                        <hr class="modal-divider">

                        <h4 data-translate="changePasswordTitle">${t.changePasswordTitle}</h4>
                        <div class="input-group" style="margin-top: 16px;">
                            <label for="profile-new-password" data-translate="newPasswordLabel">${t.newPasswordLabel}</label>
                            <input type="password" id="profile-new-password" placeholder="${t.newPasswordPlaceholder}">
                        </div>
                        <div class="input-group">
                            <label for="profile-confirm-password" data-translate="confirmPasswordLabel">${t.confirmPasswordLabel}</label>
                            <input type="password" id="profile-confirm-password" placeholder="${t.confirmPasswordPlaceholder}">
                        </div>
                        <button class="button" id="update-password-btn" data-translate="savePasswordButton">${t.savePasswordButton}</button>

                         <hr class="modal-divider">
                         <button id="logout-btn-modal" class="pill-btn" data-action="logout" data-translate="logout">${t.logout}</button>

                    </div>
                </div>`;
            el.modalContainer.innerHTML = modalHTML;

            // Attach listener to the update nickname button
            document.getElementById('update-nickname-btn')?.addEventListener('click', handleNicknameUpdate);
            // Attach listener to the update password button
            document.getElementById('update-password-btn')?.addEventListener('click', handlePasswordUpdate);
             // Attach listener to the logout button inside the modal
            document.getElementById('logout-btn-modal')?.addEventListener('click', () => {
                 signOut(auth).catch(error => console.error("Logout Error:", error));
                 closeModal(); // Close modal on logout attempt
            });
        };
        
        const handleNicknameUpdate = async () => {
            const nicknameInput = document.getElementById('profile-nickname');
            const newNickname = nicknameInput.value.trim();
            const t = translations[currentLanguage];

            if (!newNickname) {
                showToast(t.nicknameRequired);
                return;
            }

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, { nickname: newNickname });
                currentUser.nickname = newNickname;
                showToast(t.nicknameUpdateSuccess);
                closeModal(); // Close modal on success
            } catch (error) {
                console.error("Error updating nickname:", error);
                showToast(`Error: ${error.message}`);
            }
        };

        const handlePasswordUpdate = async () => {
            const newPasswordInput = document.getElementById('profile-new-password');
            const confirmPasswordInput = document.getElementById('profile-confirm-password');
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            const t = translations[currentLanguage];

            if (newPassword.length < 6) {
                showToast(t.passwordTooShort);
                return;
            }
            if (newPassword !== confirmPassword) {
                showToast(t.passwordsDoNotMatch);
                return;
            }

            try {
                await updatePassword(auth.currentUser, newPassword);
                showToast(t.passwordUpdateSuccess);
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
                closeModal(); // Close modal on success
            } catch (error) {
                console.error("Error updating password:", error);
                showToast(t.updatePasswordError.replace('%s', error.message));
            }
        };

        // NEW FUNCTION: Open Add App Modal
        const openAddAppModal = () => {
             // Check privileged status loaded from Firestore
             if (!currentUser.uid || !currentUser.isPrivileged) return;
             const t = translations[currentLanguage];

             // Get available categories for the dropdown
             const categoryOptions = categories.map(cat => 
                 `<option value="${cat.id}">${cat.name[currentLanguage]}</option>`
             ).join('');

             const modalHTML = `
                 <div id="add-app-modal" class="modal-overlay visible">
                     <div class="modal-content">
                         <button class="modal-close-btn" data-action="close-modal">√ó</button>
                         <h2 data-translate="addAppTitle">${t.addAppTitle}</h2>

                         <div class="input-group" style="margin-top: 24px;">
                             <label for="add-app-name" data-translate="appNameLabel">${t.appNameLabel}</label>
                             <input type="text" id="add-app-name" placeholder="${t.appNamePlaceholder}">
                         </div>
                         <div class="input-group">
                             <label for="add-app-description" data-translate="appDescriptionLabel">${t.appDescriptionLabel}</label>
                             <textarea id="add-app-description" placeholder="${t.appDescriptionPlaceholder}"></textarea>
                         </div>
                         <div class="input-group">
                             <label for="add-app-website" data-translate="appWebsiteLabel">${t.appWebsiteLabel}</label>
                             <input type="url" id="add-app-website" placeholder="${t.appWebsitePlaceholder}">
                         </div>
                         <div class="input-group">
                             <label for="add-app-logo" data-translate="appLogoLabel">${t.appLogoLabel}</label>
                             <input type="file" id="add-app-logo" accept="image/*">
                             <img id="add-app-logo-preview" src="" alt="Logo Preview" style="display: none;">
                         </div>
                         <div class="input-group">
                             <label for="add-app-category" data-translate="category">${t.category}</label>
                             <select id="add-app-category" style="width: 100%; padding: 14px 16px; font-size: 16px; background-color: var(--spotify-bg-light); border: 1px solid rgba(128,128,128,0.2); border-radius: 8px; color: var(--spotify-text);">
                                 ${categoryOptions}
                             </select>
                         </div>

                         <button class="button" id="add-app-btn" data-translate="addAppButton">${t.addAppButton}</button>
                     </div>
                 </div>
             `;
             el.modalContainer.innerHTML = modalHTML;

             // Attach listener to the add app button
             document.getElementById('add-app-btn')?.addEventListener('click', handleAddApp);

             // Attach listener for file input change to show preview
             const logoInput = document.getElementById('add-app-logo');
             const logoPreview = document.getElementById('add-app-logo-preview');
             logoInput.addEventListener('change', (event) => {
                 const file = event.target.files[0];
                 if (file) {
                     const reader = new FileReader();
                     reader.onload = (e) => {
                         logoPreview.src = e.target.result;
                         logoPreview.style.display = 'block';
                     };
                     reader.readAsDataURL(file);
                 } else {
                     logoPreview.src = '';
                     logoPreview.style.display = 'none';
                 }
             });
        };

        // NEW FUNCTION: Open Change Nickname Modal
        const openChangeNicknameModal = () => {
            if (!currentUser.uid) return;
            const t = translations[currentLanguage];
            
            const modalHTML = `
                <div id="change-nickname-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <button class="modal-close-btn" data-action="close-modal">√ó</button>
                        <h2 data-translate="changeNicknameTitle">${t.changeNicknameTitle}</h2>
                        
                        <div class="input-group" style="margin-top: 24px;">
                            <label for="change-nickname-input" data-translate="registerNicknameLabel">${t.registerNicknameLabel}</label>
                            <input type="text" id="change-nickname-input" placeholder="${t.registerNicknamePlaceholder}" value="${currentUser.nickname || ''}">
                        </div>
                        <button class="button" id="save-nickname-btn" data-translate="saveNicknameButton">${t.saveNicknameButton}</button>
                    </div>
                </div>`;
            el.modalContainer.innerHTML = modalHTML;

            // Attach listener to the save nickname button
            document.getElementById('save-nickname-btn')?.addEventListener('click', handleChangeNickname);
        };

        // NEW FUNCTION: Open Change Password Modal
        const openChangePasswordModal = () => {
            if (!currentUser.uid) return;
            const t = translations[currentLanguage];
            
            const modalHTML = `
                <div id="change-password-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <button class="modal-close-btn" data-action="close-modal">√ó</button>
                        <h2 data-translate="changePasswordTitle">${t.changePasswordTitle}</h2>
                        
                        <div class="input-group" style="margin-top: 24px;">
                            <label for="change-new-password" data-translate="newPasswordLabel">${t.newPasswordLabel}</label>
                            <input type="password" id="change-new-password" placeholder="${t.newPasswordPlaceholder}">
                        </div>
                        <div class="input-group">
                            <label for="change-confirm-password" data-translate="confirmPasswordLabel">${t.confirmPasswordLabel}</label>
                            <input type="password" id="change-confirm-password" placeholder="${t.confirmPasswordPlaceholder}">
                        </div>
                        <button class="button" id="save-password-btn" data-translate="savePasswordButton">${t.savePasswordButton}</button>
                    </div>
                </div>`;
            el.modalContainer.innerHTML = modalHTML;

            // Attach listener to the save password button
            document.getElementById('save-password-btn')?.addEventListener('click', handleChangePassword);
        };

        // NEW FUNCTION: Handle Change Nickname
        const handleChangeNickname = async () => {
            const nicknameInput = document.getElementById('change-nickname-input');
            const newNickname = nicknameInput.value.trim();
            const t = translations[currentLanguage];

            if (!newNickname) {
                showToast(t.nicknameRequired);
                return;
            }

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, { nickname: newNickname });
                currentUser.nickname = newNickname;
                showToast(t.nicknameUpdateSuccess);
                closeModal();
            } catch (error) {
                console.error("Error updating nickname:", error);
                showToast(`Error: ${error.message}`);
            }
        };

        // NEW FUNCTION: Handle Change Password
        const handleChangePassword = async () => {
            const newPasswordInput = document.getElementById('change-new-password');
            const confirmPasswordInput = document.getElementById('change-confirm-password');
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            const t = translations[currentLanguage];

            if (newPassword.length < 6) {
                showToast(t.passwordTooShort);
                return;
            }
            if (newPassword !== confirmPassword) {
                showToast(t.passwordsDoNotMatch);
                return;
            }

            try {
                await updatePassword(auth.currentUser, newPassword);
                showToast(t.passwordUpdateSuccess);
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
                closeModal();
            } catch (error) {
                console.error("Error updating password:", error);
                showToast(t.updatePasswordError.replace('%s', error.message));
            }
        };

        // NEW FUNCTION: Open Replace Featured Modal
        const openReplaceFeaturedModal = (staticToolId) => {
             // Check privileged status loaded from Firestore
             if (!currentUser.uid || !currentUser.isPrivileged) return;
             const t = translations[currentLanguage];
             const userTools = currentUser.userTools || [];

             const toolListHTML = userTools.length > 0 ? userTools.map(tool => `
                 <div class="tool-list-item" data-action="select-user-tool-for-featured" data-static-id="${staticToolId}" data-user-id="${tool.id}">
                     <img src="${tool.logoUrl}" alt="${tool.name}" loading="lazy">
                     <div class="info">
                         <div class="tool-name">${tool.name}</div>
                         <div class="tool-subtext">${getTranslatedCategoryName(tool.category)}</div>
                     </div>
                 </div>
             `).join('') : `<div id="empty-state" style="padding: 20px 0;">${t.noUserApps}</div>`;


             const modalHTML = `
                 <div id="replace-featured-modal" class="modal-overlay visible">
                     <div class="modal-content">
                         <button class="modal-close-btn" data-action="close-modal">√ó</button>
                         <h2 data-translate="replaceFeaturedTitle">${t.replaceFeaturedTitle}</h2>
                         <p style="color: var(--spotify-text-secondary); font-size: 14px; margin-bottom: 20px;" data-translate="selectAppToFeature">${t.selectAppToFeature}</p>
                         <div class="list-container">
                             ${toolListHTML}
                         </div>
                     </div>
                 </div>
             `;
             el.modalContainer.innerHTML = modalHTML;
        };


        // NEW FUNCTION: Handle Add App submission (Firestore)
        const handleAddApp = async () => { // Made async again for Firestore
             // Check privileged status loaded from Firestore
             if (!currentUser.uid || !currentUser.isPrivileged) return;

             const nameInput = document.getElementById('add-app-name');
             const descInput = document.getElementById('add-app-description');
             const websiteInput = document.getElementById('add-app-website');
             const logoInput = document.getElementById('add-app-logo'); // This is now the file input
             const categorySelect = document.getElementById('add-app-category');

             const name = nameInput.value.trim();
             const description = descInput.value.trim();
             const website = websiteInput.value.trim();
             const file = logoInput.files[0]; // Get the selected file
             const category = categorySelect.value;
             const t = translations[currentLanguage];

             if (!name) { showToast(t.appNameRequired); return; }
             if (!website) { showToast(t.appWebsiteRequired); return; }
             if (!file) { showToast(t.appLogoRequired); return; } // Check if a file is selected

             // Read the file as a Data URL (Base64)
             const logoUrl = await new Promise((resolve, reject) => {
                 const reader = new FileReader();
                 reader.onloadend = () => resolve(reader.result);
                 reader.onerror = reject;
                 reader.readAsDataURL(file);
             });

             const newTool = {
                 id: `user-${currentUser.uid}-${Date.now()}`, // Unique ID for user tools
                 name: name,
                 description: description || { it: 'Descrizione non fornita.', en: 'Description not provided.' }, // Allow empty desc, provide default
                 website: website,
                 logoUrl: logoUrl, // This is now the Base64 string
                 category: category,
                 country: 'User Added', // Indicate origin
                 // isFeatured: false, // This flag is not used for user tools featured status
                 // recommendationId: null // User tools don't recommend others by default
             };

             const userDocRef = doc(db, "users", currentUser.uid);

             try {
                 // Add the new tool to the userTools array in Firestore
                 await updateDoc(userDocRef, {
                     userTools: arrayUnion(newTool)
                 });
                 // Update local state after successful Firestore update
                 currentUser.userTools = [...(currentUser.userTools || []), newTool];

                 showToast(t.addAppSuccess);
                 closeModal(); // Close modal on success
                 renderView(); // Re-render Library view
             } catch (error) {
                 console.error("Error adding user tool:", error);
                 showToast(t.addAppError.replace('%s', error.message)); // Use generic error message
             }
        };

        // NEW FUNCTION: Add AI Suggestion
        window.addAiSuggestion = async () => {
            console.log('addAiSuggestion function called');
            if (!currentUser.uid) {
                console.log('No user logged in, returning');
                return;
            }
            
            const t = translations[currentLanguage];
            console.log('Creating AI suggestion modal');
            
            // Create modal for AI suggestion form
            const modalHTML = `
                <div id="add-ai-suggestion-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <button class="modal-close-btn" data-action="close-modal">√ó</button>
                        <h2>${t.addAiSuggestionTitle}</h2>
                        
                        <form id="ai-suggestion-form">
                            <div class="form-group">
                                <label for="app-name">${t.appNameLabel} *</label>
                                <input type="text" id="app-name" required placeholder="${t.appNamePlaceholder}">
                            </div>
                            
                            <div class="form-group">
                                <label for="app-description">${t.appDescriptionLabel} *</label>
                                <textarea id="app-description" required placeholder="${t.appDescriptionPlaceholder}" rows="4"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="app-website">${t.appWebsiteLabel} *</label>
                                <input type="url" id="app-website" required placeholder="${t.appWebsitePlaceholder}">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="app-category">${t.category} *</label>
                                    <select id="app-category" required>
                                        <option value="">${t.selectCategory}</option>
                                        <option value="Testo">Testo</option>
                                        <option value="Immagini">Immagini</option>
                                        <option value="Video">Video</option>
                                        <option value="Audio">Audio</option>
                                        <option value="Codice">Codice</option>
                                        <option value="Presentazioni">Presentazioni</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="app-country">${t.country} *</label>
                                    <select id="app-country" required>
                                        <option value="">${t.selectCountry}</option>
                                        <option value="USA">USA</option>
                                        <option value="Cina">Cina</option>
                                        <option value="Europe">Europe</option>
                                        <option value="Italia">Italia</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="button secondary" data-action="close-modal">${t.cancel}</button>
                                <button type="submit" class="button primary">${t.addAiSuggestionButton}</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            
            el.modalContainer.innerHTML = modalHTML;
            
            // Add form submit handler
            document.getElementById('ai-suggestion-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const appName = document.getElementById('app-name').value.trim();
                const appDescription = document.getElementById('app-description').value.trim();
                const appWebsite = document.getElementById('app-website').value.trim();
                const appCategory = document.getElementById('app-category').value;
                const appCountry = document.getElementById('app-country').value;
                
                if (!appName || !appDescription || !appWebsite || !appCategory || !appCountry) {
                    showToast(t.allFieldsRequired);
                    return;
                }

                // Validate URL format
                try {
                    new URL(appWebsite);
                } catch (e) {
                    showToast("Inserisci un URL valido (es. https://example.com)");
                    return;
                }

                try {
                    // Show loading state
                    const submitBtn = document.querySelector('#ai-suggestion-form button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Salvando...';
                    submitBtn.disabled = true;

                    const userDocRef = doc(db, "users", currentUser.uid);
                    const newSuggestion = {
                        id: `suggestion-${currentUser.uid}-${Date.now()}`,
                        appName: appName,
                        description: appDescription,
                        website: appWebsite,
                        category: appCategory,
                        country: appCountry,
                        timestamp: Date.now()
                    };
                    
                    await updateDoc(userDocRef, {
                        aiSuggestions: arrayUnion(newSuggestion)
                    });
                    
                    // Update local state
                    currentUser.aiSuggestions = [...(currentUser.aiSuggestions || []), newSuggestion];
                    
                    showToast(t.aiSuggestionAdded);
                    closeModal();
                    renderView(); // Re-render to show the new suggestion
                } catch (error) {
                    console.error("Error adding AI suggestion:", error);
                    showToast(`Error: ${error.message}`);
                } finally {
                    // Reset button state
                    const submitBtn = document.querySelector('#ai-suggestion-form button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = t.addAiSuggestionButton;
                        submitBtn.disabled = false;
                    }
                }
            });
        };

        // NEW FUNCTION: Remove AI Suggestion
        const removeAiSuggestion = async (suggestionId) => {
            if (!currentUser.uid) return;
            
            const t = translations[currentLanguage];
            const userDocRef = doc(db, "users", currentUser.uid);

            try {
                const updatedSuggestions = (currentUser.aiSuggestions || []).filter(s => s.id !== suggestionId);
                await updateDoc(userDocRef, {
                    aiSuggestions: updatedSuggestions
                });
                currentUser.aiSuggestions = updatedSuggestions;
                showToast(t.aiSuggestionRemoved);
                renderView(); // Re-render to update the list
            } catch (error) {
                console.error("Error removing AI suggestion:", error);
                showToast(`Error: ${error.message}`);
            }
        };

        // NEW FUNCTION: Search Users (for button click)
        const searchUsers = async () => {
            if (!currentUser.uid) return;
            
            const searchInput = document.getElementById('user-search-input');
            const searchTerm = searchInput.value.trim();
            const t = translations[currentLanguage];

            if (!searchTerm) {
                showToast("Inserisci un nickname da cercare.");
                return;
            }

            await searchUsersByTerm(searchTerm);
        };

        // NEW FUNCTION: Create Test Users (for debugging)
        const createTestUsers = async () => {
            if (!currentUser.uid) return;
            
            try {
                const testUsers = [
                    {
                        email: "mario.rossi@test.com",
                        nickname: "Mario",
                        aiSuggestions: [
                            { 
                                id: "test-1",
                                appName: "ChatGPT",
                                description: "Perfetto per la scrittura creativa e conversazioni",
                                website: "https://chatgpt.com/",
                                category: "Testo",
                                country: "USA",
                                timestamp: Date.now()
                            },
                            { 
                                id: "test-2",
                                appName: "Midjourney",
                                description: "Genera immagini artistiche di alta qualit√†",
                                website: "https://www.midjourney.com/",
                                category: "Immagini",
                                country: "USA",
                                timestamp: Date.now() - 86400000
                            }
                        ]
                    },
                    {
                        email: "lucia.bianchi@test.com", 
                        nickname: "Lucia",
                        aiSuggestions: [
                            { 
                                id: "test-3",
                                appName: "Claude",
                                description: "Eccellente per la programmazione e sviluppo",
                                website: "https://claude.ai/",
                                category: "Codice",
                                country: "USA",
                                timestamp: Date.now()
                            },
                            { 
                                id: "test-4",
                                appName: "Google AI Studio",
                                description: "Per creare app e prototipi con Gemini",
                                website: "https://aistudio.google.com/",
                                category: "Codice",
                                country: "USA",
                                timestamp: Date.now() - 172800000
                            },
                            { 
                                id: "test-5",
                                appName: "Perplexity",
                                description: "La migliore AI per la ricerca web",
                                website: "https://www.perplexity.ai/",
                                category: "Testo",
                                country: "USA",
                                timestamp: Date.now() - 259200000
                            }
                        ]
                    },
                    {
                        email: "giovanni.verdi@test.com",
                        nickname: "Giovanni",
                        aiSuggestions: [
                            { 
                                id: "test-6",
                                appName: "Leonardo AI",
                                description: "Perfetto per asset di gioco e concept art",
                                website: "https://leonardo.ai/",
                                category: "Immagini",
                                country: "USA",
                                timestamp: Date.now()
                            }
                        ]
                    }
                ];

                for (const testUser of testUsers) {
                    const userDocRef = doc(db, "users", `test-${Date.now()}-${Math.random()}`);
                    await setDoc(userDocRef, testUser);
                }
                
                showToast("Utenti di test creati!");
            } catch (error) {
                console.error("Error creating test users:", error);
                showToast(`Error: ${error.message}`);
            }
        };

        // NEW FUNCTION: Search Users By Term (for real-time search)
        const searchUsersByTerm = async (searchTerm) => {
            if (!currentUser.uid) return;
            
            const t = translations[currentLanguage];
            const searchResults = document.getElementById('user-search-results');
            
            if (!searchResults) return;
            
            if (!searchTerm || searchTerm.trim().length < 2) {
                searchResults.innerHTML = '';
                return;
            }

            try {
                // Search for users by nickname in Firestore
                const usersRef = collection(db, "users");
                const searchTermLower = searchTerm.toLowerCase();
                
                // Get all users and filter client-side for better search
                const querySnapshot = await getDocs(usersRef);
                
                if (querySnapshot.empty) {
                    searchResults.innerHTML = `<div id="empty-state">${t.noUsersFound}</div>`;
                    return;
                }

                const users = [];
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (doc.id !== currentUser.uid) { // Don't show current user
                        const nickname = userData.nickname || userData.email || '';
                        const email = userData.email || '';
                        
                        // Search in both nickname and email
                        if (nickname.toLowerCase().includes(searchTermLower) || 
                            email.toLowerCase().includes(searchTermLower)) {
                            users.push({
                                uid: doc.id,
                                nickname: userData.nickname || userData.email?.split('@')[0] || 'Utente',
                                email: userData.email || '',
                                aiSuggestions: userData.aiSuggestions || []
                            });
                        }
                    }
                });

                // Limit results to first 10 users
                const limitedUsers = users.slice(0, 10);

                if (limitedUsers.length === 0) {
                    searchResults.innerHTML = `<div id="empty-state">${t.noUsersFound}</div>`;
                    return;
                }

                const usersHTML = limitedUsers.map(user => `
                    <div class="user-search-result" data-uid="${user.uid}">
                        <div class="user-info">
                            <div class="user-nickname">${user.nickname}</div>
                            <div class="user-email">${user.email}</div>
                            <div class="user-suggestions-count">${user.aiSuggestions.length} ${user.aiSuggestions.length === 1 ? t.suggestion : t.suggestions}</div>
                        </div>
                        <div class="user-actions">
                            <button class="view-suggestions-btn" data-action="view-user-suggestions" data-uid="${user.uid}" data-nickname="${user.nickname}">
                                ${t.viewSuggestions}
                            </button>
                            <button class="chat-button" data-action="start-user-chat" data-uid="${user.uid}" data-nickname="${user.nickname}">
                                <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16" fill="currentColor">
                                    <path d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                                </svg>
                                ${t.startChat}
                            </button>
                        </div>
                    </div>
                `).join('');

                // Add message if there are more results
                const moreResultsMessage = users.length > 10 ? `<div style="text-align: center; color: var(--spotify-text-secondary); font-size: 12px; margin-top: 8px;">Mostrando i primi 10 risultati di ${users.length}</div>` : '';

                searchResults.innerHTML = usersHTML + moreResultsMessage;
            } catch (error) {
                console.error("Error searching users:", error);
                showToast(`Error: ${error.message}`);
            }
        };

        // NEW FUNCTION: View User Suggestions
                // NEW FUNCTION: Search Users for Chat
                // NEW FUNCTION: Search Users for Chat
                const searchUsersForChat = async (searchTerm, currentUserId) => {
            const resultsContainer = document.getElementById('user-chat-search-results');
            if (!resultsContainer) return;

            const t = translations[currentLanguage];
            if (!searchTerm || searchTerm.trim().length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }

            try {
                const usersRef = collection(db, "users");
                const searchTermLower = searchTerm.toLowerCase();
                const querySnapshot = await getDocs(usersRef);

                const users = [];
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (doc.id !== currentUserId) { // Escludi l'utente corrente
                        const nickname = userData.nickname || '';
                        if (nickname.toLowerCase().includes(searchTermLower)) {
                            users.push({
                                uid: doc.id,
                                nickname: userData.nickname,
                                aiSuggestions: userData.aiSuggestions || [] // Recuperiamo i suggerimenti
                            });
                        }
                    }
                });

                if (users.length === 0) {
                    resultsContainer.innerHTML = `<div id="empty-state">${t.noUsersFound}</div>`;
                    return;
                }

                // Aggiunto il conteggio suggerimenti e il pulsante "Vedi Suggerimenti"
                resultsContainer.innerHTML = users.slice(0, 10).map(user => `
                    <div class="user-search-result">
                        <div class="user-info" style="cursor: pointer;" onclick="window.viewUserSuggestions('${user.uid}', '${user.nickname}')" title="${t.viewSuggestions}">
                            <div class="user-nickname">${user.nickname}</div>
                            <div class="user-suggestions-count">${user.aiSuggestions.length} ${user.aiSuggestions.length === 1 ? t.suggestion : t.suggestions}</div>
                        </div>
                        <div class="user-actions">
                             <button class="view-suggestions-btn" onclick="window.viewUserSuggestions('${user.uid}', '${user.nickname}')">
                                ${t.viewSuggestions}
                            </button>
                            <button class="chat-button" onclick="window.handleReactChatStart('${user.uid}', '${user.nickname}')">
                                <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24" width="16" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                                ${t.startChat}
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error("Error searching users for chat:", error);
                resultsContainer.innerHTML = `<div id="empty-state">Error searching users.</div>`;
            }
        };
        window.searchUsersForChat = searchUsersForChat;


// NEW FUNCTION: View User Suggestions
const viewUserSuggestions = async (userId, userNickname) => {
            if (!currentUser.uid) return;
            
            const t = translations[currentLanguage];
            
            try {
                const userDocRef = doc(db, "users", userId);
                const userDocSnap = await getDoc(userDocRef);
                
                if (!userDocSnap.exists()) {
                    showToast("Utente non trovato.");
                    return;
                }
                
                const userData = userDocSnap.data();
                const suggestions = userData.aiSuggestions || [];
                
                const modalHTML = `
                    <div id="user-suggestions-modal" class="modal-overlay visible">
                        <div class="modal-content" style="max-width: 600px;">
                            <button class="modal-close-btn" data-action="close-modal">√ó</button>
                            <h2>${t.userSuggestionsTitle.replace('%s', userNickname)}</h2>
                            <div class="suggestions-list">
                                ${suggestions.length > 0 ? suggestions.map(suggestion => {
                                    // Handle both old format (text) and new format (appName, description, etc.)
                                    if (suggestion.text) {
                                        // Old format - show as simple text
                                        return `
                                            <div class="suggestion-item old-format">
                                                <div class="suggestion-text">${suggestion.text}</div>
                                                <div class="suggestion-date">${new Date(suggestion.timestamp).toLocaleDateString()}</div>
                                            </div>
                                        `;
                                    } else {
                                        // New format - show as app card
                                        return `
                                            <div class="suggestion-item new-format">
                                                <div class="suggestion-header">
                                                    <h3 class="suggestion-app-name">${suggestion.appName}</h3>
                                                    <div class="suggestion-meta">
                                                        <span class="suggestion-category">${suggestion.category}</span>
                                                        <span class="suggestion-country">${suggestion.country}</span>
                                                    </div>
                                                </div>
                                                <div class="suggestion-description">${suggestion.description}</div>
                                                <div class="suggestion-actions">
                                                    <a href="${suggestion.website}" target="_blank" class="suggestion-website-btn">
                                                        üåê ${t.visitWebsite}
                                                    </a>
                                                    <div class="suggestion-date">${new Date(suggestion.timestamp).toLocaleDateString()}</div>
                                                </div>
                                            </div>
                                        `;
                                    }
                                }).join('') : `<div id="empty-state">${t.noSuggestions}</div>`}
                            </div>
                        </div>
                    </div>`;
                
                el.modalContainer.innerHTML = modalHTML;
            } catch (error) {
                console.error("Error viewing user suggestions:", error);
                showToast(`Error: ${error.message}`);
            }
        };

        // NEW FUNCTION: Start User Chat
        const startUserChat = async (userId, userNickname) => {
            if (!currentUser.uid) return;
            
            try {
                // Create or get existing chat
                const chatId = await getOrCreateChat(currentUser.uid, userId);
                
                // Navigate to user-chats view
                currentView = 'user-chats';
                renderView();
                
                // If the user chat app is mounted, trigger the start chat function
                if (window.startUserChat) {
                    window.startUserChat(userId, userNickname);
                }
            } catch (error) {
                console.error("Error starting user chat:", error);
                showToast(`Error: ${error.message}`);
            }
        };


        // --- INITIALIZATION LOGIC ---

        const initializeAppForGuest = () => {
            // Initialize currentUser with default empty state
            currentUser = { uid: null, name: 'Guest', nickname: 'Guest', favorites: [], isPrivileged: false, userTools: [], userFeaturedTools: [], userFeaturedReplacements: {}, aiSuggestions: [] };
            loadConversations();
            unmountReactApp();
            el.appContainer.style.display = 'flex';
            el.authOverlay.style.display = 'none';
            el.authOverlay.innerHTML = ''; // Ensure auth overlay is empty
            renderView();
        };

        const initializeAppWithUser = async (user) => {
            const userDocRef = doc(db, "users", user.uid);
            try {
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) { 
                    // Fetch all user data from Firestore
                    const data = userDocSnap.data();
                    currentUser = { 
                        uid: user.uid, 
                        name: user.email, // Use email as name for now
                        nickname: data.nickname || user.email.split('@')[0], // Use nickname or email prefix as fallback
                        favorites: data.favorites || [],
                        userTools: data.userTools || [],
                        userFeaturedTools: data.userFeaturedTools || [],
                        userFeaturedReplacements: data.userFeaturedReplacements || {}, // Fetch replacements
                        isPrivileged: data.isPrivileged || false, // Load privileged status from Firestore
                        aiSuggestions: data.aiSuggestions || [] // Load AI suggestions
                    }; 
                } else { 
                    // Create user doc if it doesn't exist with initial empty arrays and non-privileged status
                    const initialUserData = { 
                             email: user.email,
                             nickname: user.email.split('@')[0], // Use email prefix as default nickname
                             favorites: [],
                             userTools: [],
                             userFeaturedTools: [],
                             userFeaturedReplacements: {}, // Initialize replacements
                             isPrivileged: false, // Default to non-privileged
                             aiSuggestions: [] // Initialize AI suggestions
                         };
                         await setDoc(userDocRef, initialUserData).catch(e => console.error("Error creating user doc:", e));
                         currentUser = { uid: user.uid, name: user.email, ...initialUserData }; 
                }
            } catch (error) {
                 console.error("Error fetching user data:", error);
                 // Fallback to minimal user data if Firestore fails
                 currentUser = { uid: user.uid, name: user.email, favorites: [], userTools: [], userFeaturedTools: [], userFeaturedReplacements: {}, isPrivileged: false };
                 showToast("Could not load user data."); // Inform user
            }

            loadConversations();
            el.authOverlay.classList.add('hidden');
            el.authOverlay.addEventListener('transitionend', () => {
                 el.authOverlay.style.display = 'none';
                 el.authOverlay.innerHTML = ''; // Clear content after transition
            }, { once: true });
            el.appContainer.style.display = 'flex';
            renderView(); // Render the app view
        };

        // Apply theme on initial load
        document.body.classList.toggle('light-mode', currentTheme === 'light');

        // --- MAIN EVENT LISTENER ---
        document.body.addEventListener('click', (e) => {
            const target = e.target;

            // 1. Handle navigation buttons FIRST
            const navBtn = target.closest('.nav-btn');
            if (navBtn && navBtn.dataset.page !== currentView) {
                currentView = navBtn.dataset.page;
                // Reset filters when changing main pages
                activeFilter = 'All'; exploreFilter = { type: null, value: null }; rankingFilter = 'All'; // Reset all filters
                renderView();
                el.mainContent.scrollTop = 0; // Scroll to top on page change
                e.preventDefault(); // Prevent default link behavior
                return; // Stop processing
            }

            // 2. Handle the K button click (specific element, specific logic)
            const kButton = target.closest('#privileged-unlock-btn');
            // Check if user is logged in AND NOT already privileged (status loaded from Firestore)
            if (kButton && currentUser.uid && !currentUser.isPrivileged) {
                 const now = Date.now();
                 if (now - lastKButtonClickTime > K_BUTTON_CLICK_RESET_DELAY) {
                     kButtonClickCount = 0; // Reset if clicks are too slow
                 }
                 kButtonClickCount++;
                 lastKButtonClickTime = now;

                 // Clear any previous timeout and set a new one
                 clearTimeout(kButtonClickTimeout);
                 kButtonClickTimeout = setTimeout(() => {
                     kButtonClickCount = 0; // Reset count after delay if no new click occurs
                 }, K_BUTTON_CLICK_RESET_DELAY);

                 console.log(`K button clicked: ${kButtonClickCount} times`);

                 if (kButtonClickCount >= K_BUTTON_CLICK_THRESHOLD) {
                     kButtonClickCount = 0; // Reset immediately after unlocking
                     lastKButtonClickTime = 0;
                     clearTimeout(kButtonClickTimeout); // Clear the reset timeout

                     // Unlock privileged mode in Firestore
                     const userDocRef = doc(db, "users", currentUser.uid);
                     updateDoc(userDocRef, { isPrivileged: true })
                         .then(() => {
                             currentUser.isPrivileged = true; // Update local state after successful Firestore update
                             showToast(translations[currentLanguage].privilegedUnlocked);
                             // Re-render the view to show the "Add Custom App" button and featured section
                             renderView(); 
                         })
                         .catch(error => {
                             console.error("Error unlocking privileged mode:", error);
                             showToast(`Error unlocking feature: ${error.message}`);
                         });
                 }
                 e.preventDefault(); // Prevent default button click behavior
                 return; // Stop processing
            }


            // 3. Handle elements with data-action (excluding the K button which is handled above)
            const actionTarget = target.closest('[data-action]');
            if (actionTarget && actionTarget.id !== 'privileged-unlock-btn') { // Explicitly exclude K button
                const action = actionTarget.dataset.action;
                
                switch(action) {
                    // Global Controls
                    case 'toggle-theme':
                        // Cambia il tema
                        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                        document.body.classList.toggle('light-mode', currentTheme === 'light');
                        localStorage.setItem('koda-theme', currentTheme);
                        
                        // Aggiorna l'icona del tema manualmente senza ri-renderizzare tutto
                        const themeBtn = document.getElementById('theme-toggle-btn');
                        if (themeBtn) {
                            themeBtn.innerHTML = currentTheme === 'dark' ? sunIcon : moonIcon;
                        }
                        break;
                    case 'toggle-lang':
                        // Cambia la lingua a livello globale
                        currentLanguage = currentLanguage === 'it' ? 'en' : 'it';
                        localStorage.setItem('koda-lang', currentLanguage);
                        
                        // Aggiorna il testo del pulsante stesso
                        const langBtn = document.getElementById('lang-toggle-btn');
                        if(langBtn) {
                           langBtn.textContent = currentLanguage.toUpperCase();
                        }

                        // Applica le traduzioni agli elementi HTML non gestiti da React
                        applyTranslations(currentLanguage);

                        // **NUOVA LOGICA:** Se siamo nella vista chat e la funzione-ponte esiste,
                        // la usiamo per aggiornare lo stato interno di React senza ricaricare.
                        if (currentView === 'user-chats' && typeof window.updateUserChatLanguage === 'function') {
                            window.updateUserChatLanguage(currentLanguage);
                        } else {
                            // Altrimenti, per tutte le altre pagine, eseguiamo un re-render completo
                            renderView();
                        }
                        break;
                    case 'toggle-menu':
                         toggleSideMenu(true);
                         break;
                    case 'open-settings-modal':
                         if (!currentUser.uid) { triggerAuthFlow(); } else { window.openSettingsModal(); }
                         break;
                    case 'logout':
                         signOut(auth).catch(error => console.error("Logout Error:", error));
                         break; // Rimuovi il logout dal global controls

                    // Side Menu
                    case 'new-chat': startNewChat(); break;
                    case 'delete-all-chats':
                        const t = translations[currentLanguage];
                        if (confirm(t.confirmDeleteAll)) {
                            conversations = {};
                            localStorage.removeItem(getStorageKey());
                            localStorage.removeItem(`activeConversationId_${currentUser.uid || 'guest'}`);
                            startNewChat(true); // Start a new chat and re-render
                        }
                        break;
                    case 'select-conversation':
                        const newActiveId = actionTarget.dataset.id;
                        if (newActiveId !== activeConversationId) {
                            activeConversationId = newActiveId;
                            saveActiveConversationId();
                            renderView(); // Re-render with the selected conversation
                        }
                        toggleSideMenu(false); // Close menu
                        break;

                    // Auth Prompts (from Library page)
                    case 'prompt-login': triggerAuthFlow('login-card'); break;
                    case 'prompt-register': triggerAuthFlow('register-card'); break;

                    // Explore/Top AI Filters
                    case 'back-to-explore': exploreFilter = { type: null, value: null }; renderView(); break;
                    case 'set-explore-filter': 
                        exploreFilter.type = actionTarget.dataset.filterType;
                        exploreFilter.value = actionTarget.dataset.filterValue;
                        renderView();
                        break;
                    case 'set-ranking-filter':
                        rankingFilter = actionTarget.dataset.filter;
                        renderView(); // Re-render to apply ranking filter
                        break;
                    case 'set-favorite-filter':
                        activeFilter = actionTarget.dataset.filter;
                        renderView(); // Re-render to apply favorite filter
                        break;

                    // Modals (Detail, Settings, Add App, Replace Featured)
                    case 'close-modal': closeModal(); break;
                    case 'toggle-favorite': toggleFavorite(actionTarget.dataset.id); break;
                    case 'open-detail-modal': // For recommendation box in detail modal
                         window.openDetailModal(actionTarget.dataset.id);
                         break;
                    case 'open-add-app-modal': // This action is now triggered by the "Add Custom App" button
                         // We still need the privilege check here as a safeguard
                         // Check privileged status loaded from Firestore
                         if (currentUser.uid && currentUser.isPrivileged) {
                             openAddAppModal();
                         } else if (currentUser.uid) {
                             // Maybe show a message that they need to unlock privileged mode?
                             showToast("Click the 'K' button 5 times to unlock this feature!");
                         } else {
                             triggerAuthFlow(); // Prompt login if not logged in
                         }
                         break;
                    case 'toggle-user-featured': // Triggered by pencil on user featured apps in Library
                         // Check privileged status loaded from Firestore
                         if (currentUser.uid && currentUser.isPrivileged) {
                             toggleUserFeatured(actionTarget.dataset.id);
                         } else {
                             showToast("You need privileged access for this action.");
                         }
                         break;
                    case 'replace-featured-static': // Triggered by pencil on static featured apps in Top AI
                         // Check privileged status loaded from Firestore
                         if (currentUser.uid && currentUser.isPrivileged) {
                             openReplaceFeaturedModal(actionTarget.dataset.id);
                         } else if (currentUser.uid) {
                             showToast("Click the 'K' button 5 times to unlock this feature!");
                         } else {
                             triggerAuthFlow();
                         }
                         break;
                    case 'select-user-tool-for-featured': // Triggered by clicking a user app in the replace modal
                         // Check privileged status loaded from Firestore
                         if (currentUser.uid && currentUser.isPrivileged) {
                             replaceFeaturedStatic(actionTarget.dataset.staticId, actionTarget.dataset.userId);
                         } else {
                             showToast("You need privileged access for this action.");
                         }
                         break;
                    case 'remove-featured-replacement': // Triggered by pencil on user-replaced featured apps in Top AI
                         // Check privileged status loaded from Firestore
                         if (currentUser.uid && currentUser.isPrivileged) {
                             removeFeaturedReplacement(actionTarget.dataset.id);
                         } else {
                             showToast("You need privileged access for this action.");
                         }
                         break;
                    case 'remove-user-tool': // Triggered by pencil on user apps in the main Library list
                         // Check privileged status loaded from Firestore
                         if (currentUser.uid && currentUser.isPrivileged) {
                             removeUserTool(actionTarget.dataset.id);
                         } else {
                             showToast("You need privileged access for this action.");
                         }
                         break;
                                        case 'add-ai-suggestion': // Triggered by add AI suggestion button
                        console.log('add-ai-suggestion action triggered');
                        if (currentUser.uid) {
                            console.log('User logged in, calling addAiSuggestion');
                            window.addAiSuggestion();
                        } else {
                            console.log('No user logged in, triggering auth flow');
                            triggerAuthFlow();
                        }
                        break;
                    case 'remove-ai-suggestion': // Triggered by remove AI suggestion button
                         if (currentUser.uid) {
                             removeAiSuggestion(actionTarget.dataset.id);
                         } else {
                             triggerAuthFlow();
                         }
                         break;
                    case 'search-users': // Triggered by search users button
                         if (currentUser.uid) {
                             searchUsers();
                         } else {
                             triggerAuthFlow();
                         }
                         break;
                    case 'view-user-suggestions': // Triggered by view suggestions button
                         if (currentUser.uid) {
                             viewUserSuggestions(actionTarget.dataset.uid, actionTarget.dataset.nickname);
                         } else {
                             triggerAuthFlow();
                         }
                         break;
                    case 'start-user-chat': // Triggered by start chat button
                         if (currentUser.uid) {
                             startUserChat(actionTarget.dataset.uid, actionTarget.dataset.nickname);
                         } else {
                             triggerAuthFlow();
                         }
                         break;


                    // Auth Overlay actions are handled by attachAuthListeners on the overlay itself
                    case 'close-auth': // Handled by attachAuthListeners
                    case 'show-login': // Handled by attachAuthListeners
                    case 'show-register': // Handled by attachAuthListeners
                    case 'show-forgot': // Handled by attachAuthListeners
                         // Let the specific auth overlay listener handle these
                         return; 
                    case 'profile-avatar-click':
                        if (!currentUser.uid) {
                            triggerAuthFlow('register-card');
                        } else {
                            toggleUserProfileDropdown();
                        }
                        break;
                    case 'open-settings':
                        closeUserProfileDropdown();
                        window.openSettingsModal();
                        break;
                    case 'change-nickname':
                        closeUserProfileDropdown();
                        openChangeNicknameModal();
                        break;
                    case 'change-password':
                        closeUserProfileDropdown();
                        openChangePasswordModal();
                        break;
                    case 'logout':
                        closeUserProfileDropdown();
                        signOut(auth).then(() => {
                            showToast("Logout effettuato con successo!");
                        }).catch((error) => {
                            console.error("Logout error:", error);
                            showToast("Errore durante il logout");
                        });
                        break;
                }
                // Prevent default for any element with data-action
                e.preventDefault(); 
                return; // Stop processing after handling a data-action
            }

            // 4. Handle clicks on tool/ranking cards (excluding favorite icon and edit icon which have data-actions)
            const toolCard = target.closest('.tool-card-grid, .tool-card-list, .ranking-item');
            if (toolCard && !target.closest('.favorite-icon') && !target.closest('.edit-icon')) { 
                 window.openDetailModal(toolCard.dataset.id); 
                 return; 
            }

            // 5. Handle clicks outside side menu/modals to close them
            if (target.id === 'side-menu-overlay') { toggleSideMenu(false); return; } 
            if (target.matches('.modal-overlay')) { closeModal(); return; }
            
            // 6. Close user profile dropdown when clicking outside
            closeUserProfileDropdown(); 

            // If none of the above were clicked, let the default behavior happen
        });

        // --- SEARCH INPUT LISTENER ---
        el.mainContent.addEventListener('input', e => {
            if (e.target.id === 'search-input') {
                const searchTerm = e.target.value.toLowerCase();
                const contentArea = document.getElementById('content-area');
                if (!contentArea) return;

                const allTools = getAllToolsForCurrentUser(); // Search across all tools
                const t = translations[currentLanguage];

                const toolsToShow = searchTerm.length > 1 ? allTools.filter(tool => 
                    tool.name.toLowerCase().includes(searchTerm) || 
                    (typeof tool.description === 'string' ? tool.description.toLowerCase().includes(searchTerm) : (typeof tool.description === 'object' ? (tool.description[currentLanguage] || tool.description['en'] || '').toLowerCase().includes(searchTerm) : false)) // Handle potential object descriptions
                ) : [];

                if (searchTerm.length > 1) {
                    // Pass context 'explore' to createListCard for search results
                    contentArea.innerHTML = toolsToShow.length > 0 ? `<div class="list-container">${toolsToShow.map(tool => createListCard(tool, 'explore')).join('')}</div>` : `<div id="empty-state">${t.noResultsFor} "${searchTerm}"</div>`;
                } else {
                    // If search term is cleared, show default explore view
                    contentArea.innerHTML = `<div class="section-title" data-translate="browseAll">${t.browseAll}</div><div class="category-grid">${categories.map(c => createCategoryCard(c)).join('')}</div><div class="section-title" style="margin-top: 30px;" data-translate="browseByOrigin">${t.browseByOrigin}</div><div class="category-grid">${countries.map(c => createCountryCard(c)).join('')}</div>`;
                }
                applyTranslations(currentLanguage); // Apply translations to search results/empty state
            }
        });

        // Add event listener for user search input
        el.mainContent.addEventListener('input', e => {
            if (e.target.id === 'user-search-input') {
                const searchTerm = e.target.value.trim();
                const searchResults = document.getElementById('user-search-results');
                if (!searchResults) return;

                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                if (searchTerm.length > 1) {
                    // Debounce search to avoid too many Firebase calls
                    searchTimeout = setTimeout(() => {
                        searchUsersByTerm(searchTerm);
                    }, 300);
                } else {
                    searchResults.innerHTML = '';
                }
            }
        });
        
        // --- FIREBASE AUTH STATE CHANGE LISTENER ---
        onAuthStateChanged(auth, user => {
            if (user) {
                console.log("User logged in:", user.uid);
                // Initialize currentUser with basic info from Firebase
                currentUser = { uid: user.uid, name: user.email, nickname: user.email.split('@')[0], favorites: [], userTools: [], userFeaturedTools: [], userFeaturedReplacements: {}, isPrivileged: false, aiSuggestions: [] }; 
                // Fetch all user data (favorites, userTools, userFeaturedTools, userFeaturedReplacements, isPrivileged, nickname, aiSuggestions) from Firestore
                const userDocRef = doc(db, "users", user.uid);
                 getDoc(userDocRef).then(userDocSnap => {
                     if (userDocSnap.exists()) {
                         const data = userDocSnap.data();
                         currentUser.favorites = data.favorites || [];
                         currentUser.userTools = data.userTools || [];
                         currentUser.userFeaturedTools = data.userFeaturedTools || [];
                         currentUser.userFeaturedReplacements = data.userFeaturedReplacements || {}; // Fetch replacements
                         currentUser.isPrivileged = data.isPrivileged || false; // Load privileged status
                         currentUser.nickname = data.nickname || user.email.split('@')[0]; // Load nickname
                         currentUser.aiSuggestions = data.aiSuggestions || []; // Load AI suggestions
                     } else {
                         // Create user doc if it doesn't exist with initial empty arrays and non-privileged status
                         const initialUserData = { 
                             email: user.email,
                             nickname: user.email.split('@')[0], // Use email prefix as default nickname
                             favorites: [],
                             userTools: [],
                             userFeaturedTools: [],
                             userFeaturedReplacements: {}, // Initialize replacements
                             isPrivileged: false, // Default to non-privileged
                             aiSuggestions: [] // Initialize AI suggestions
                         };
                         setDoc(userDocRef, initialUserData).catch(e => console.error("Error creating user doc:", e));
                         // currentUser is already initialized with empty arrays above
                         currentUser.isPrivileged = false; // Ensure local state reflects default
                     }
                 }).catch(e => console.error("Error fetching user data:", e))
                 .finally(() => {
                     // Proceed with app initialization after attempting to load user data
                     loadConversations();
                     el.authOverlay.classList.add('hidden');
                     el.authOverlay.addEventListener('transitionend', () => {
                          el.authOverlay.style.display = 'none';
                          el.authOverlay.innerHTML = ''; // Clear content after transition
                     }, { once: true });
                     el.appContainer.style.display = 'flex';
                     renderView(); // Render the app view
                 });

            } else {
                console.log("User logged out or is guest.");
                initializeAppForGuest(); // Guest mode doesn't load/save user data
            }
        });
        
    });
    </script>
</body>
</html>
